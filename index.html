<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="supabase-config" content="secured">
  <title>Garage HR - Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary:#8b0000;   /* rouge fonc√© */
      --secondary: #333333; /* gris pur */
      --accent: #e74c3c;
      --light: #ffffff;
      --muted: #f5f5f5;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #c0392b;
      --glass: rgba(255,255,255,0.06);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:var(--muted);color:var(--secondary);line-height:1.4}
    .container{display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:250px;
      background:var(--primary);
      color:var(--light);
      position:fixed;left:0;top:0;bottom:0;padding:18px 12px;
      display:flex;flex-direction:column;gap:6px;
      z-index:1000;
      transition:transform 0.3s ease;
    }
    .logo{font-weight:700;font-size:1.1rem;text-align:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .menu-item{
      display:flex;gap:10px;align-items:center;padding:12px;border-radius:8px;cursor:pointer;color:var(--light);
      transition:background .18s, transform .08s;
    }
    .menu-item i{font-size:18px}
    .menu-item span{font-weight:600}
    .menu-item:hover{background:rgba(255,255,255,0.06);transform:translateY(-1px)}
    .menu-item.active{background:var(--secondary);color:var(--light)}

    /* Main content */
    .main-content{
      margin-left:250px;flex:1;padding:20px 26px;
      transition:margin-left 0.3s ease;
    }
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;border-bottom:1px solid #eee;padding-bottom:12px;flex-wrap:wrap}
    .header h1{font-size:1.25rem;color:var(--secondary)}
    .header-controls{display:flex;gap:10px;align-items:center}
    .header-controls input{padding:10px;border-radius:6px;border:1px solid #ddd;width:260px}
    .mobile-menu-btn{display:none;font-size:1.5rem;cursor:pointer}

    /* Stats cards am√©lior√©es */
    .stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin:18px 0}
    .stat-card{background:var(--light);border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06);text-align:center;position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--primary)}
    .stat-card.stock-card::before{background:var(--success)}
    .stat-card.entry-card::before{background:var(--warning)}
    .stat-card.exit-card::before{background:var(--danger)}
    .stat-card h3{color:var(--primary);margin-bottom:10px;font-size:0.9rem}
    .stat-card .number{font-size:28px;color:var(--secondary);font-weight:700}
    .stat-card .trend{font-size:0.8rem;margin-top:5px}
    .trend.up{color:var(--success)}
    .trend.down{color:var(--danger)}

    /* Form sections */
    .form-section{background:var(--light);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:18px}
    .form-section h2{margin-bottom:12px;color:var(--primary);padding-bottom:8px;border-bottom:1px solid #f2f2f2}
    .form-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px}
    .form-group{flex:1 1 260px;min-width:180px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--secondary)}
    .form-group input,.form-group select,.form-group textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;font-size:14px;background:#fff;color:var(--secondary)
    }
    .form-group textarea{min-height:90px;resize:vertical}
    .select-hint{font-size:12px;color:#666;margin-top:6px}

    /* Galerie stock */
    .stock-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .vehicle-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid #e0e0e0;
    }

    .vehicle-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .vehicle-card-photo {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-bottom: 1px solid #eee;
    }

    .vehicle-card-info {
      padding: 15px;
    }

    .vehicle-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .vehicle-card-immat {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .vehicle-card-days {
      background: var(--warning);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .vehicle-card-days.old { background: var(--danger); }
    .vehicle-card-days.new { background: var(--success); }

    .vehicle-card-model {
      color: var(--secondary);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .vehicle-card-meta {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .vehicle-card-meta i { width: 16px; }

    .vehicle-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .vehicle-card-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      text-align: center;
      transition: all 0.2s;
      font-weight: 600;
    }

    .vehicle-card-btn:hover {
      transform: translateY(-2px);
    }

    .btn-exit { background: var(--danger); color: white; }
    .btn-details { background: var(--primary); color: white; }
    .btn-history { background: #3498db; color: white; }

    /* Delivery files */
    .delivery-files-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .delivery-file-item {
      text-align: center;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9f9;
    }
    .delivery-file-preview {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .delivery-file-name {
      font-size: 0.8rem;
      word-break: break-word;
    }
    .remove-delivery-file {
      color: #e74c3c;
      cursor: pointer;
      font-size: 0.8rem;
      margin-top: 5px;
    }

    /* Buttons */
    .btn{cursor:pointer;border-radius:8px;padding:10px 14px;font-weight:700;border:none;transition:all 0.2s}
    .btn-primary{background:var(--primary);color:var(--light)}
    .btn-primary:hover{background:var(--secondary)}
    .btn-sm{padding:6px 10px;font-size:0.85rem}
    .btn-edit{background:#3498db;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin-right:5px}
    .btn-delete{background:#e74c3c;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
    .btn-details{background:#27ae60;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
    .btn-edit:hover{background:#2980b9}
    .btn-delete:hover{background:#c0392b}
    .btn-details:hover{background:#219653}

    /* Tables */
    .data-table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      table-layout: fixed;
    }
    .data-table th,.data-table td{
      padding:12px 10px;
      border-bottom:1px solid #f0f0f0;
      text-align:left;
      vertical-align: top;
    }
    .data-table th{background:transparent;color:var(--secondary);font-weight:700}
    .data-table tr:hover{background:#fafafa}
    
    .data-table th:nth-child(1),
    .data-table td:nth-child(1) {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }

    /* Stats tables */
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .stats-table th, 
    .stats-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      text-align: left;
    }
    .stats-table th {
      background: #f8f9fa;
      color: var(--primary);
      font-weight: 700;
      border-bottom: 2px solid var(--primary);
    }
    .stats-table tr:hover {
      background: #fafafa;
    }
    .stats-table td {
      padding: 15px;
    }

    /* Status badges */
    .status-badge{padding:6px 10px;border-radius:20px;font-weight:700;font-size:13px;display:inline-block}
    .status-en-cours{background:#ffeaa7;color:#d35400}
    .status-termine{background:#d1f7c4;color:#27ae60}
    .status-en-attente{background:#f1f2f6;color:#636e72}

    /* Helpers */
    .form-actions{margin-top:10px;display:flex;gap:10px;align-items:center}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Notification */
    .notification{
      position:fixed;right:20px;top:20px;padding:12px 16px;border-radius:8px;color:#fff;background:var(--success);box-shadow:0 8px 24px rgba(0,0,0,0.12);transform:translateX(120%);transition:transform 260ms ease;z-index:9999
    }
    .notification.show{transform:translateX(0)}
    .notification.error{background:var(--danger)}
    .notification.warning{background:var(--warning)}

    /* Search section */
    .search-filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:15px}

    /* Flux section */
    .flux-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px}
    .flux-column{background:var(--light);border-radius:10px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    .flux-column h3{color:var(--primary);margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid #eee}
    .flux-item{background:#f9f9f9;border-radius:6px;padding:10px;margin-bottom:8px;border-left:4px solid var(--primary)}
    .flux-item.entree{border-left-color:var(--success)}
    .flux-item.sortie{border-left-color:var(--warning)}
    .flux-item-header{display:flex;justify-content:space-between;margin-bottom:5px}
    .flux-item-title{font-weight:600}
    .flux-item-details{font-size:0.85rem;color:#666}

    /* Photo preview */
    .photo-preview{width:120px;height:90px;border-radius:6px;object-fit:cover;border:2px dashed #ddd;display:block;margin-top:5px}

    /* Modals */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;justify-content:center;align-items:center}
    .modal-content{background:white;border-radius:10px;padding:20px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:10px}
    .modal-close{font-size:1.5rem;cursor:pointer;color:#999}
    .modal-close:hover{color:#333}

    /* Vehicle details modal */
    .vehicle-details-modal .modal-content {
      max-width: 800px;
    }
    .vehicle-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .vehicle-details-photo {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
    }
    .intervention-history {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px;
    }
    .intervention-item {
      border-left: 4px solid var(--primary);
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    /* Stock history */
    .stock-history-item {
      padding: 10px;
      border-left: 4px solid #3498db;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .stock-history-item.entry { border-left-color: var(--success); }
    .stock-history-item.exit { border-left-color: var(--danger); }

    /* Quick actions */
    .quick-actions{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
    .quick-action-btn{background:var(--light);border:1px solid #ddd;border-radius:6px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all 0.2s}
    .quick-action-btn:hover{background:#f0f0f0;transform:translateY(-2px)}

    /* Loading states */
    .loading{opacity:0.6;pointer-events:none}
    .spinner{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* View toggle */
    .view-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .view-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .view-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* RESPONSIVE */
    @media (max-width: 1200px){
      .main-content{padding:15px 20px}
      .stats-cards{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
    }

    @media (max-width: 992px){
      .sidebar{width:200px}
      .main-content{margin-left:200px;padding:15px}
      .form-section{padding:15px}
      .header-controls input{width:200px}
      .vehicle-details-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px){
      .mobile-menu-btn{display:block}
      .sidebar{transform:translateX(-100%);width:280px}
      .sidebar.open{transform:translateX(0)}
      .main-content{margin-left:0;padding:12px}
      .main-content.sidebar-open{margin-left:280px}
      
      .stats-cards{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:12px 0}
      .stat-card{padding:12px}
      .stat-card .number{font-size:24px}
      
      .header{flex-direction:column;align-items:flex-start;gap:10px}
      .header-controls{width:100%;flex-direction:column;gap:8px}
      .header-controls input{width:100%}
      .quick-actions{width:100%;justify-content:center}
      
      .stock-gallery {
        grid-template-columns: 1fr;
      }
      
      .form-group{min-width:100%}
      .form-section{padding:12px;margin-bottom:12px}
      .form-row{gap:12px;margin-bottom:10px}
      
      .data-table{font-size:0.85rem; table-layout: auto;}
      .data-table th,.data-table td{padding:8px 6px}
    }

    @media (max-width: 480px){
      .main-content{padding:10px}
      .stock-gallery {
        grid-template-columns: 1fr;
      }
      .vehicle-card-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
  
<body>
  <div id="notification" class="notification"></div>

  <!-- Modal pour modifier les interventions -->
  <div id="intervention-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Modifier l'intervention</h2>
        <span class="modal-close">&times;</span>
      </div>
      <form id="edit-intervention-form">
        <input type="hidden" id="edit-intervention-id">
        <div class="form-row">
          <div class="form-group">
            <label for="edit-vehicule-intervention">V√©hicule</label>
            <select id="edit-vehicule-intervention" required>
              <option value="">S√©lectionner un v√©hicule</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-date-intervention">Date</label>
            <input type="date" id="edit-date-intervention" required />
          </div>

          <div class="form-group">
            <label for="edit-type-intervention">Type d'intervention</label>
            <input list="edit-types-intervention" id="edit-type-intervention" placeholder="Choisissez ou √©crivez un type" required />
            <datalist id="edit-types-intervention">
              <option value="Vidange">
              <option value="R√©paration">
              <option value="Contr√¥le technique">
              <option value="Carrosserie">
              <option value="√âlectricit√©">
            </datalist>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-mecaniciens">M√©caniciens (s√©lection multiple)</label>
            <select id="edit-mecaniciens" multiple>
              <option value="1"> SYLVIN</option>
              <option value="2"> HUSSEIN</option>
              <option value="3">YOUSSOUF</option>
              <option value="4"> ISSIF</option>
              <option value="5">BABA</option>
              <option value="6"> SAID</option>
              <option value="7">ABDELATIF</option>
              <option value="8">WILLIAM</option>
              <option value="9"> HASSAN</option>
              <option value="10">MOHAMED</option>
              <option value="11"> AZIZ</option>
              <option value="12"> KEVIN</option>
              <option value="13">TOURE</option>
              <option value="14"> EBENEZER</option>
            </select>
            <div class="select-hint">Ctrl/Cmd + clic pour multi-s√©lection (ou appuyez longuement sur mobile)</div>
          </div>

          <div class="form-group">
            <label for="edit-pieces">Pi√®ces utilis√©es</label>
            <textarea id="edit-pieces" placeholder="Liste des pi√®ces utilis√©es..."></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-bons-livraison">Bons de livraison (photos)</label>
            <input type="file" id="edit-bons-livraison" accept="image/*" multiple />
            <div class="select-hint">Vous pouvez s√©lectionner plusieurs photos</div>
            <div id="edit-delivery-files-preview" class="delivery-files-container"></div>
          </div>

          <div class="form-group">
            <label for="edit-statut">Statut</label>
            <select id="edit-statut" required>
              <option value="en-attente">En attente</option>
              <option value="en-cours">En cours</option>
              <option value="termine">Termin√©</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-observations">Observations</label>
            <textarea id="edit-observations" placeholder="Observations..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <span class="btn-text">Modifier l'intervention</span>
            <div class="spinner" style="display:none"></div>
          </button>
          <button type="button" id="cancel-edit" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal pour d√©tails v√©hicule -->
  <div id="vehicle-details-modal" class="modal vehicle-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>D√©tails du V√©hicule</h2>
        <span class="modal-close">&times;</span>
      </div>
      <div id="vehicle-details-content">
        <!-- Contenu charg√© dynamiquement -->
      </div>
    </div>
  </div>

  <!-- Modal gestion stock -->
  <div id="stock-management-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Gestion du Stock</h2>
        <span class="modal-close">&times;</span>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="stock-action">Action</label>
          <select id="stock-action">
            <option value="add">Ajouter au stock</option>
            <option value="remove">Retirer du stock</option>
          </select>
        </div>
        <div class="form-group">
          <label for="stock-vehicle">V√©hicule</label>
          <select id="stock-vehicle">
            <option value="">S√©lectionner un v√©hicule</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="stock-reason">Raison</label>
          <select id="stock-reason">
            <option value="reparation">R√©paration</option>
            <option value="entretien">Entretien</option>
            <option value="stockage">Stockage</option>
            <option value="vente">Pr√©paration vente</option>
          </select>
        </div>
        <div class="form-group">
          <label for="stock-notes">Notes</label>
          <textarea id="stock-notes" placeholder="Notes suppl√©mentaires..."></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" onclick="confirmStockAction()">Confirmer</button>
        <button class="btn" onclick="closeModal('stock-management-modal')">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Modal historique stock -->
  <div id="stock-history-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Historique du Stock</h2>
        <span class="modal-close">&times;</span>
      </div>
      <div id="stock-history-content">
        <!-- Contenu charg√© dynamiquement -->
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigation principale">
      <div class="logo"><span> HR MOTORS</span></div>

      <nav class="nav">
        <div class="menu-item active" data-tab="dashboard"><i class="fas fa-chart-bar"></i><span>Tableau de bord</span></div>
        <div class="menu-item" data-tab="stock"><i class="fas fa-warehouse"></i><span>Stock Garage</span></div>
        <div class="menu-item" data-tab="vehicles"><i class="fas fa-car"></i><span>V√©hicules</span></div>
        <div class="menu-item" data-tab="interventions"><i class="fas fa-tools"></i><span>Interventions</span></div>
        <div class="menu-item" data-tab="flux"><i class="fas fa-exchange-alt"></i><span>Flux v√©hicules</span></div>
        <div class="menu-item" data-tab="search"><i class="fas fa-search"></i><span>Recherche</span></div>
        <div class="menu-item" data-tab="stats"><i class="fas fa-chart-line"></i><span>Statistiques</span></div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <header class="header">
        <div class="mobile-menu-btn">
          <i class="fas fa-bars"></i>
        </div>
        <h1>Tableau de Bord - Garage HR</h1>
        <div class="header-controls">
          <input type="text" id="global-search" placeholder="Rechercher..." />
          <div class="quick-actions">
            <div class="quick-action-btn" id="quick-add-vehicle">
              <i class="fas fa-plus"></i> V√©hicule
            </div>
            <div class="quick-action-btn" id="quick-add-intervention">
              <i class="fas fa-wrench"></i> Intervention
            </div>
            <div class="quick-action-btn" id="quick-manage-stock">
              <i class="fas fa-warehouse"></i> Stock
            </div>
          </div>
        </div>
      </header>

      <!-- Dashboard -->
      <section id="dashboard-tab" class="tab-content active">
        <div class="stats-cards">
          <div class="stat-card stock-card">
            <h3>V√©hicules en stock</h3>
            <div class="number" id="current-stock-count">0</div>
            <div class="trend" id="stock-trend"></div>
            <button class="btn btn-sm" onclick="switchTab('stock')" style="margin-top:10px;">Voir le stock</button>
          </div>
          <div class="stat-card entry-card">
            <h3>Entr√©es aujourd'hui</h3>
            <div class="number" id="today-entries">0</div>
          </div>
          <div class="stat-card exit-card">
            <h3>Sorties aujourd'hui</h3>
            <div class="number" id="today-exits">0</div>
          </div>
          <div class="stat-card">
            <h3>Anciennet√© moyenne</h3>
            <div class="number" id="average-stay">0j</div>
          </div>
        </div>

        <div class="form-section">
          <h2>V√©hicules r√©cemment ajout√©s au stock</h2>
          <div id="recent-stock-preview" class="stock-gallery">
            <!-- Pr√©visualisation des v√©hicules r√©cents -->
          </div>
        </div>

        <div class="form-section">
          <h2>Journal complet des activit√©s</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="journal-date">Filtrer par date</label>
              <input type="date" id="journal-date" />
            </div>
            <div class="form-group">
              <label for="journal-type">Filtrer par type</label>
              <select id="journal-type">
                <option value="">Tous les types</option>
                <option value="Vidange">Vidange</option>
                <option value="R√©paration">R√©paration</option>
                <option value="Contr√¥le technique">Contr√¥le technique</option>
                <option value="Carrosserie">Carrosserie</option>
                <option value="√âlectricit√©">√âlectricit√©</option>
              </select>
            </div>
            <div class="form-group">
              <label for="journal-statut">Filtrer par statut</label>
              <select id="journal-statut">
                <option value="">Tous les statuts</option>
                <option value="en-attente">En attente</option>
                <option value="en-cours">En cours</option>
                <option value="termine">Termin√©</option>
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button id="journal-filter" class="btn btn-primary">Filtrer</button>
            <button id="journal-reset" class="btn">R√©initialiser</button>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>V√©hicule</th>
                <th>Type intervention</th>
                <th>M√©caniciens</th>
                <th>Photos BL</th>
                <th>Statut</th>
                <th>Observations</th>
              </tr>
            </thead>
            <tbody id="journal-complet"></tbody>
          </table>
        </div>
      </section>

      <!-- Stock Garage -->
      <section id="stock-tab" class="tab-content">
        <div class="form-section">
          <h2>Gestion du Stock Actuel</h2>
          
          <div class="quick-actions">
            <div class="quick-action-btn" onclick="openStockManagement()">
              <i class="fas fa-plus"></i> G√©rer le stock
            </div>
            <div class="quick-action-btn" onclick="exportStockReport()">
              <i class="fas fa-file-export"></i> Exporter rapport
            </div>
            <div class="quick-action-btn" onclick="showStockHistory()">
              <i class="fas fa-history"></i> Historique complet
            </div>
          </div>

          <div class="search-filters">
            <input type="text" id="stock-search" placeholder="Rechercher immatriculation..." />
            <select id="stock-status-filter">
              <option value="">Tous les statuts</option>
              <option value="en-attente">En attente</option>
              <option value="en-cours">En r√©paration</option>
              <option value="termine">Pr√™t √† sortir</option>
            </select>
            <input type="number" id="stock-days-filter" placeholder="√Çge min (jours)" />
            <button class="btn btn-primary" onclick="filterStock()">Filtrer</button>
            <button class="btn" onclick="resetStockFilter()">R√©initialiser</button>
          </div>

          <div class="view-toggle">
            <button class="view-btn active" onclick="setStockView('gallery')">
              <i class="fas fa-th"></i> Galerie
            </button>
            <button class="view-btn" onclick="setStockView('table')">
              <i class="fas fa-table"></i> Tableau
            </button>
          </div>

          <!-- Vue Galerie -->
          <div id="stock-gallery-view">
            <div class="stock-gallery" id="stock-gallery">
              <!-- Cartes v√©hicules charg√©es dynamiquement -->
            </div>
          </div>

          <!-- Vue Tableau -->
          <div id="stock-table-view" style="display: none;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Photo</th>
                  <th>Immatriculation</th>
                  <th>Mod√®le</th>
                  <th>Date entr√©e</th>
                  <th>Jours pr√©sents</th>
                  <th>Derni√®re intervention</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="stock-table-body"></tbody>
            </table>
          </div>

          <div id="stock-empty" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-warehouse" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
            <h3 style="color: #666;">Aucun v√©hicule en stock</h3>
            <p style="color: #888;">Ajoutez des v√©hicules au stock pour commencer</p>
            <button class="btn btn-primary" onclick="openStockManagement()" style="margin-top: 15px;">
              <i class="fas fa-plus"></i> Ajouter au stock
            </button>
          </div>
        </div>
      </section>

      <!-- Vehicles -->
      <section id="vehicles-tab" class="tab-content">
        <div class="form-section">
          <h2>Nouveau V√©hicule</h2>
          <form id="vehicle-form">
            <div class="form-row">
              <div class="form-group">
                <label for="immatriculation">Immatriculation</label>
                <input type="text" id="immatriculation" required />
                <div class="select-hint" id="immatriculation-hint">Tous les formats accept√©s</div>
              </div>
              <div class="form-group">
                <label for="modele">Mod√®le</label>
                <input type="text" id="modele" required />
              </div>
              <div class="form-group">
                <label for="couleur">Couleur</label>
                <input type="text" id="couleur" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="photo">Photo du v√©hicule</label>
                <input type="file" id="photo" accept="image/*" />
                <div class="select-hint">Taille max: 5MB - Formats: JPG, PNG, WebP</div>
                <img id="photo-preview" class="photo-preview" src="" alt="Aper√ßu de la photo" style="display:none" />
              </div>
              <div class="form-group">
                <label for="proprietaire">Propri√©taire</label>
                <input type="text" id="proprietaire" />
              </div>
              <div class="form-group">
                <label for="telephone">T√©l√©phone</label>
                <input type="tel" id="telephone" />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <span class="btn-text">Enregistrer le v√©hicule</span>
                <div class="spinner" style="display:none"></div>
              </button>
              <button type="button" id="cancel-edit-vehicle" class="btn" style="display:none">Annuler</button>
            </div>
          </form>
        </div>

        <div class="form-section">
          <h2>Liste des V√©hicules</h2>
          <table class="data-table">
            <thead>
              <tr><th>Photo</th><th>Immatriculation</th><th>Mod√®le</th><th>Couleur</th><th>Propri√©taire</th><th>Actions</th></tr>
            </thead>
            <tbody id="vehicles-list"></tbody>
          </table>
        </div>
      </section>

      <!-- Interventions -->
      <section id="interventions-tab" class="tab-content">
        <div class="form-section">
          <h2>Nouvelle Intervention</h2>
          <form id="intervention-form">
            <div class="form-row">
              <div class="form-group">
                <label for="vehicule-intervention">V√©hicule</label>
                <select id="vehicule-intervention" required>
                  <option value="">S√©lectionner un v√©hicule</option>
                </select>
              </div>

              <div class="form-group">
                <label for="date-intervention">Date</label>
                <input type="date" id="date-intervention" required />
              </div>

              <div class="form-group">
                <label for="type-intervention">Type d'intervention (choisir ou √©crire)</label>
                <input list="types-intervention" id="type-intervention" placeholder="Choisissez ou √©crivez un type" required />
                <datalist id="types-intervention">
                  <option value="Vidange">
                  <option value="R√©paration">
                  <option value="Contr√¥le technique">
                  <option value="Carrosserie">
                  <option value="√âlectricit√©">
                </datalist>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="mecaniciens">M√©caniciens (s√©lection multiple)</label>
                <select id="mecaniciens" multiple>
                  <option value="1"> SYLVIN</option>
                  <option value="2"> HUSSEIN</option>
                  <option value="3"> YOUSSOUF</option>
                  <option value="4"> ISSIF</option>
                  <option value="5"> DRAMANE</option>
                  <option value="6"> SAIDOU</option>
                  <option value="7">ABDELATIF</option>
                  <option value="8"> WILLIAM</option>
                  <option value="9"> HASSAN</option>
                  <option value="10">MOHAMED</option>
                  <option value="11">AZIZ</option>
                  <option value="12">KEVIN</option>
                  <option value="13">TOURE </option>
                  <option value="14"> EBENEZER</option>
                </select>
                <div class="select-hint">Ctrl/Cmd + clic pour multi-s√©lection (ou appuyez longuement sur mobile)</div>
              </div>

              <div class="form-group">
                <label for="pieces">Pi√®ces utilis√©es</label>
                <textarea id="pieces" placeholder="Liste des pi√®ces utilis√©es..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="bons-livraison">Bons de livraison (photos)</label>
                <input type="file" id="bons-livraison" accept="image/*" multiple />
                <div class="select-hint">Vous pouvez s√©lectionner plusieurs photos - Taille max: 5MB par fichier</div>
                <div id="delivery-files-preview" class="delivery-files-container"></div>
              </div>

              <div class="form-group">
                <label for="statut">Statut</label>
                <select id="statut" required>
                  <option value="en-attente">En attente</option>
                  <option value="en-cours">En cours</option>
                  <option value="termine">Termin√©</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="observations">Observations</label>
                <textarea id="observations" placeholder="Observations..."></textarea>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <span class="btn-text">Enregistrer l'intervention</span>
                <div class="spinner" style="display:none"></div>
              </button>
            </div>
          </form>
        </div>

        <div class="form-section">
          <h2>Interventions R√©centes</h2>
          <table class="data-table">
            <thead>
              <tr><th>V√©hicule</th><th>Date</th><th>Type</th><th>M√©caniciens</th><th>Bons livraison</th><th>Statut</th><th>Actions</th></tr>
            </thead>
            <tbody id="interventions-list"></tbody>
          </table>
        </div>
      </section>

      <!-- Flux v√©hicules -->
      <section id="flux-tab" class="tab-content">
        <div class="form-section">
          <h2>Flux des v√©hicules - Aujourd'hui</h2>
          <div class="flux-container">
            <div class="flux-column">
              <h3>V√©hicules entr√©s aujourd'hui</h3>
              <div id="flux-entrees"></div>
            </div>
            <div class="flux-column">
              <h3>V√©hicules en cours de r√©paration</h3>
              <div id="flux-en-cours"></div>
            </div>
            <div class="flux-column">
              <h3>V√©hicules sortis aujourd'hui</h3>
              <div id="flux-sorties"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Search -->
      <section id="search-tab" class="tab-content">
        <div class="form-section">
          <h2>Recherche avanc√©e</h2>
          <div class="search-filters">
            <input type="text" id="search-immatriculation" placeholder="Immatriculation" />
            <input type="text" id="search-modele" placeholder="Mod√®le" />
            <input type="text" id="search-couleur" placeholder="Couleur" />
            <input type="date" id="search-date" />
            <select id="search-type">
              <option value="">Type d'intervention</option>
              <option value="Vidange">Vidange</option>
              <option value="R√©paration">R√©paration</option>
              <option value="Contr√¥le technique">Contr√¥le technique</option>
              <option value="Carrosserie">Carrosserie</option>
              <option value="√âlectricit√©">√âlectricit√©</option>
            </select>
            <select id="search-statut">
              <option value="">Statut</option>
              <option value="en-attente">En attente</option>
              <option value="en-cours">En cours</option>
              <option value="termine">Termin√©</option>
            </select>
          </div>
          <div class="form-actions">
            <button id="search-button" class="btn btn-primary">Rechercher</button>
            <button id="reset-search" class="btn">R√©initialiser</button>
          </div>
        </div>

        <div class="form-section">
          <h2>R√©sultats de la Recherche</h2>
          <div id="search-results-count"></div>
          <table class="data-table">
            <thead>
              <tr><th>Photo</th><th>Immatriculation</th><th>Mod√®le</th><th>Couleur</th><th>Propri√©taire</th><th>Derni√®re intervention</th><th>Statut</th><th>Actions</th></tr>
            </thead>
            <tbody id="search-results"></tbody>
          </table>
        </div>
      </section>

      <!-- Stats -->
      <section id="stats-tab" class="tab-content">
        <div class="form-section">
          <h2>Statistiques des interventions</h2>
          <div class="stats-cards">
            <div class="stat-card">
              <h3>Total interventions</h3>
              <div class="number" id="total-interventions">0</div>
            </div>
            <div class="stat-card">
              <h3>Vidanges ce mois</h3>
              <div class="number" id="month-oil-changes">0</div>
            </div>
            <div class="stat-card">
              <h3>Taux de completion</h3>
              <div class="number" id="completion-rate">0%</div>
            </div>
            <div class="stat-card">
              <h3>V√©hicules en attente</h3>
              <div class="number" id="vehicles-waiting">0</div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>R√©parations par m√©canicien</h2>
          <table class="stats-table">
            <thead><tr><th>M√©canicien</th><th>Interventions</th><th>En cours</th><th>Termin√©es</th><th>Taux de r√©ussite</th></tr></thead>
            <tbody id="mechanics-stats"></tbody>
          </table>
        </div>

        <div class="form-section">
          <h2>Types d'interventions les plus courants</h2>
          <table class="stats-table">
            <thead><tr><th>Type d'intervention</th><th>Nombre</th><th>Pourcentage</th><th>Visualisation</th></tr></thead>
            <tbody id="intervention-types-stats"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
<script>
  // ==================== CONFIGURATION SUPABASE ====================
  const getSupabaseConfig = () => {
    const supabaseUrl = window.VITE_SUPABASE_URL || 'https://xexmwdaeoxizvqecrmlo.supabase.co';
    const supabaseKey = window.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhleG13ZGFlb3hpenZxZWNybWxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTg5OTAsImV4cCI6MjA3NDI3NDk5MH0.nrMn4X0KFJISudffGDJZ0SM7XxKD2wOG2xOUMNsnWQo';
    
    if (!supabaseUrl || !supabaseKey) {
      console.error('Configuration Supabase manquante');
      showNotification("Erreur de configuration de l'application", "error");
      return null;
    }
    
    return { supabaseUrl, supabaseKey };
  };

  const config = getSupabaseConfig();
  if (!config) {
    throw new Error('Configuration Supabase non disponible');
  }

  const supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);

  // ==================== STATE GLOBAL ====================
  let vehicles = [];
  let interventions = [];
  let currentEditingInterventionId = null;
  let deliveryFiles = [];
  let garageStock = [];
  let stockHistory = [];
  let currentStockView = 'gallery';

  // ==================== FONCTION SWITCHTAB GARANTIE ====================
  function switchTab(tabName){
    console.log('üîß Navigation vers:', tabName);
    
    // Masquer tous les onglets
    document.querySelectorAll('.tab-content').forEach(t => {
        t.classList.remove('active');
    });
    
    // Afficher l'onglet s√©lectionn√©
    const targetTab = document.getElementById(tabName + '-tab');
    if(targetTab) {
        targetTab.classList.add('active');
    } else {
        console.error('‚ùå Onglet non trouv√©:', tabName + '-tab');
        // Fallback vers le dashboard
        const dashboardTab = document.getElementById('dashboard-tab');
        if (dashboardTab) {
            dashboardTab.classList.add('active');
        }
    }
    
    // Mettre √† jour le titre de la page
    updatePageTitle(tabName);
  }

  function updatePageTitle(tabName) {
    const titles = {
        'dashboard': 'Tableau de Bord',
        'stock': 'Stock Garage', 
        'vehicles': 'V√©hicules',
        'interventions': 'Interventions',
        'flux': 'Flux V√©hicules',
        'search': 'Recherche',
        'stats': 'Statistiques'
    };
    
    const title = titles[tabName] || 'Garage HR';
    document.querySelector('.header h1').textContent = title + ' - Garage HR';
  }

  // ==================== SYST√àME DE STOCK AM√âLIOR√â ====================

  async function loadStockData() {
    try {
      // Charger le stock actuel avec les donn√©es des v√©hicules
      const { data: stockData, error } = await supabase
        .from('garage_stock')
        .select(`
          *,
          vehicles (
            immatriculation,
            modele,
            couleur,
            photo,
            proprietaire,
            telephone
          )
        `)
        .is('exit_date', null)
        .order('entry_date', { ascending: false });

      if (error) throw error;

      // Charger l'historique du stock
      const { data: historyData, error: historyError } = await supabase
        .from('garage_stock')
        .select(`
          *,
          vehicles (
            immatriculation,
            modele
          )
        `)
        .order('entry_date', { ascending: false })
        .limit(100);

      if (!historyError) {
        stockHistory = historyData || [];
      }

      garageStock = stockData || [];
      displayStock();
      updateStockStats();
      
    } catch (error) {
      console.error('Erreur chargement stock:', error);
      // Fallback vers le stock local
      loadLocalStock();
    }
  }

  function displayStock() {
    const filteredStock = filterStockItems(garageStock);
    
    if (filteredStock.length === 0) {
      document.getElementById('stock-gallery').innerHTML = '';
      document.getElementById('stock-table-body').innerHTML = '';
      document.getElementById('stock-empty').style.display = 'block';
      return;
    }

    document.getElementById('stock-empty').style.display = 'none';
    
    if (currentStockView === 'gallery') {
      displayStockGallery(filteredStock);
    } else {
      displayStockTable(filteredStock);
    }
  }

  function displayStockGallery(stockItems) {
    const gallery = document.getElementById('stock-gallery');
    gallery.innerHTML = '';

    stockItems.forEach(item => {
      const vehicle = item.vehicles;
      if (!vehicle) return;

      const daysInStock = calculateDaysInStock(item.entry_date);
      const lastIntervention = getLastIntervention(item.vehicle_id);
      const status = getVehicleStatus(item.vehicle_id);

      const card = document.createElement('div');
      card.className = 'vehicle-card';
      card.innerHTML = `
        <img src="${vehicle.photo}" class="vehicle-card-photo" alt="${vehicle.immatriculation}" 
             onerror="this.src='https://via.placeholder.com/280x180?text=Vehicle'">
        <div class="vehicle-card-info">
          <div class="vehicle-card-header">
            <div class="vehicle-card-immat">${vehicle.immatriculation}</div>
            <div class="vehicle-card-days ${getDaysClass(daysInStock)}">${daysInStock}j</div>
          </div>
          <div class="vehicle-card-model">${vehicle.modele} - ${vehicle.couleur}</div>
          <div class="vehicle-card-meta">
            <i class="fas fa-calendar-alt"></i>Entr√© le: ${formatDate(item.entry_date)}
          </div>
          <div class="vehicle-card-meta">
            <i class="fas fa-user"></i>${vehicle.proprietaire || 'Propri√©taire non renseign√©'}
          </div>
          <div class="vehicle-card-meta">
            <i class="fas fa-tools"></i>Derni√®re: ${lastIntervention}
          </div>
          <div class="vehicle-card-meta">
            <i class="fas fa-info-circle"></i>Statut: <span class="status-badge status-${status}">${status}</span>
          </div>
          <div class="vehicle-card-actions">
            <button class="vehicle-card-btn btn-exit" onclick="removeFromStock('${item.id}')">
              <i class="fas fa-sign-out-alt"></i> Sortie
            </button>
            <button class="vehicle-card-btn btn-details" onclick="showVehicleDetails('${item.vehicle_id}')">
              <i class="fas fa-eye"></i> D√©tails
            </button>
            <button class="vehicle-card-btn btn-history" onclick="showVehicleStockHistory('${item.vehicle_id}')">
              <i class="fas fa-history"></i> Historique
            </button>
          </div>
        </div>
      `;
      gallery.appendChild(card);
    });
  }

  function displayStockTable(stockItems) {
    const tableBody = document.getElementById('stock-table-body');
    tableBody.innerHTML = '';

    stockItems.forEach(item => {
      const vehicle = item.vehicles;
      if (!vehicle) return;

      const daysInStock = calculateDaysInStock(item.entry_date);
      const lastIntervention = getLastIntervention(item.vehicle_id);
      const status = getVehicleStatus(item.vehicle_id);

      const row = document.createElement('tr');
      row.innerHTML = `
        <td><img src="${vehicle.photo}" class="vehicle-photo" alt="photo" onerror="this.src='https://via.placeholder.com/100x70?text=Vehicle'"></td>
        <td>${vehicle.immatriculation}</td>
        <td>${vehicle.modele}</td>
        <td>${formatDate(item.entry_date)}</td>
        <td>${daysInStock} jours</td>
        <td>${lastIntervention}</td>
        <td><span class="status-badge status-${status}">${status}</span></td>
        <td class="action-buttons">
          <button class="btn-edit" onclick="showVehicleDetails('${vehicle.id}')">D√©tails</button>
          <button class="btn-delete" onclick="removeFromStock('${item.id}')">Sortie</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function filterStockItems(stockItems) {
    const searchTerm = document.getElementById('stock-search').value.toLowerCase();
    const statusFilter = document.getElementById('stock-status-filter').value;
    const daysFilter = parseInt(document.getElementById('stock-days-filter').value) || 0;

    return stockItems.filter(item => {
      const vehicle = item.vehicles;
      if (!vehicle) return false;

      // Filtre recherche
      if (searchTerm && !vehicle.immatriculation.toLowerCase().includes(searchTerm)) {
        return false;
      }

      // Filtre statut
      if (statusFilter && getVehicleStatus(item.vehicle_id) !== statusFilter) {
        return false;
      }

      // Filtre anciennet√©
      if (daysFilter > 0 && calculateDaysInStock(item.entry_date) < daysFilter) {
        return false;
      }

      return true;
    });
  }

  function filterStock() {
    displayStock();
  }

  function resetStockFilter() {
    document.getElementById('stock-search').value = '';
    document.getElementById('stock-status-filter').value = '';
    document.getElementById('stock-days-filter').value = '';
    displayStock();
  }

  function setStockView(view) {
    currentStockView = view;
    
    // Mettre √† jour les boutons
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Afficher/masquer les vues
    document.getElementById('stock-gallery-view').style.display = view === 'gallery' ? 'block' : 'none';
    document.getElementById('stock-table-view').style.display = view === 'table' ? 'block' : 'none';
    
    displayStock();
  }

  async function removeFromStock(stockId) {
    if (!confirm("Confirmer la sortie de ce v√©hicule du stock?")) return;

    const today = new Date().toISOString().split('T')[0];
    
    try {
      const { error } = await supabase
        .from('garage_stock')
        .update({ 
          exit_date: today, 
          exit_reason: 'manual_removal',
          notes: 'Sortie manuelle du stock'
        })
        .eq('id', stockId);

      if (error) throw error;

      showNotification("V√©hicule retir√© du stock avec succ√®s");
      await loadStockData();
      updateStockStats();
      
    } catch (error) {
      console.error('Erreur retrait stock:', error);
      showNotification("Erreur lors du retrait du stock", "error");
    }
  }

  function openStockManagement() {
    const vehicleSelect = document.getElementById('stock-vehicle');
    vehicleSelect.innerHTML = '<option value="">S√©lectionner un v√©hicule</option>';
    
    // Ajouter les v√©hicules non d√©j√† en stock
    const vehiclesInStock = garageStock.map(item => item.vehicle_id);
    vehicles.forEach(vehicle => {
      if (!vehiclesInStock.includes(vehicle.id)) {
        const option = document.createElement('option');
        option.value = vehicle.id;
        option.textContent = `${vehicle.immatriculation} - ${vehicle.modele}`;
        vehicleSelect.appendChild(option);
      }
    });

    document.getElementById('stock-management-modal').style.display = 'flex';
  }

  async function confirmStockAction() {
    const action = document.getElementById('stock-action').value;
    const vehicleId = document.getElementById('stock-vehicle').value;
    const reason = document.getElementById('stock-reason').value;
    const notes = document.getElementById('stock-notes').value;

    if (!vehicleId) {
      showNotification("Veuillez s√©lectionner un v√©hicule", "error");
      return;
    }

    const today = new Date().toISOString().split('T')[0];
    const vehicle = vehicles.find(v => v.id === vehicleId);

    try {
      if (action === 'add') {
        // Ajouter au stock
        const { error } = await supabase
          .from('garage_stock')
          .insert([{
            vehicle_id: vehicleId,
            entry_date: today,
            entry_reason: reason,
            notes: notes
          }]);

        if (error) throw error;

        showNotification(`V√©hicule ${vehicle.immatriculation} ajout√© au stock`);

      } else {
        // Retirer du stock
        const { error } = await supabase
          .from('garage_stock')
          .update({ 
            exit_date: today, 
            exit_reason: reason,
            notes: notes
          })
          .eq('vehicle_id', vehicleId)
          .is('exit_date', null);

        if (error) throw error;

        showNotification(`V√©hicule ${vehicle.immatriculation} retir√© du stock`);
      }

      closeModal('stock-management-modal');
      await loadStockData();
      updateStockStats();

    } catch (error) {
      console.error('Erreur gestion stock:', error);
      showNotification("Erreur lors de la gestion du stock", "error");
    }
  }

  function showStockHistory() {
    const historyContent = document.getElementById('stock-history-content');
    
    if (stockHistory.length === 0) {
      historyContent.innerHTML = '<p style="text-align: center; padding: 20px;">Aucun historique de stock disponible</p>';
    } else {
      let html = '<div style="max-height: 400px; overflow-y: auto;">';
      
      stockHistory.forEach(item => {
        const vehicle = item.vehicles;
        if (!vehicle) return;

        const isEntry = !item.exit_date;
        const date = isEntry ? item.entry_date : item.exit_date;
        const typeClass = isEntry ? 'entry' : 'exit';
        const icon = isEntry ? 'fa-sign-in-alt' : 'fa-sign-out-alt';
        const text = isEntry ? 'Entr√©e' : 'Sortie';

        html += `
          <div class="stock-history-item ${typeClass}">
            <div style="display: flex; justify-content: between; align-items: center;">
              <div>
                <i class="fas ${icon}" style="margin-right: 8px;"></i>
                <strong>${vehicle.immatriculation}</strong> - ${vehicle.modele}
              </div>
              <span style="font-size: 0.9rem; color: #666;">${formatDate(date)}</span>
            </div>
            <div style="margin-top: 5px; font-size: 0.9rem;">
              ${text} - Raison: ${item.entry_reason || item.exit_reason}
              ${item.notes ? `<br><em>${item.notes}</em>` : ''}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      historyContent.innerHTML = html;
    }

    document.getElementById('stock-history-modal').style.display = 'flex';
  }

  function showVehicleStockHistory(vehicleId) {
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) return;

    const vehicleHistory = stockHistory.filter(item => item.vehicle_id === vehicleId);
    
    let html = `
      <h3 style="margin-bottom: 15px;">Historique stock - ${vehicle.immatriculation}</h3>
      <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    if (vehicleHistory.length === 0) {
      html += '<p style="text-align: center; padding: 20px;">Aucun historique pour ce v√©hicule</p>';
    } else {
      vehicleHistory.forEach(item => {
        const isEntry = !item.exit_date;
        const date = isEntry ? item.entry_date : item.exit_date;
        const typeClass = isEntry ? 'entry' : 'exit';
        const icon = isEntry ? 'fa-sign-in-alt' : 'fa-sign-out-alt';
        const text = isEntry ? 'Entr√©e' : 'Sortie';

        html += `
          <div class="stock-history-item ${typeClass}">
            <div style="display: flex; justify-content: between; align-items: center;">
              <div>
                <i class="fas ${icon}" style="margin-right: 8px;"></i>
                <strong>${text}</strong>
              </div>
              <span style="font-size: 0.9rem; color: #666;">${formatDate(date)}</span>
            </div>
            <div style="margin-top: 5px; font-size: 0.9rem;">
              Raison: ${item.entry_reason || item.exit_reason}
              ${item.notes ? `<br><em>${item.notes}</em>` : ''}
            </div>
          </div>
        `;
      });
    }
    
    html += '</div>';
    
    const historyContent = document.getElementById('stock-history-content');
    historyContent.innerHTML = html;
    document.getElementById('stock-history-modal').style.display = 'flex';
  }

  function updateStockStats() {
    const today = new Date().toISOString().split('T')[0];
    
    // Stats basiques
    document.getElementById('current-stock-count').textContent = garageStock.length;
    
    // Entr√©es/sorties du jour
    const todayEntries = garageStock.filter(item => item.entry_date === today).length;
    const todayExits = stockHistory.filter(item => item.exit_date === today).length;
    
    document.getElementById('today-entries').textContent = todayEntries;
    document.getElementById('today-exits').textContent = todayExits;
    
    // Anciennet√© moyenne
    const totalDays = garageStock.reduce((sum, item) => {
      return sum + calculateDaysInStock(item.entry_date);
    }, 0);
    
    const averageDays = garageStock.length > 0 ? Math.round(totalDays / garageStock.length) : 0;
    document.getElementById('average-stay').textContent = averageDays + 'j';
    
    // Tendances (comparaison avec hier)
    updateStockTrends();
    
    // Mettre √† jour la pr√©visualisation des v√©hicules r√©cents
    updateRecentStockPreview();
  }

  function updateStockTrends() {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    
    const yesterdayStock = stockHistory.filter(item => 
      item.entry_date <= yesterdayStr && (!item.exit_date || item.exit_date > yesterdayStr)
    ).length;
    
    const currentStock = garageStock.length;
    const difference = currentStock - yesterdayStock;
    
    const trendElement = document.getElementById('stock-trend');
    if (difference > 0) {
      trendElement.innerHTML = `<span class="trend up">+${difference} vs hier</span>`;
    } else if (difference < 0) {
      trendElement.innerHTML = `<span class="trend down">${difference} vs hier</span>`;
    } else {
      trendElement.innerHTML = `<span class="trend">Stable vs hier</span>`;
    }
  }

  function updateRecentStockPreview() {
    const recentContainer = document.getElementById('recent-stock-preview');
    const recentStock = garageStock.slice(0, 4); // 4 v√©hicules les plus r√©cents
    
    if (recentStock.length === 0) {
      recentContainer.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Aucun v√©hicule en stock</p>';
      return;
    }
    
    recentContainer.innerHTML = '';
    
    recentStock.forEach(item => {
      const vehicle = item.vehicles;
      if (!vehicle) return;
      
      const daysInStock = calculateDaysInStock(item.entry_date);
      
      const card = document.createElement('div');
      card.className = 'vehicle-card';
      card.style.transform = 'scale(0.95)';
      card.innerHTML = `
        <img src="${vehicle.photo}" class="vehicle-card-photo" alt="${vehicle.immatriculation}" 
             onerror="this.src='https://via.placeholder.com/280x180?text=Vehicle'">
        <div class="vehicle-card-info">
          <div class="vehicle-card-header">
            <div class="vehicle-card-immat">${vehicle.immatriculation}</div>
            <div class="vehicle-card-days ${getDaysClass(daysInStock)}">${daysInStock}j</div>
          </div>
          <div class="vehicle-card-model">${vehicle.modele}</div>
          <div class="vehicle-card-meta">
            <i class="fas fa-calendar-alt"></i>Entr√© le: ${formatDate(item.entry_date)}
          </div>
          <button class="vehicle-card-btn btn-details" onclick="showVehicleDetails('${item.vehicle_id}')" style="margin-top: 8px;">
            <i class="fas fa-eye"></i> Voir d√©tails
          </button>
        </div>
      `;
      recentContainer.appendChild(card);
    });
  }

  function calculateDaysInStock(entryDate) {
    const entry = new Date(entryDate);
    const today = new Date();
    const diffTime = today - entry;
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
  }

  function getDaysClass(days) {
    if (days > 30) return 'old';
    if (days < 7) return 'new';
    return '';
  }

  function getLastIntervention(vehicleId) {
    const vehicleInterventions = interventions
      .filter(i => i.vehicule_id === vehicleId)
      .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    return vehicleInterventions.length > 0 
      ? `${vehicleInterventions[0].type} (${formatDate(vehicleInterventions[0].date)})`
      : 'Aucune intervention';
  }

  function getVehicleStatus(vehicleId) {
    const vehicleInterventions = interventions.filter(i => i.vehicule_id === vehicleId);
    if (vehicleInterventions.length === 0) return 'en-attente';
    
    const lastIntervention = vehicleInterventions.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    return lastIntervention.statut;
  }

  function exportStockReport() {
    const today = new Date().toISOString().split('T')[0];
    let csvContent = "Immatriculation,Mod√®le,Couleur,Propri√©taire,Date entr√©e,Jours pr√©sents,Derni√®re intervention,Statut\n";
    
    garageStock.forEach(item => {
      const vehicle = item.vehicles;
      if (!vehicle) return;
      
      const daysInStock = calculateDaysInStock(item.entry_date);
      const lastIntervention = getLastIntervention(item.vehicle_id);
      const status = getVehicleStatus(item.vehicle_id);
      
      csvContent += `"${vehicle.immatriculation}","${vehicle.modele}","${vehicle.couleur}","${vehicle.proprietaire || ''}","${item.entry_date}",${daysInStock},"${lastIntervention}","${status}"\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `stock_garage_${today}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification("Rapport de stock export√© avec succ√®s");
  }

  function loadLocalStock() {
    const savedStock = localStorage.getItem('garageStock');
    if (savedStock) {
      garageStock = JSON.parse(savedStock);
    }
    displayStock();
    updateStockStats();
  }

  // ==================== FONCTIONS EXISTANTES ====================

  async function safeSupabaseOperation(operation, successMessage = null, loadingButton = null) {
    if (loadingButton) {
      setButtonLoading(loadingButton, true);
    }

    try {
      const { data, error } = await operation;
      
      if (error) throw error;
      
      if (successMessage && data !== null) {
        showNotification(successMessage);
      }
      return data;
      
    } catch (error) {
      console.error('Operation failed:', error);
      showNotification("Erreur serveur, veuillez r√©essayer", "error");
      return null;
    } finally {
      if (loadingButton) {
        setButtonLoading(loadingButton, false);
      }
    }
  }

  function setButtonLoading(button, isLoading) {
    const btnText = button.querySelector('.btn-text');
    const spinner = button.querySelector('.spinner');
    
    if (isLoading) {
      button.disabled = true;
      if (btnText) btnText.style.display = 'none';
      if (spinner) spinner.style.display = 'inline-block';
    } else {
      button.disabled = false;
      if (btnText) btnText.style.display = 'inline';
      if (spinner) spinner.style.display = 'none';
    }
  }

  function initApp(){
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('date-intervention');
    const journalDateInput = document.getElementById('journal-date');
    
    if(dateInput) dateInput.value = today;
    if(journalDateInput) journalDateInput.value = today;
    
    const photoInput = document.getElementById('photo');
    if(photoInput) {
      photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
          try {
            validateFile(file);
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.getElementById('photo-preview');
              preview.src = e.target.result;
              preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          } catch (error) {
            showNotification(error.message, "error");
            photoInput.value = '';
          }
        }
      });
    }

    const deliveryInput = document.getElementById('bons-livraison');
    const editDeliveryInput = document.getElementById('edit-bons-livraison');
    
    if(deliveryInput) {
      deliveryInput.addEventListener('change', handleDeliveryFiles);
    }
    if(editDeliveryInput) {
      editDeliveryInput.addEventListener('change', handleEditDeliveryFiles);
    }

    document.querySelectorAll('.modal-close').forEach(closeBtn => {
      closeBtn.addEventListener('click', function() {
        this.closest('.modal').style.display = 'none';
      });
    });

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });
    });

    loadGarageStock();
    
    // Forcer l'affichage du bon onglet au chargement
    setTimeout(() => {
        const activeTab = document.querySelector('.menu-item.active');
        if (activeTab && activeTab.dataset.tab) {
            switchTab(activeTab.dataset.tab);
        }
    }, 100);
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }

  async function handleDeliveryFiles(e) {
    const files = Array.from(e.target.files);
    const previewContainer = document.getElementById('delivery-files-preview');
    previewContainer.innerHTML = '';
    
    const validFiles = [];
    
    for (const file of files) {
      try {
        validateFile(file);
        validFiles.push(file);
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileItem = document.createElement('div');
          fileItem.className = 'delivery-file-item';
          fileItem.innerHTML = `
            <img src="${e.target.result}" class="delivery-file-preview" alt="Aper√ßu bon de livraison">
            <div class="delivery-file-name">${file.name}</div>
            <div class="remove-delivery-file" onclick="removeDeliveryFile(${validFiles.length - 1})">
              <i class="fas fa-times"></i> Supprimer
            </div>
          `;
          previewContainer.appendChild(fileItem);
        };
        reader.readAsDataURL(file);
        
      } catch (error) {
        showNotification(`Fichier "${file.name}" rejet√©: ${error.message}`, "error");
      }
    }
    
    deliveryFiles = validFiles;
    e.target.value = '';
  }

  async function handleEditDeliveryFiles(e) {
    const files = Array.from(e.target.files);
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    
    const validFiles = [];
    
    for (const file of files) {
      try {
        validateFile(file);
        validFiles.push(file);
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileItem = document.createElement('div');
          fileItem.className = 'delivery-file-item';
          fileItem.innerHTML = `
            <img src="${e.target.result}" class="delivery-file-preview" alt="Aper√ßu bon de livraison">
            <div class="delivery-file-name">${file.name}</div>
            <div class="remove-delivery-file" onclick="removeEditDeliveryFile(${deliveryFiles.length + validFiles.length - 1})">
              <i class="fas fa-times"></i> Supprimer
            </div>
          `;
          previewContainer.appendChild(fileItem);
        };
        reader.readAsDataURL(file);
        
      } catch (error) {
        showNotification(`Fichier "${file.name}" rejet√©: ${error.message}`, "error");
      }
    }
    
    deliveryFiles = [...deliveryFiles, ...validFiles];
    e.target.value = '';
  }

  function removeDeliveryFile(index) {
    deliveryFiles.splice(index, 1);
    const previewContainer = document.getElementById('delivery-files-preview');
    previewContainer.innerHTML = '';
    
    deliveryFiles.forEach((file, newIndex) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${e.target.result}" class="delivery-file-preview" alt="Aper√ßu bon de livraison">
          <div class="delivery-file-name">${file.name}</div>
          <div class="remove-delivery-file" onclick="removeDeliveryFile(${newIndex})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      };
      reader.readAsDataURL(file);
    });
  }

  function removeEditDeliveryFile(index) {
    deliveryFiles.splice(index, 1);
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    previewContainer.innerHTML = '';
    
    deliveryFiles.forEach((file, newIndex) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${e.target.result}" class="delivery-file-preview" alt="Aper√ßu bon de livraison">
          <div class="delivery-file-name">${file.name}</div>
          <div class="remove-delivery-file" onclick="removeEditDeliveryFile(${newIndex})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      };
      reader.readAsDataURL(file);
    });
  }

  async function removeExistingDeliveryFile(interventionId, fileIndex) {
    if(!confirm("√ätes-vous s√ªr de vouloir supprimer ce bon de livraison?")) return;
    
    try {
      const intervention = interventions.find(i => i.id === interventionId);
      if (intervention && intervention.delivery_files) {
        intervention.delivery_files.splice(fileIndex, 1);
        
        await safeSupabaseOperation(
          supabase
            .from('interventions')
            .update({ delivery_files: intervention.delivery_files })
            .eq('id', interventionId),
          "Bon de livraison supprim√© avec succ√®s"
        );
        
        editIntervention(interventionId);
      }
    } catch (error) {
      console.error("Error deleting delivery file:", error);
      showNotification("Erreur lors de la suppression du bon de livraison", "error");
    }
  }

  async function loadData(){
    try {
      const vehiclesData = await safeSupabaseOperation(
        supabase.from('vehicles').select('*')
      );
      vehicles = vehiclesData || [];

      const interventionsData = await safeSupabaseOperation(
        supabase.from('interventions').select('*')
      );
      interventions = interventionsData || [];

      await loadStockData();
      updateUI();
      
    } catch (err) {
      console.error("Load error", err);
    }
  }

  function setupEventListeners(){
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if(mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        mainContent.classList.toggle('sidebar-open');
      });
    }

    // Gestion am√©lior√©e de la navigation
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function(){
        const tabName = this.dataset.tab;
        
        // Mettre √† jour la navigation
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        
        // Changer d'onglet
        switchTab(tabName);
        
        // Fermer le menu mobile si ouvert
        if(window.innerWidth <= 768) {
          sidebar.classList.remove('open');
          mainContent.classList.remove('sidebar-open');
        }
      });
    });

    const vehicleForm = document.getElementById('vehicle-form');
    if(vehicleForm) vehicleForm.addEventListener('submit', e => { e.preventDefault(); addVehicle(); });

    const interventionForm = document.getElementById('intervention-form');
    if(interventionForm) interventionForm.addEventListener('submit', e => { e.preventDefault(); addIntervention(); });

    const editInterventionForm = document.getElementById('edit-intervention-form');
    if(editInterventionForm) editInterventionForm.addEventListener('submit', e => { e.preventDefault(); updateIntervention(); });

    const searchBtn = document.getElementById('search-button');
    if(searchBtn) searchBtn.addEventListener('click', performSearch);

    const resetSearchBtn = document.getElementById('reset-search');
    if(resetSearchBtn) resetSearchBtn.addEventListener('click', resetSearch);

    const globalSearch = document.getElementById('global-search');
    if(globalSearch) globalSearch.addEventListener('input', e => performGlobalSearch(e.target.value));

    const journalFilter = document.getElementById('journal-filter');
    if(journalFilter) journalFilter.addEventListener('click', updateJournalComplet);

    const journalReset = document.getElementById('journal-reset');
    if(journalReset) journalReset.addEventListener('click', resetJournal);

    const quickAddVehicle = document.getElementById('quick-add-vehicle');
    if(quickAddVehicle) {
      quickAddVehicle.addEventListener('click', () => {
        switchTab('vehicles');
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.querySelector('[data-tab="vehicles"]').classList.add('active');
      });
    }

    const quickAddIntervention = document.getElementById('quick-add-intervention');
    if(quickAddIntervention) {
      quickAddIntervention.addEventListener('click', () => {
        switchTab('interventions');
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.querySelector('[data-tab="interventions"]').classList.add('active');
      });
    }

    const quickManageStock = document.getElementById('quick-manage-stock');
    if(quickManageStock) {
      quickManageStock.addEventListener('click', () => {
        switchTab('stock');
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.querySelector('[data-tab="stock"]').classList.add('active');
      });
    }

    const cancelEdit = document.getElementById('cancel-edit');
    if(cancelEdit) cancelEdit.addEventListener('click', () => {
      document.getElementById('intervention-modal').style.display = 'none';
      currentEditingInterventionId = null;
      deliveryFiles = [];
    });

    const cancelEditVehicle = document.getElementById('cancel-edit-vehicle');
    if(cancelEditVehicle) cancelEditVehicle.addEventListener('click', resetVehicleForm);
  }

  // Les autres fonctions existantes (addVehicle, addIntervention, updateIntervention, etc.)
  // ... sont conserv√©es telles quelles de votre code original

  // ==================== FONCTIONS DE BASE (conserv√©es de votre code) ====================

  async function addVehicle(){
    const immatriculation = document.getElementById('immatriculation').value.trim();
    const modele = document.getElementById('modele').value.trim();
    const couleur = document.getElementById('couleur').value.trim();
    const proprietaire = document.getElementById('proprietaire').value.trim();
    const telephone = document.getElementById('telephone').value.trim();
    const photoInput = document.getElementById('photo');
    const editingId = document.getElementById('vehicle-form').dataset.editingId;
    const submitButton = document.querySelector('#vehicle-form button[type="submit"]');

    if(!immatriculation || !modele) { 
      showNotification("Immatriculation et mod√®le requis", "error"); 
      return; 
    }

    if (vehicles.some(v => v.immatriculation === immatriculation && v.id !== editingId)) {
      showNotification("Cette immatriculation est d√©j√† utilis√©e!", "error");
      return;
    }

    let photoUrl = 'https://via.placeholder.com/100x70?text=Vehicle';
    
    if(photoInput && photoInput.files && photoInput.files[0]) {
      try {
        const file = photoInput.files[0];
        validateFile(file);
        const reader = new FileReader();
        photoUrl = await new Promise((resolve) => {
          reader.onload = function(e) {
            resolve(e.target.result);
          };
          reader.readAsDataURL(file);
        });
      } catch (error) {
        console.error("Error processing vehicle photo:", error);
        showNotification("Erreur lors du traitement de la photo: " + error.message, "error");
        return;
      }
    } else if (editingId) {
      const existingVehicle = vehicles.find(v => v.id === editingId);
      if (existingVehicle) {
        photoUrl = existingVehicle.photo;
      }
    }

    const vehicleData = {
      immatriculation, 
      modele, 
      couleur, 
      proprietaire, 
      telephone, 
      photo: photoUrl
    };

    let operation;
    if (editingId) {
      operation = supabase
        .from('vehicles')
        .update(vehicleData)
        .eq('id', editingId);
    } else {
      operation = supabase
        .from('vehicles')
        .insert([vehicleData])
        .select();
    }

    const result = await safeSupabaseOperation(
      operation,
      editingId ? "V√©hicule modifi√© avec succ√®s!" : "V√©hicule ajout√© avec succ√®s!",
      submitButton
    );
    
    if (result) {
      if (editingId) {
        const index = vehicles.findIndex(v => v.id === editingId);
        if (index !== -1) {
          vehicles[index] = { ...vehicles[index], ...vehicleData };
        }
      } else {
        vehicles.push(result[0]);
      }
      
      updateUI();
      resetVehicleForm();
    }
  }

  async function addIntervention(){
    const vehiculeId = document.getElementById('vehicule-intervention').value;
    const date = document.getElementById('date-intervention').value;
    const type = document.getElementById('type-intervention').value.trim();
    const mecaniciensElements = document.getElementById('mecaniciens');
    const pieces = document.getElementById('pieces').value.trim();
    const statut = document.getElementById('statut').value;
    const observations = document.getElementById('observations').value.trim();
    const submitButton = document.querySelector('#intervention-form button[type="submit"]');

    if(!vehiculeId){ showNotification("S√©lectionner un v√©hicule", "error"); return; }
    if(!date || !type){ showNotification("Date et type requis", "error"); return; }

    const mecaniciens = Array.from(mecaniciensElements.selectedOptions).map(o => o.text);
    const vehicle = vehicles.find(v => v.id == vehiculeId);
    if(!vehicle){ showNotification("V√©hicule introuvable", "error"); return; }

    let deliveryUrls = [];
    if (deliveryFiles.length > 0) {
      try {
        for (const file of deliveryFiles) {
          validateFile(file);
          const reader = new FileReader();
          const base64String = await new Promise((resolve) => {
            reader.onload = function(e) {
              resolve(e.target.result);
            };
            reader.readAsDataURL(file);
          });
          deliveryUrls.push(base64String);
        }
      } catch (error) {
        console.error("Error processing delivery files:", error);
        showNotification("Erreur lors du traitement des photos: " + error.message, "error");
        return;
      }
    }

    const newIntervention = {
      vehicule_id: vehicle.id,
      immatriculation: vehicle.immatriculation,
      modele: vehicle.modele,
      date, 
      type, 
      mecaniciens, 
      pieces, 
      statut, 
      observations,
      delivery_files: deliveryUrls
    };

    const result = await safeSupabaseOperation(
      supabase
        .from('interventions')
        .insert([newIntervention])
        .select(),
      "Intervention enregistr√©e avec succ√®s!",
      submitButton
    );
    
    if (result) {
      interventions.push(result[0]);
      updateUI();
      
      document.getElementById('intervention-form').reset();
      document.getElementById('delivery-files-preview').innerHTML = '';
      deliveryFiles = [];
      document.getElementById('date-intervention').value = new Date().toISOString().split('T')[0];
    }
  }

  async function updateIntervention(){
    const id = document.getElementById('edit-intervention-id').value;
    const vehiculeId = document.getElementById('edit-vehicule-intervention').value;
    const date = document.getElementById('edit-date-intervention').value;
    const type = document.getElementById('edit-type-intervention').value.trim();
    const mecaniciensElements = document.getElementById('edit-mecaniciens');
    const pieces = document.getElementById('edit-pieces').value.trim();
    const statut = document.getElementById('edit-statut').value;
    const observations = document.getElementById('edit-observations').value.trim();
    const submitButton = document.querySelector('#edit-intervention-form button[type="submit"]');

    if(!vehiculeId){ showNotification("S√©lectionner un v√©hicule", "error"); return; }
    if(!date || !type){ showNotification("Date et type requis", "error"); return; }

    const mecaniciens = Array.from(mecaniciensElements.selectedOptions).map(o => o.text);
    const vehicle = vehicles.find(v => v.id == vehiculeId);
    if(!vehicle){ showNotification("V√©hicule introuvable", "error"); return; }

    let newDeliveryUrls = [];
    if (deliveryFiles.length > 0) {
      try {
        for (const file of deliveryFiles) {
          validateFile(file);
          const reader = new FileReader();
          const base64String = await new Promise((resolve) => {
            reader.onload = function(e) {
              resolve(e.target.result);
            };
            reader.readAsDataURL(file);
          });
          newDeliveryUrls.push(base64String);
        }
      } catch (error) {
        console.error("Error processing delivery files:", error);
        showNotification("Erreur lors du traitement des photos: " + error.message, "error");
        return;
      }
    }

    const existingIntervention = interventions.find(i => i.id === id);
    const existingDeliveryUrls = existingIntervention.delivery_files || [];

    const updatedIntervention = {
      vehicule_id: vehicle.id,
      immatriculation: vehicle.immatriculation,
      modele: vehicle.modele,
      date, type, mecaniciens, pieces, statut, observations,
      delivery_files: [...existingDeliveryUrls, ...newDeliveryUrls]
    };

    const result = await safeSupabaseOperation(
      supabase
        .from('interventions')
        .update(updatedIntervention)
        .eq('id', id),
      "Intervention modifi√©e avec succ√®s!",
      submitButton
    );
    
    if (result !== null) {
      const index = interventions.findIndex(i => i.id === id);
      if(index !== -1) {
        interventions[index] = { ...interventions[index], ...updatedIntervention };
      }
      
      updateUI();
      document.getElementById('intervention-modal').style.display = 'none';
      currentEditingInterventionId = null;
      deliveryFiles = [];
    }
  }

  function validateFile(file, maxSizeMB = 5) {
    const maxSize = maxSizeMB * 1024 * 1024;
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    
    if (file.size > maxSize) {
      throw new Error(`Fichier trop volumineux (max ${maxSizeMB}MB)`);
    }
    
    if (!allowedTypes.includes(file.type)) {
      throw new Error('Type de fichier non support√©. Utilisez JPG, PNG ou WebP');
    }
    
    return true;
  }

  function loadGarageStock() {
    const savedStock = localStorage.getItem('garageStock');
    if (savedStock) {
      garageStock = JSON.parse(savedStock);
    }
  }

  function updateUI(){
    updateVehicleList();
    updateInterventionsList();
    updateVehicleSelect();
    updateStats();
    updateFlux();
    updateJournalComplet();
  }

  function updateVehicleList(){
    const container = document.getElementById('vehicles-list');
    container.innerHTML = '';
    if(vehicles.length === 0) { 
        container.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucun v√©hicule enregistr√©</td></tr>'; 
        return; 
    }

    vehicles.forEach(vehicle => {
        const tr = document.createElement('tr');
        
        const imgHTML = `
            <img src="${vehicle.photo}" 
                 class="vehicle-photo" 
                 alt="photo" 
                 loading="lazy"
                 onerror="this.src='https://via.placeholder.com/100x70?text=Vehicle'; this.onerror=null;"
        `;

        tr.innerHTML = `
            <td style="width: 100px; min-width: 100px; max-width: 100px;">${imgHTML}</td>
            <td>${vehicle.immatriculation}</td>
            <td>${vehicle.modele}</td>
            <td>${vehicle.couleur}</td>
            <td>${vehicle.proprietaire || ''}</td>
            <td class="action-buttons">
                <button class="btn-edit" onclick="editVehicle('${vehicle.id}')">Modifier</button>
                <button class="btn-delete" onclick="deleteVehicle('${vehicle.id}')">Supprimer</button>
            </td>
        `;
        container.appendChild(tr);
    });
  }

  function updateInterventionsList(){
    const container = document.getElementById('interventions-list');
    container.innerHTML = '';
    if(interventions.length === 0) { 
      container.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucune intervention enregistr√©e</td></tr>'; 
      return; 
    }

    const sorted = [...interventions].sort((a,b)=> new Date(b.date) - new Date(a.date));
    sorted.forEach(i => {
      const vehicle = vehicles.find(v=>v.id===i.vehicule_id);
      if(!vehicle) return;
      const statusClass = 'status-' + i.statut;
      
      let deliveryHtml = 'Aucun';
      if (i.delivery_files && i.delivery_files.length > 0) {
        deliveryHtml = i.delivery_files.map((url, index) => 
          `<img src="${url}" class="delivery-photo" alt="Bon livraison ${index + 1}" title="Bon de livraison ${index + 1}" loading="lazy" onerror="this.style.display='none'">`
        ).join('');
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${vehicle.immatriculation} (${vehicle.modele})</td>
        <td>${formatDate(i.date)}</td>
        <td>${i.type}</td>
        <td>${i.mecaniciens.join(', ')}</td>
        <td>${deliveryHtml}</td>
        <td><span class="status-badge ${statusClass}">${i.statut}</span></td>
        <td class="action-buttons">
          <button class="btn-edit" onclick="editIntervention('${i.id}')">Modifier</button>
          <button class="btn-delete" onclick="deleteIntervention('${i.id}')">Supprimer</button>
        </td>
      `;
      container.appendChild(tr);
    });
  }

  function updateVehicleSelect(){
    const select = document.getElementById('vehicule-intervention');
    const editSelect = document.getElementById('edit-vehicule-intervention');
    
    select.innerHTML = '<option value="">S√©lectionner un v√©hicule</option>';
    if(editSelect) editSelect.innerHTML = '<option value="">S√©lectionner un v√©hicule</option>';
    
    vehicles.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v.id;
      opt.textContent = v.immatriculation + ' - ' + v.modele;
      select.appendChild(opt);
      
      if(editSelect) {
        const editOpt = document.createElement('option');
        editOpt.value = v.id;
        editOpt.textContent = v.immatriculation + ' - ' + v.modele;
        editSelect.appendChild(editOpt);
      }
    });
  }

  function updateStats(){
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const monthlyOil = interventions.filter(i=>{
      const d = new Date(i.date);
      return i.type.toLowerCase() === 'vidange' && d.getMonth()===currentMonth && d.getFullYear()===currentYear;
    }).length;

    const vehiclesInWaiting = [...new Set(
      interventions
        .filter(i => i.statut === 'en-attente')
        .map(i => i.vehicule_id)
    )].length;

    document.getElementById('vehicles-waiting').textContent = vehiclesInWaiting;

    document.getElementById('total-interventions').textContent = interventions.length;
    document.getElementById('month-oil-changes').textContent = monthlyOil;
    
    const completed = interventions.filter(i=>i.statut==='termine').length;
    document.getElementById('completion-rate').textContent = interventions.length>0 ? Math.round((completed/interventions.length)*100) + '%' : '0%';

    const mechanicsStats = {};
    interventions.forEach(i=>{
      (i.mecaniciens||[]).forEach(m=>{
        if(!mechanicsStats[m]) mechanicsStats[m] = { total:0, inProgress:0, completed:0 };
        mechanicsStats[m].total++;
        if(i.statut==='en-cours') mechanicsStats[m].inProgress++;
        if(i.statut==='termine') mechanicsStats[m].completed++;
      });
    });

    const container = document.getElementById('mechanics-stats');
    container.innerHTML = '';
    Object.keys(mechanicsStats).forEach(m=>{
      const successRate = mechanicsStats[m].total > 0 ? 
        Math.round((mechanicsStats[m].completed / mechanicsStats[m].total) * 100) : 0;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${m}</td>
        <td>${mechanicsStats[m].total}</td>
        <td>${mechanicsStats[m].inProgress}</td>
        <td>${mechanicsStats[m].completed}</td>
        <td>${successRate}%</td>
      `;
      container.appendChild(row);
    });

    const typeStats = {};
    interventions.forEach(i => {
      if(!typeStats[i.type]) typeStats[i.type] = 0;
      typeStats[i.type]++;
    });

    const typeContainer = document.getElementById('intervention-types-stats');
    typeContainer.innerHTML = '';
    
    const sortedTypes = Object.entries(typeStats)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    sortedTypes.forEach(([type, count]) => {
      const percentage = interventions.length > 0 ? Math.round((count / interventions.length) * 100) : 0;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${type}</strong></td>
        <td style="text-align: center; font-weight: 700;">${count}</td>
        <td style="text-align: center; font-weight: 600; color: #27ae60;">${percentage}%</td>
        <td>
          <div class="percentage-bar">
            <div class="percentage-fill" style="width: ${percentage}%"></div>
          </div>
        </td>
      `;
      typeContainer.appendChild(row);
    });

    if (sortedTypes.length === 0) {
      typeContainer.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">Aucune intervention enregistr√©e</td></tr>';
    }
  }

  function updateFlux(){
    const today = new Date().toISOString().split('T')[0];
    
    const vehiclesEntered = interventions
      .filter(i => i.date === today)
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    const vehiclesInProgress = interventions
      .filter(i => i.date === today && i.statut === 'en-cours')
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    const vehiclesExited = interventions
      .filter(i => i.date === today && i.statut === 'termine')
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    const entreesContainer = document.getElementById('flux-entrees');
    const enCoursContainer = document.getElementById('flux-en-cours');
    const sortiesContainer = document.getElementById('flux-sorties');
    
    entreesContainer.innerHTML = vehiclesEntered.length ? 
      vehiclesEntered.map(v => `
        <div class="flux-item entree">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun v√©hicule entr√©</p>';
    
    enCoursContainer.innerHTML = vehiclesInProgress.length ? 
      vehiclesInProgress.map(v => `
        <div class="flux-item">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun v√©hicule en cours</p>';
    
    sortiesContainer.innerHTML = vehiclesExited.length ? 
      vehiclesExited.map(v => `
        <div class="flux-item sortie">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun v√©hicule sorti</p>';
  }

  function updateJournalComplet() {
    const selectedDate = document.getElementById('journal-date').value;
    const selectedType = document.getElementById('journal-type').value;
    const selectedStatut = document.getElementById('journal-statut').value;
    
    let filteredInterventions = [...interventions];
    
    if (selectedDate) {
      filteredInterventions = filteredInterventions.filter(i => i.date === selectedDate);
    }
    
    if (selectedType) {
      filteredInterventions = filteredInterventions.filter(i => i.type === selectedType);
    }
    
    if (selectedStatut) {
      filteredInterventions = filteredInterventions.filter(i => i.statut === selectedStatut);
    }
    
    filteredInterventions.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const container = document.getElementById('journal-complet');
    container.innerHTML = '';
    
    if (filteredInterventions.length === 0) {
      container.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucune intervention trouv√©e</td></tr>';
      return;
    }
    
    filteredInterventions.forEach(intervention => {
      const vehicle = vehicles.find(v => v.id === intervention.vehicule_id);
      if (!vehicle) return;
      
      let deliveryPhotosHtml = 'Aucun';
      if (intervention.delivery_files && intervention.delivery_files.length > 0) {
        deliveryPhotosHtml = intervention.delivery_files.map(url => 
          `<img src="${url}" class="delivery-photo" alt="Bon livraison" title="Bon de livraison" loading="lazy" onerror="this.style.display='none'">`
        ).join('');
      }
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(intervention.date)}</td>
        <td>${vehicle.immatriculation} - ${vehicle.modele}</td>
        <td>${intervention.type}</td>
        <td>${intervention.mecaniciens.join(', ')}</td>
        <td>${deliveryPhotosHtml}</td>
        <td><span class="status-badge status-${intervention.statut}">${intervention.statut}</span></td>
        <td>${intervention.observations || ''}</td>
      `;
      container.appendChild(tr);
    });
  }

  function resetJournal() {
    document.getElementById('journal-date').value = '';
    document.getElementById('journal-type').value = '';
    document.getElementById('journal-statut').value = '';
    updateJournalComplet();
  }

  async function editVehicle(id){
    const v = vehicles.find(x=>x.id===id);
    if(!v) return;
    
    document.getElementById('immatriculation').value = v.immatriculation;
    document.getElementById('modele').value = v.modele;
    document.getElementById('couleur').value = v.couleur;
    document.getElementById('proprietaire').value = v.proprietaire || '';
    document.getElementById('telephone').value = v.telephone || '';
    
    const preview = document.getElementById('photo-preview');
    preview.src = v.photo;
    preview.style.display = 'block';
    
    document.getElementById('vehicle-form').dataset.editingId = id;
    document.querySelector('#vehicle-form .btn-text').textContent = 'Modifier le v√©hicule';
    document.getElementById('cancel-edit-vehicle').style.display = 'inline-block';
    
    showNotification("Modifiez le v√©hicule puis cliquez sur Modifier");
  }

  async function deleteVehicle(id, showNote = true){
    if(!confirm("√ätes-vous s√ªr de vouloir supprimer ce v√©hicule? Toutes les interventions associ√©es seront √©galement supprim√©es.")) return;
    
    const result = await safeSupabaseOperation(
      supabase
        .from('vehicles')
        .delete()
        .eq('id', id),
      showNote ? "V√©hicule supprim√© avec succ√®s" : null
    );
    
    if (result !== null) {
      vehicles = vehicles.filter(v=>v.id!==id);
      interventions = interventions.filter(i=>i.vehicule_id!==id);

      const stockIndex = garageStock.findIndex(item => item.vehicle_id === id);
      if (stockIndex > -1) {
        garageStock.splice(stockIndex, 1);
      }

      updateUI();
    }
  }

  async function deleteIntervention(id){
    if(!confirm("√ätes-vous s√ªr de vouloir supprimer cette intervention?")) return;
    
    const intervention = interventions.find(i => i.id === id);
    
    const result = await safeSupabaseOperation(
      supabase
        .from('interventions')
        .delete()
        .eq('id', id),
      "Intervention supprim√©e avec succ√®s"
    );
    
    if (result !== null) {
      interventions = interventions.filter(i=>i.id!==id);
      
      if (intervention && intervention.statut === 'termine') {
        const stockIndex = garageStock.findIndex(item => item.vehicle_id === intervention.vehicule_id);
        if (stockIndex > -1) {
          garageStock.splice(stockIndex, 1);
        }
      }
      
      updateUI();
    }
  }

  function editIntervention(id){
    const intervention = interventions.find(i => i.id === id);
    if(!intervention) return;
    
    currentEditingInterventionId = id;
    deliveryFiles = [];
    
    document.getElementById('edit-intervention-id').value = id;
    document.getElementById('edit-vehicule-intervention').value = intervention.vehicule_id;
    document.getElementById('edit-date-intervention').value = intervention.date;
    document.getElementById('edit-type-intervention').value = intervention.type;
    document.getElementById('edit-pieces').value = intervention.pieces || '';
    document.getElementById('edit-statut').value = intervention.statut;
    document.getElementById('edit-observations').value = intervention.observations || '';
    
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    previewContainer.innerHTML = '';
    if (intervention.delivery_files && intervention.delivery_files.length > 0) {
      intervention.delivery_files.forEach((url, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${url}" class="delivery-file-preview" alt="Bon de livraison">
          <div class="delivery-file-name">Bon de livraison ${index + 1}</div>
          <div class="remove-delivery-file" onclick="removeExistingDeliveryFile('${id}', ${index})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      });
    }
    
    const mecaniciensSelect = document.getElementById('edit-mecaniciens');
    Array.from(mecaniciensSelect.options).forEach(option => {
      option.selected = intervention.mecaniciens.includes(option.text);
    });
    
    document.getElementById('intervention-modal').style.display = 'flex';
  }

  function resetVehicleForm() {
    document.getElementById('vehicle-form').reset();
    delete document.getElementById('vehicle-form').dataset.editingId;
    document.querySelector('#vehicle-form .btn-text').textContent = 'Enregistrer le v√©hicule';
    document.getElementById('cancel-edit-vehicle').style.display = 'none';
    document.getElementById('photo-preview').style.display = 'none';
  }

  function performSearch(){
    const immatriculation = (document.getElementById('search-immatriculation').value || '').toLowerCase();
    const modele = (document.getElementById('search-modele').value || '').toLowerCase();
    const couleur = (document.getElementById('search-couleur').value || '').toLowerCase();
    const date = document.getElementById('search-date').value;
    const type = document.getElementById('search-type').value;
    const statut = document.getElementById('search-statut').value;

    let results = vehicles.slice();

    if(immatriculation) results = results.filter(v => v.immatriculation.toLowerCase().includes(immatriculation));
    if(modele) results = results.filter(v => v.modele.toLowerCase().includes(modele));
    if(couleur) results = results.filter(v => v.couleur.toLowerCase().includes(couleur));

    if(date || type || statut) {
      const ids = interventions.filter(i => {
        let match = true;
        if(date) match = match && i.date === date;
        if(type) match = match && i.type === type;
        if(statut) match = match && i.statut === statut;
        return match;
      }).map(i => i.vehicule_id);
      results = results.filter(v => ids.includes(v.id));
    }

    const resultsContainer = document.getElementById('search-results');
    const resultsCount = document.getElementById('search-results-count');
    resultsContainer.innerHTML = '';
    
    if(results.length === 0){
      resultsContainer.innerHTML = '<tr><td colspan="8" style="text-align:center">Aucun r√©sultat trouv√©</td></tr>';
      resultsCount.innerHTML = '<p>Aucun r√©sultat trouv√©</p>';
      return;
    }

    resultsCount.innerHTML = '<p>' + results.length + ' r√©sultat(s) trouv√©(s)</p>';

    results.forEach(vehicle => {
      const lastIntervention = interventions
        .filter(i => i.vehicule_id === vehicle.id)
        .sort((a,b)=> new Date(b.date) - new Date(a.date))[0];

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><img src="${vehicle.photo}" class="vehicle-photo" alt="photo" loading="lazy" onerror="this.src='https://via.placeholder.com/100x70?text=Vehicle'"></td>
        <td>${vehicle.immatriculation}</td>
        <td>${vehicle.modele}</td>
        <td>${vehicle.couleur}</td>
        <td>${vehicle.proprietaire || ''}</td>
        <td>${lastIntervention ? lastIntervention.type + ' (' + formatDate(lastIntervention.date) + ')' : 'Aucune'}</td>
        <td>${lastIntervention ? '<span class="status-badge status-' + lastIntervention.statut + '">' + lastIntervention.statut + '</span>' : 'N/A'}</td>
        <td class="action-buttons">
          <button class="btn-edit" onclick="editVehicle('${vehicle.id}')">Modifier</button>
          <button class="btn-delete" onclick="deleteVehicle('${vehicle.id}')">Supprimer</button>
          <button class="btn-details" onclick="showVehicleDetails('${vehicle.id}')">D√©tails</button>
        </td>
      `;
      resultsContainer.appendChild(tr);
    });
  }

  function resetSearch(){
    document.getElementById('search-immatriculation').value = '';
    document.getElementById('search-modele').value = '';
    document.getElementById('search-couleur').value = '';
    document.getElementById('search-date').value = '';
    document.getElementById('search-type').value = '';
    document.getElementById('search-statut').value = '';
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('search-results-count').innerHTML = '';
  }

  function performGlobalSearch(query){
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if(!query || query.length < 2) return;
      query = query.toLowerCase();

      const results = [
        ...vehicles.filter(v => v.immatriculation.toLowerCase().includes(query) || v.modele.toLowerCase().includes(query) || (v.proprietaire || '').toLowerCase().includes(query)),
        ...interventions.filter(i => i.immatriculation.toLowerCase().includes(query) || (i.type || '').toLowerCase().includes(query) || i.mecaniciens.some(m => m.toLowerCase().includes(query))).map(i => vehicles.find(v=>v.id===i.vehicule_id)).filter(Boolean)
      ];

      const unique = [...new Map(results.map(r => [r.id, r])).values()];
      if(unique.length) showNotification(unique.length + ' r√©sultat(s) trouv√©(s) pour "' + query + '"');
    }, 300);
  }

  function showVehicleDetails(vehicleId) {
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) return;
    
    const interventionsForVehicle = interventions.filter(i => i.vehicule_id === vehicleId)
      .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let detailsHtml = `
      <div class="vehicle-details-grid">
        <div>
          <img src="${vehicle.photo}" class="vehicle-details-photo" alt="Photo du v√©hicule" onerror="this.src='https://via.placeholder.com/300x200?text=Vehicle'">
        </div>
        <div>
          <h3>Informations du v√©hicule</h3>
          <p><strong>Immatriculation:</strong> ${vehicle.immatriculation}</p>
          <p><strong>Mod√®le:</strong> ${vehicle.modele}</p>
          <p><strong>Couleur:</strong> ${vehicle.couleur}</p>
          <p><strong>Propri√©taire:</strong> ${vehicle.proprietaire || 'Non renseign√©'}</p>
          <p><strong>T√©l√©phone:</strong> ${vehicle.telephone || 'Non renseign√©'}</p>
        </div>
      </div>
    `;
    
    if (interventionsForVehicle.length > 0) {
      detailsHtml += `
        <h3>Historique des interventions (${interventionsForVehicle.length})</h3>
        <div class="intervention-history">
      `;
      
      interventionsForVehicle.forEach(intervention => {
        const statusClass = intervention.statut.replace('-', ' ');
        detailsHtml += `
          <div class="intervention-item ${statusClass}">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
              <div>
                <strong>${intervention.type}</strong> - ${formatDate(intervention.date)}
              </div>
              <span class="status-badge status-${intervention.statut}">${intervention.statut}</span>
            </div>
            <p><strong>M√©caniciens:</strong> ${intervention.mecaniciens.join(', ')}</p>
            ${intervention.pieces ? `<p><strong>Pi√®ces utilis√©es:</strong> ${intervention.pieces}</p>` : ''}
            ${intervention.observations ? `<p><strong>Observations:</strong> ${intervention.observations}</p>` : ''}
            <div style="margin-top: 10px;">
              <button class="btn-edit btn-sm" onclick="editIntervention('${intervention.id}'); closeModal('vehicle-details-modal')">
                <i class="fas fa-edit"></i> Modifier
              </button>
            </div>
          </div>
        `;
      });
      
      detailsHtml += `</div>`;
    } else {
      detailsHtml += '<p style="text-align: center; padding: 20px;">Aucune intervention enregistr√©e pour ce v√©hicule.</p>';
    }
    
    document.getElementById('vehicle-details-content').innerHTML = detailsHtml;
    document.getElementById('vehicle-details-modal').style.display = 'flex';
  }

  function showNotification(message, type="success"){
    const note = document.getElementById('notification');
    note.textContent = message;
    note.className = 'notification ' + (type === 'error' ? 'error' : (type === 'warning' ? 'warning' : '')) + ' show';
    setTimeout(()=>{ note.classList.remove('show'); }, 5000);
  }

  function formatDate(dateString){
    const d = new Date(dateString);
    return d.toLocaleDateString('fr-FR');
  }

  let searchTimeout;

  // ==================== INITIALISATION ====================

  document.addEventListener('DOMContentLoaded', () => {
    initApp();
    loadData();
    setupEventListeners();
  });

  // ==================== EXPOSITION GLOBALE ====================

  window.switchTab = switchTab;
  window.removeFromStock = removeFromStock;
  window.openStockManagement = openStockManagement;
  window.confirmStockAction = confirmStockAction;
  window.showStockHistory = showStockHistory;
  window.showVehicleStockHistory = showVehicleStockHistory;
  window.exportStockReport = exportStockReport;
  window.filterStock = filterStock;
  window.resetStockFilter = resetStockFilter;
  window.setStockView = setStockView;

  window.editVehicle = editVehicle;
  window.deleteVehicle = deleteVehicle;
  window.editIntervention = editIntervention;
  window.deleteIntervention = deleteIntervention;
  window.removeDeliveryFile = removeDeliveryFile;
  window.removeEditDeliveryFile = removeEditDeliveryFile;
  window.removeExistingDeliveryFile = removeExistingDeliveryFile;
  window.showVehicleDetails = showVehicleDetails;
  window.closeModal = closeModal;
</script>
</body>
</html>
