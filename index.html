<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage HR - Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary: #8b0000;   /* rouge fonc√© */
      --secondary: #333333; /* gris pur */
      --accent: #e74c3c;
      --light: #ffffff;
      --muted: #f5f5f5;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #c0392b;
      --glass: rgba(255,255,255,0.06);
    }

    /* Reset & base */
    *{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:var(--muted);color:var(--secondary);line-height:1.4}
    .container{display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:250px;
      background:var(--primary);
      color:var(--light);
      position:fixed;left:0;top:0;bottom:0;padding:18px 12px;
      display:flex;flex-direction:column;gap:6px;
      z-index:1000;
      transition:transform 0.3s ease;
    }
    .logo{font-weight:700;font-size:1.1rem;text-align:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .menu-item{
      display:flex;gap:10px;align-items:center;padding:12px;border-radius:8px;cursor:pointer;color:var(--light);
      transition:background .18s, transform .08s;
    }
    .menu-item i{font-size:18px}
    .menu-item span{font-weight:600}
    .menu-item:hover{background:rgba(255,255,255,0.06);transform:translateY(-1px)}
    .menu-item.active{background:var(--secondary);color:var(--light)}

    /* Main content */
    .main-content{
      margin-left:250px;flex:1;padding:20px 26px;
      transition:margin-left 0.3s ease;
    }
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;border-bottom:1px solid #eee;padding-bottom:12px;flex-wrap:wrap}
    .header h1{font-size:1.25rem;color:var(--secondary)}
    .header-controls{display:flex;gap:10px;align-items:center}
    .header-controls input{padding:10px;border-radius:6px;border:1px solid #ddd;width:260px}
    .mobile-menu-btn{display:none;font-size:1.5rem;cursor:pointer}

    /* Stats cards */
    .stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin:18px 0}
    .stat-card{background:var(--light);border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06);text-align:center}
    .stat-card h3{color:var(--primary);margin-bottom:10px;font-size:0.9rem}
    .stat-card .number{font-size:28px;color:var(--secondary);font-weight:700}

    /* Form sections */
    .form-section{background:var(--light);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:18px}
    .form-section h2{margin-bottom:12px;color:var(--primary);padding-bottom:8px;border-bottom:1px solid #f2f2f2}
    .form-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px}
    .form-group{flex:1 1 260px;min-width:180px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--secondary)}
    .form-group input,.form-group select,.form-group textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;font-size:14px;background:#fff;color:var(--secondary)
    }
    .form-group textarea{min-height:90px;resize:vertical}
    .select-hint{font-size:12px;color:#666;margin-top:6px}

    /* Nouveau style pour les fichiers de bons de livraison */
    .delivery-files-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .delivery-file-item {
      text-align: center;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9f9;
    }
    .delivery-file-preview {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .delivery-file-name {
      font-size: 0.8rem;
      word-break: break-word;
    }
    .remove-delivery-file {
      color: #e74c3c;
      cursor: pointer;
      font-size: 0.8rem;
      margin-top: 5px;
    }

    /* Buttons */
    .btn{cursor:pointer;border-radius:8px;padding:10px 14px;font-weight:700;border:none;transition:all 0.2s}
    .btn-primary{background:var(--primary);color:var(--light)}
    .btn-primary:hover{background:var(--secondary)}
    .btn-sm{padding:6px 10px;font-size:0.85rem}
    .btn-edit{background:#3498db;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin-right:5px}
    .btn-delete{background:#e74c3c;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
    .btn-edit:hover{background:#2980b9}
    .btn-delete:hover{background:#c0392b}

    /* Tables */
    .data-table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      table-layout: fixed;
    }
    .data-table th,.data-table td{
      padding:12px 10px;
      border-bottom:1px solid #f0f0f0;
      text-align:left;
      vertical-align: top;
    }
    .data-table th{background:transparent;color:var(--secondary);font-weight:700}
    .data-table tr:hover{background:#fafafa}
    
    .data-table th:nth-child(1),
    .data-table td:nth-child(1) {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }
    .data-table th:nth-child(2),
    .data-table td:nth-child(2) {
      width: 120px;
      min-width: 120px;
    }
    .data-table th:nth-child(6),
    .data-table td:nth-child(6) {
      width: 150px;
      min-width: 150px;
    }

    .btn-details {
  background: #27ae60;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 5px;
}

.btn-details:hover {
  background: #219653;
}

.action-buttons {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}

/* Pour le responsive */
@media (max-width: 768px) {
  .action-buttons {
    flex-direction: column;
  }
  
  .btn-details, .btn-edit, .btn-delete {
    width: 100%;
    margin: 2px 0;
    text-align: center;
  }
}

    /* CORRECTION AFFICHAGE MOBILE INTERVENTIONS */
    @media (max-width: 768px){
      .mobile-menu-btn{display:block}
      .sidebar{transform:translateX(-100%);width:280px}
      .sidebar.open{transform:translateX(0)}
      .main-content{margin-left:0;padding:12px}
      .main-content.sidebar-open{margin-left:280px}
      
      .stats-cards{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:12px 0}
      .stat-card{padding:12px}
      .stat-card .number{font-size:24px}
      
      .header{flex-direction:column;align-items:flex-start;gap:10px}
      .header-controls{width:100%;flex-direction:column;gap:8px}
      .header-controls input{width:100%}
      .quick-actions{width:100%;justify-content:center}
      
      .form-group{min-width:100%}
      .form-section{padding:12px;margin-bottom:12px}
      .form-row{gap:12px;margin-bottom:10px}
      
      .data-table{font-size:0.85rem; table-layout: auto;}
      .data-table th,.data-table td{padding:8px 6px}
      
      /* CORRECTION : Meilleur affichage mobile pour les interventions */
      .data-table.interventions-table td:nth-child(4), /* M√©caniciens */
      .data-table.interventions-table td:nth-child(5) { /* Bons livraison */
        display: block;
        width: 100% !important;
        padding: 8px 5px;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .data-table.interventions-table td:nth-child(4)::before {
        content: "M√©caniciens: ";
        font-weight: bold;
        color: var(--primary);
      }
      
      .data-table.interventions-table td:nth-child(5)::before {
        content: "Livraison: ";
        font-weight: bold;
        color: var(--primary);
      }
      
      /* Masquer les en-t√™tes sur mobile pour les interventions */
      .data-table.interventions-table thead {
        display: none;
      }
      
      .data-table.interventions-table tbody tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
      }
      
      .data-table.interventions-table tbody td {
        display: block;
        text-align: left !important;
        width: 100% !important;
      }

      .data-table th:nth-child(1),
      .data-table td:nth-child(1),
      .data-table th:nth-child(2),
      .data-table td:nth-child(2),
      .data-table th:nth-child(6),
      .data-table td:nth-child(6) {
        width: auto;
        min-width: auto;
        max-width: none;
      }

      .stats-table th, 
      .stats-table td {
        padding: 8px 6px;
        font-size: 0.85rem;
      }
      
      .flux-container{grid-template-columns:1fr;gap:12px}
      .flux-column{padding:12px}
      
      .search-filters{grid-template-columns:1fr;gap:10px}
      
      .vehicle-photo{width:80px !important;height:60px !important}
      .delivery-photo{width:60px;height:45px}
      
      .action-buttons{display:flex;flex-direction:column;gap:5px}
      .btn-edit, .btn-delete{width:100%;margin:2px 0;text-align:center}
    }

    /* Am√©lioration de l'affichage des m√©caniciens */
    .mechanics-list {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mechanics-list:hover {
      white-space: normal;
      overflow: visible;
    }

    /* Am√©lioration de l'affichage des images de bons de livraison */
    .delivery-photos-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      max-width: 150px;
    }

    .delivery-photo {
      width: 40px;
      height: 30px;
      object-fit: cover;
      border-radius: 3px;
      border: 1px solid #ddd;
    }

    /* Correction pour les statistiques des types d'interventions */
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .stats-table th, 
    .stats-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      text-align: left;
    }
    .stats-table th {
      background: #f8f9fa;
      color: var(--primary);
      font-weight: 700;
      border-bottom: 2px solid var(--primary);
    }
    .stats-table tr:hover {
      background: #fafafa;
    }
    .stats-table td {
      padding: 15px;
    }
    .stats-table td:nth-child(1) {
      font-weight: 600;
      color: var(--secondary);
    }
    .stats-table td:nth-child(2) {
      text-align: center;
      font-weight: 700;
      color: var(--primary);
    }
    .stats-table td:nth-child(3) {
      text-align: center;
      font-weight: 600;
      color: #27ae60;
    }

    /* Barre de progression pour visualiser les pourcentages */
    .percentage-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      margin-top: 5px;
      overflow: hidden;
    }
    .percentage-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Correction pour les images de v√©hicules */
    .vehicle-photo {
      width: 100px !important;
      height: 70px !important;
      object-fit: cover !important;
      border-radius: 6px;
      display: block;
      background-color: #f5f5f5;
      border: 1px solid #e0e0e0;
      transition: none !important;
      animation: none !important;
    }

    /* Images des bons de livraison */
    .delivery-photo {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
      margin: 2px;
    }

    /* Container pour stabiliser l'image */
    .vehicle-image-container {
      width: 100px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f5f5f5;
      border-radius: 6px;
      overflow: hidden;
    }

    /* Status badges */
    .status-badge{padding:6px 10px;border-radius:20px;font-weight:700;font-size:13px;display:inline-block}
    .status-en-cours{background:#ffeaa7;color:#d35400}
    .status-termine{background:#d1f7c4;color:#27ae60}
    .status-en-attente{background:#f1f2f6;color:#636e72}

    /* small helpers */
    .form-actions{margin-top:10px;display:flex;gap:10px;align-items:center}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Notification */
    .notification{
      position:fixed;right:20px;top:20px;padding:12px 16px;border-radius:8px;color:#fff;background:var(--success);box-shadow:0 8px 24px rgba(0,0,0,0.12);transform:translateX(120%);transition:transform 260ms ease;z-index:9999
    }
    .notification.show{transform:translateX(0)}
    .notification.error{background:var(--danger)}

    /* Search section */
    .search-filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:15px}

    /* Flux section */
    .flux-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px}
    .flux-column{background:var(--light);border-radius:10px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    .flux-column h3{color:var(--primary);margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid #eee}
    .flux-item{background:#f9f9f9;border-radius:6px;padding:10px;margin-bottom:8px;border-left:4px solid var(--primary)}
    .flux-item.entree{border-left-color:var(--success)}
    .flux-item.sortie{border-left-color:var(--warning)}
    .flux-item-header{display:flex;justify-content:space-between;margin-bottom:5px}
    .flux-item-title{font-weight:600}
    .flux-item-details{font-size:0.85rem;color:#666}

    /* Photo preview */
    .photo-preview{width:120px;height:90px;border-radius:6px;object-fit:cover;border:2px dashed #ddd;display:block;margin-top:5px}

    /* RESPONSIVE AM√âLIOR√â */
    @media (max-width: 1200px){
      .main-content{padding:15px 20px}
      .stats-cards{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
    }

    @media (max-width: 992px){
      .sidebar{width:200px}
      .main-content{margin-left:200px;padding:15px}
      .form-section{padding:15px}
      .header-controls input{width:200px}
    }

    @media (max-width: 480px){
      .main-content{padding:10px}
      .form-section{padding:10px;margin-bottom:10px}
      .form-row{gap:10px;margin-bottom:8px}
      
      .stats-cards{grid-template-columns:1fr 1fr;gap:10px}
      .stat-card{padding:10px}
      .stat-card .number{font-size:20px}
      .stat-card h3{font-size:0.8rem}
      
      .header h1{font-size:1.1rem}
      .header-controls{gap:6px}
      
      .data-table{font-size:0.8rem}
      .data-table th,.data-table td{padding:6px 4px}
      
      .stats-table{font-size:0.8rem}
      .stats-table th, 
      .stats-table td{padding:6px 4px}
      
      .data-table th:nth-child(4), 
      .data-table td:nth-child(4) {
        display: none;
      }
      
      .modal-content{width:95%;padding:15px;margin:10px}
      
      .form-group textarea{min-height:70px}
      
      .menu-item{padding:10px 8px;font-size:0.9rem}
    }

    @media (max-width: 360px){
      .stats-cards{grid-template-columns:1fr;gap:8px}
      .data-table{font-size:0.75rem}
      .btn{padding:8px 12px;font-size:0.9rem}
      .form-section h2{font-size:1.1rem}
    }

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;justify-content:center;align-items:center}
    .modal-content{background:white;border-radius:10px;padding:20px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:10px}
    .modal-close{font-size:1.5rem;cursor:pointer;color:#999}
    .modal-close:hover{color:#333}

    /* Quick actions */
    .quick-actions{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
    .quick-action-btn{background:var(--light);border:1px solid #ddd;border-radius:6px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all 0.2s}
    .quick-action-btn:hover{background:#f0f0f0;transform:translateY(-2px)}
  </style>
</head>
  
<body>
  <div id="notification" class="notification"></div>

  <!-- Modal pour modifier les interventions -->
  <div id="intervention-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Modifier l'intervention</h2>
        <span class="modal-close">&times;</span>
      </div>
      <form id="edit-intervention-form">
        <input type="hidden" id="edit-intervention-id">
        <div class="form-row">
          <div class="form-group">
            <label for="edit-vehicule-intervention">V√©hicule</label>
            <select id="edit-vehicule-intervention" required>
              <option value="">S√©lectionner un v√©hicule</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-date-intervention">Date</label>
            <input type="date" id="edit-date-intervention" required />
          </div>

          <div class="form-group">
            <label for="edit-type-intervention">Type d'intervention</label>
            <input list="edit-types-intervention" id="edit-type-intervention" placeholder="Choisissez ou √©crivez un type" required />
            <datalist id="edit-types-intervention">
              <option value="Vidange">
              <option value="R√©paration">
              <option value="Contr√¥le technique">
              <option value="Carrosserie">
              <option value="√âlectricit√©">
            </datalist>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-mecaniciens">M√©caniciens (s√©lection multiple)</label>
            <select id="edit-mecaniciens" multiple>
              <option value="1">YOBOUET SYLVIN</option>
              <option value="2">KHALIL HUSSEIN</option>
              <option value="3">NIANKINE YOUSSOUF</option>
              <option value="4">OUATTARA ISSIF</option>
              <option value="5">BABA DRAMANE</option>
              <option value="6">KONE SAIDOU</option>
              <option value="7">TRAORE ABDELATIF</option>
              <option value="8">KOUAME K WILLIAM</option>
              <option value="9">DIABATE HASSAN</option>
              <option value="10">MOHAMED</option>
              <option value="11">MANBONNE A AZIZ</option>
              <option value="12">TOUVOLI KEVIN</option>
              <option value="13">TOURE OTHNIEL</option>
              <option value="14">VEHI EBENEZER</option>
            </select>
            <div class="select-hint">Ctrl/Cmd + clic pour multi-s√©lection (ou appuyez longuement sur mobile)</div>
          </div>

          <div class="form-group">
            <label for="edit-pieces">Pi√®ces utilis√©es</label>
            <textarea id="edit-pieces" placeholder="Liste des pi√®ces utilis√©es..."></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-bons-livraison">Bons de livraison (photos)</label>
            <input type="file" id="edit-bons-livraison" accept="image/*" multiple />
            <div class="select-hint">Vous pouvez s√©lectionner plusieurs photos</div>
            <div id="edit-delivery-files-preview" class="delivery-files-container"></div>
          </div>

          <div class="form-group">
            <label for="edit-statut">Statut</label>
            <select id="edit-statut" required>
              <option value="en-attente">En attente</option>
              <option value="en-cours">En cours</option>
              <option value="termine">Termin√©</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-observations">Observations</label>
            <textarea id="edit-observations" placeholder="Observations..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Modifier l'intervention</button>
          <button type="button" id="cancel-edit" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>
<!-- Modal pour les d√©tails d'intervention -->
<div id="details-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>D√©tails de l'intervention</h2>
      <span class="modal-close" onclick="closeDetailsModal()">&times;</span>
    </div>
    <div id="intervention-details-content">
      <!-- Le contenu sera charg√© dynamiquement -->
    </div>
  </div>
</div>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigation principale">
      <div class="logo"><span> HR MOTORS</span></div>

      <nav class="nav">
        <div class="menu-item active" data-tab="dashboard"><i class="fas fa-chart-bar"></i><span>Tableau de bord</span></div>
        <div class="menu-item" data-tab="vehicles"><i class="fas fa-car"></i><span>V√©hicules</span></div>
        <div class="menu-item" data-tab="interventions"><i class="fas fa-tools"></i><span>Interventions</span></div>
        <div class="menu-item" data-tab="flux"><i class="fas fa-exchange-alt"></i><span>Flux v√©hicules</span></div>
        <div class="menu-item" data-tab="search"><i class="fas fa-search"></i><span>Recherche</span></div>
        <div class="menu-item" data-tab="stats"><i class="fas fa-chart-line"></i><span>Statistiques</span></div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <header class="header">
        <div class="mobile-menu-btn">
          <i class="fas fa-bars"></i>
        </div>
        <h1>Tableau de Bord - Garage HR</h1>
        <div class="header-controls">
          <input type="text" id="global-search" placeholder="Rechercher..." />
          <div class="quick-actions">
            <div class="quick-action-btn" id="quick-add-vehicle">
              <i class="fas fa-plus"></i> V√©hicule
            </div>
            <div class="quick-action-btn" id="quick-add-intervention">
              <i class="fas fa-wrench"></i> Intervention
            </div>
          </div>
        </div>
      </header>

      <!-- Dashboard -->
      <section id="dashboard-tab" class="tab-content active">
        <div class="stats-cards">
          <div class="stat-card">
            <h3>V√©hicules en garage</h3>
            <div class="number" id="vehicles-count">0</div>
          </div>
          <div class="stat-card">
            <h3>Interventions aujourd'hui</h3>
            <div class="number" id="interventions-today">0</div>
          </div>
          <div class="stat-card">
            <h3>V√©hicules entr√©s aujourd'hui</h3>
            <div class="number" id="vehicles-entered-today">0</div>
          </div>
          <div class="stat-card">
            <h3>V√©hicules sortis aujourd'hui</h3>
            <div class="number" id="vehicles-exited-today">0</div>
          </div>
        </div>
        <!-- Dans la section dashboard-tab, remplacez la div form-section existante par : -->
<div class="form-section">
  <h2>Journal complet des v√©hicules - <?php echo date('d/m/Y'); ?></h2>
  <div class="form-row">
    <div class="form-group">
      <label for="journal-date">S√©lectionner une date</label>
      <input type="date" id="journal-date" value="<?php echo date('Y-m-d'); ?>" />
    </div>
  </div>
  <table class="data-table">
    <thead>
      <tr>
        <th>Date</th><th>V√©hicule</th><th>Intervention</th><th>M√©caniciens</th><th>Statut</th><th>Type op√©ration</th>
      </tr>
    </thead>
    <tbody id="journal-complet"></tbody>
  </table>
</div>

<div class="form-section">
  <h2>Statut du garage</h2>
  <div class="stats-cards">
    <div class="stat-card">
      <h3>V√©hicules au garage</h3>
      <div class="number" id="vehicles-in-garage">0</div>
    </div>
    <div class="stat-card">
      <h3>V√©hicules entr√©s aujourd'hui</h3>
      <div class="number" id="vehicles-entered-today">0</div>
    </div>
    <div class="stat-card">
      <h3>V√©hicules sortis aujourd'hui</h3>
      <div class="number" id="vehicles-exited-today">0</div>
    </div>
    <div class="stat-card">
      <h3>Solde journalier</h3>
      <div class="number" id="daily-balance">0</div>
    </div>
  </div>
</div>
        <!-- <div class="form-section">
          <h2>Activit√© r√©cente</h2>
          <table class="data-table">
            <thead>
              <tr>
                <th>V√©hicule</th><th>Intervention</th><th>M√©canicien</th><th>Date</th><th>Statut</th>
              </tr>
            </thead>
            <tbody id="recent-activity"></tbody>
          </table>
        </div> -->
      </section>

      <!-- Vehicles -->
      <section id="vehicles-tab" class="tab-content">
        <div class="form-section">
          <h2>Nouveau V√©hicule</h2>
          <form id="vehicle-form">
            <div class="form-row">
              <div class="form-group">
                <label for="immatriculation">Immatriculation</label>
                <input type="text" id="immatriculation" required />
              </div>
              <div class="form-group">
                <label for="modele">Mod√®le</label>
                <input type="text" id="modele" required />
              </div>
              <div class="form-group">
                <label for="couleur">Couleur</label>
                <input type="text" id="couleur" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="photo">Photo du v√©hicule</label>
                <input type="file" id="photo" accept="image/*" />
                <img id="photo-preview" class="photo-preview" src="" alt="Aper√ßu de la photo" style="display:none" />
              </div>
              <div class="form-group">
                <label for="proprietaire">Propri√©taire</label>
                <input type="text" id="proprietaire" />
              </div>
              <div class="form-group">
                <label for="telephone">T√©l√©phone</label>
                <input type="tel" id="telephone" />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Enregistrer le v√©hicule</button>
              <button type="button" id="cancel-edit-vehicle" class="btn" style="display:none">Annuler</button>
            </div>
          </form>
        </div>

        <div class="form-section">
          <h2>Liste des V√©hicules</h2>
          <table class="data-table">
            <thead>
              <tr><th>Photo</th><th>Immatriculation</th><th>Mod√®le</th><th>Couleur</th><th>Propri√©taire</th><th>Actions</th></tr>
            </thead>
            <tbody id="vehicles-list"></tbody>
          </table>
        </div>
      </section>

      <!-- Interventions -->
      <section id="interventions-tab" class="tab-content">
        <div class="form-section">
          <h2>Nouvelle Intervention</h2>
          <form id="intervention-form">
            <div class="form-row">
              <div class="form-group">
                <label for="vehicule-intervention">V√©hicule</label>
                <select id="vehicule-intervention" required>
                  <option value="">S√©lectionner un v√©hicule</option>
                </select>
              </div>

              <div class="form-group">
                <label for="date-intervention">Date</label>
                <input type="date" id="date-intervention" required />
              </div>

              <div class="form-group">
                <label for="type-intervention">Type d'intervention (choisir ou √©crire)</label>
                <input list="types-intervention" id="type-intervention" placeholder="Choisissez ou √©crivez un type" required />
                <datalist id="types-intervention">
                  <option value="Vidange">
                  <option value="R√©paration">
                  <option value="Contr√¥le technique">
                  <option value="Carrosserie">
                  <option value="√âlectricit√©">
                </datalist>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="mecaniciens">M√©caniciens (s√©lection multiple)</label>
                <select id="mecaniciens" multiple>
                  <option value="1">YOBOUET SYLVIN</option>
                  <option value="2">KHALIL HUSSEIN</option>
                  <option value="3">NIANKINE YOUSSOUF</option>
                  <option value="4">OUATTARA ISSIF</option>
                  <option value="5">BABA DRAMANE</option>
                  <option value="6">KONE SAIDOU</option>
                  <option value="7">TRAORE ABDELATIF</option>
                  <option value="8">KOUAME K WILLIAM</option>
                  <option value="9">DIABATE HASSAN</option>
                  <option value="10">MOHAMED</option>
                  <option value="11">MANBONNE A AZIZ</option>
                  <option value="12">TOUVOLI KEVIN</option>
                  <option value="13">TOURE OTHNIEL</option>
                  <option value="14">VEHI EBENEZER</option>
                </select>
                <div class="select-hint">Ctrl/Cmd + clic pour multi-s√©lection (ou appuyez longuement sur mobile)</div>
              </div>

              <div class="form-group">
                <label for="pieces">Pi√®ces utilis√©es</label>
                <textarea id="pieces" placeholder="Liste des pi√®ces utilis√©es..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="bons-livraison">Bons de livraison (photos)</label>
                <input type="file" id="bons-livraison" accept="image/*" multiple />
                <div class="select-hint">Vous pouvez s√©lectionner plusieurs photos</div>
                <div id="delivery-files-preview" class="delivery-files-container"></div>
              </div>

              <div class="form-group">
                <label for="statut">Statut</label>
                <select id="statut" required>
                  <option value="en-attente">En attente</option>
                  <option value="en-cours">En cours</option>
                  <option value="termine">Termin√©</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="observations">Observations</label>
                <textarea id="observations" placeholder="Observations..."></textarea>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Enregistrer l'intervention</button>
            </div>
          </form>
        </div>

        <div class="form-section">
          <h2>Interventions R√©centes</h2>
          <table class="data-table interventions-table">
            <thead>
              <tr><th>V√©hicule</th><th>Date</th><th>Type</th><th>M√©caniciens</th><th>Statut</th><th>Actions</th></tr>
            </thead>
            <tbody id="interventions-list"></tbody>
          </table>
        </div>
      </section>

      <!-- Flux v√©hicules -->
      <section id="flux-tab" class="tab-content">
        <div class="form-section">
          <h2>Flux des v√©hicules - Aujourd'hui</h2>
          <div class="flux-container">
            <div class="flux-column">
              <h3>V√©hicules entr√©s aujourd'hui</h3>
              <div id="flux-entrees"></div>
            </div>
            <div class="flux-column">
              <h3>V√©hicules en cours de r√©paration</h3>
              <div id="flux-en-cours"></div>
            </div>
            <div class="flux-column">
              <h3>V√©hicules sortis aujourd'hui</h3>
              <div id="flux-sorties"></div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>Historique des flux</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="flux-date">S√©lectionner une date</label>
              <input type="date" id="flux-date" />
            </div>
          </div>
          <div id="flux-historique"></div>
        </div>
      </section>

      <!-- Search -->
      <section id="search-tab" class="tab-content">
        <div class="form-section">
          <h2>Recherche avanc√©e</h2>
          <div class="search-filters">
            <input type="text" id="search-immatriculation" placeholder="Immatriculation" />
            <input type="text" id="search-modele" placeholder="Mod√®le" />
            <input type="text" id="search-couleur" placeholder="Couleur" />
            <input type="date" id="search-date" />
            <select id="search-type">
              <option value="">Type d'intervention</option>
              <option value="Vidange">Vidange</option>
              <option value="R√©paration">R√©paration</option>
              <option value="Contr√¥le technique">Contr√¥le technique</option>
              <option value="Carrosserie">Carrosserie</option>
              <option value="√âlectricit√©">√âlectricit√©</option>
            </select>
            <select id="search-statut">
              <option value="">Statut</option>
              <option value="en-attente">En attente</option>
              <option value="en-cours">En cours</option>
              <option value="termine">Termin√©</option>
            </select>
          </div>
          <div class="form-actions">
            <button id="search-button" class="btn btn-primary">Rechercher</button>
            <button id="reset-search" class="btn">R√©initialiser</button>
          </div>
        </div>

        <div class="form-section">
          <h2>R√©sultats de la Recherche</h2>
          <div id="search-results-count"></div>
          <table class="data-table">
            <thead>
              <tr><th>Photo</th><th>Immatriculation</th><th>Mod√®le</th><th>Couleur</th><th>Propri√©taire</th><th>Derni√®re intervention</th><th>Statut</th></tr>
            </thead>
            <tbody id="search-results"></tbody>
          </table>
        </div>
      </section>

      <!-- Stats -->
      <section id="stats-tab" class="tab-content">
        <div class="form-section">
          <h2>Statistiques des interventions</h2>
          <div class="stats-cards">
            <div class="stat-card">
              <h3>Total interventions</h3>
              <div class="number" id="total-interventions">0</div>
            </div>
            <div class="stat-card">
              <h3>Vidanges ce mois</h3>
              <div class="number" id="month-oil-changes">0</div>
            </div>
            <div class="stat-card">
              <h3>Taux de completion</h3>
              <div class="number" id="completion-rate">0%</div>
            </div>
            <div class="stat-card">
              <h3>V√©hicules en attente</h3>
              <div class="number" id="vehicles-waiting">0</div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>R√©parations par m√©canicien</h2>
          <table class="stats-table">
            <thead><tr><th>M√©canicien</th><th>Interventions</th><th>En cours</th><th>Termin√©es</th><th>Taux de r√©ussite</th></tr></thead>
            <tbody id="mechanics-stats"></tbody>
          </table>
        </div>

        <div class="form-section">
          <h2>Types d'interventions les plus courants</h2>
          <table class="stats-table">
            <thead><tr><th>Type d'intervention</th><th>Nombre</th><th>Pourcentage</th><th>Visualisation</th></tr></thead>
            <tbody id="intervention-types-stats"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
<script>
  // Configuration Supabase
  const supabaseUrl = 'https://xexmwdaeoxizvqecrmlo.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhleG13ZGFlb3hpenZxZWNybWxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTg5OTAsImV4cCI6MjA3NDI3NDk5MH0.nrMn4X0KFJISudffGDJZ0SM7XxKD2wOG2xOUMNsnWQo';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // Local state
  let vehicles = [];
  let interventions = [];
  let currentEditingInterventionId = null;
  let deliveryFiles = [];

  // DOM elems
  const notification = document.getElementById('notification');

  // Test de connexion Supabase Storage
  async function testSupabaseStorage() {
    console.log("üîß Test de connexion Supabase Storage...");
    
    try {
      const testFile = new File(['test'], 'test.txt', { type: 'text/plain' });
      
      // Test du bucket vehicles
      const { error: vehiclesError } = await supabase.storage
        .from('vehicles')
        .upload('test-file.txt', testFile);
      
      if (vehiclesError) {
        console.error("‚ùå Erreur bucket vehicles:", vehiclesError.message);
      } else {
        console.log("‚úÖ Bucket vehicles OK");
        // Supprimer le fichier test
        await supabase.storage.from('vehicles').remove(['test-file.txt']);
      }
      
      // Test du bucket delivery
      const { error: deliveryError } = await supabase.storage
        .from('delivery')
        .upload('test-file.txt', testFile);
      
      if (deliveryError) {
        console.error("‚ùå Erreur bucket delivery:", deliveryError.message);
      } else {
        console.log("‚úÖ Bucket delivery OK");
        // Supprimer le fichier test
        await supabase.storage.from('delivery').remove(['test-file.txt']);
      }
      
    } catch (error) {
      console.error("‚ùå Erreur g√©n√©rale storage:", error);
    }
  }

  // Init when DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    testSupabaseStorage(); // Test au chargement
    initApp();
    loadData();
    setupEventListeners();
  });

  function initApp(){
    // set default date
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('date-intervention');
    const fluxDateInput = document.getElementById('flux-date');
    if(dateInput) dateInput.value = today;
    if(fluxDateInput) fluxDateInput.value = today;
    
    // Initialize photo preview
    const photoInput = document.getElementById('photo');
    if(photoInput) {
      photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('photo-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Initialize delivery files preview
    const deliveryInput = document.getElementById('bons-livraison');
    const editDeliveryInput = document.getElementById('edit-bons-livraison');
    
    if(deliveryInput) {
      deliveryInput.addEventListener('change', handleDeliveryFiles);
    }
    if(editDeliveryInput) {
      editDeliveryInput.addEventListener('change', handleEditDeliveryFiles);
    }
  }
// Fonction pour mettre √† jour le journal complet
function updateJournalComplet() {
  const date = document.getElementById('journal-date').value || new Date().toISOString().split('T')[0];
  const container = document.getElementById('journal-complet');
  container.innerHTML = '';

  // Filtrer les interventions pour la date s√©lectionn√©e
  const dailyInterventions = interventions.filter(i => i.date === date);
  
  if (dailyInterventions.length === 0) {
    container.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucune activit√© pour cette date</td></tr>';
    return;
  }

  // Trier par date/heure (vous devriez ajouter un champ heure dans votre base)
  dailyInterventions.sort((a, b) => new Date(a.created_at || a.date) - new Date(b.created_at || b.date));

  dailyInterventions.forEach(intervention => {
    const vehicle = vehicles.find(v => v.id === intervention.vehicule_id);
    if (!vehicle) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatDateTime(intervention.created_at || intervention.date)}</td>
      <td><strong>${vehicle.immatriculation}</strong><br><small>${vehicle.modele}</small></td>
      <td>${intervention.type}</td>
      <td class="mechanics-list">${intervention.mecaniciens.join(', ')}</td>
      <td><span class="status-badge status-${intervention.statut}">${intervention.statut}</span></td>
      <td>${getOperationType(intervention)}</td>
    `;
    container.appendChild(tr);
  });

  updateGarageStatus(date);
}

// Fonction pour afficher les d√©tails d'une intervention
function showInterventionDetails(interventionId) {
  const intervention = interventions.find(i => i.id === interventionId);
  if (!intervention) return;

  const vehicle = vehicles.find(v => v.id === intervention.vehicule_id);
  if (!vehicle) return;

  const detailsContent = document.getElementById('intervention-details-content');
  detailsContent.innerHTML = `
    <div class="form-row">
      <div class="form-group">
        <label><strong>V√©hicule:</strong></label>
        <p>${vehicle.immatriculation} - ${vehicle.modele} (${vehicle.couleur})</p>
      </div>
      <div class="form-group">
        <label><strong>Propri√©taire:</strong></label>
        <p>${vehicle.proprietaire || 'Non renseign√©'}</p>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label><strong>Date de l'intervention:</strong></label>
        <p>${formatDate(intervention.date)}</p>
      </div>
      <div class="form-group">
        <label><strong>Type d'intervention:</strong></label>
        <p>${intervention.type}</p>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label><strong>M√©caniciens:</strong></label>
        <p>${intervention.mecaniciens.join(', ')}</p>
      </div>
      <div class="form-group">
        <label><strong>Statut:</strong></label>
        <p><span class="status-badge status-${intervention.statut}">${intervention.statut}</span></p>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label><strong>Pi√®ces utilis√©es:</strong></label>
        <p>${intervention.pieces || 'Aucune pi√®ce renseign√©e'}</p>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label><strong>Observations:</strong></label>
        <p>${intervention.observations || 'Aucune observation'}</p>
      </div>
    </div>

    ${intervention.delivery_files && intervention.delivery_files.length > 0 ? `
    <div class="form-row">
      <div class="form-group">
        <label><strong>Bons de livraison:</strong></label>
        <div class="delivery-photos-container">
          ${intervention.delivery_files.map(url => 
            `<img src="${url}" class="delivery-photo" alt="Bon de livraison" onclick="openImageModal('${url}')">`
          ).join('')}
        </div>
      </div>
    </div>
    ` : ''}
  `;

  document.getElementById('details-modal').style.display = 'flex';
}

// Fonction pour fermer le modal des d√©tails
function closeDetailsModal() {
  document.getElementById('details-modal').style.display = 'none';
}

// Fonction pour agrandir les images
function openImageModal(imageUrl) {
  // Vous pouvez ajouter un modal pour agrandir les images si n√©cessaire
  window.open(imageUrl, '_blank');
}
// Fonction pour d√©terminer le type d'op√©ration
function getOperationType(intervention) {
  switch(intervention.statut) {
    case 'en-attente': return 'Entr√©e au garage';
    case 'en-cours': return 'En r√©paration';
    case 'termine': return 'Sortie du garage';
    default: return intervention.statut;
  }
}

// Fonction pour calculer le statut du garage
function updateGarageStatus(date) {
  const todayInterventions = interventions.filter(i => i.date === date);
  
  // V√©hicules entr√©s (premi√®re intervention de la journ√©e)
  const vehiclesEntered = todayInterventions
    .map(i => i.vehicule_id)
    .filter((v, i, a) => a.indexOf(v) === i);

  // V√©hicules sortis (interventions termin√©es)
  const vehiclesExited = todayInterventions
    .filter(i => i.statut === 'termine')
    .map(i => i.vehicule_id)
    .filter((v, i, a) => a.indexOf(v) === i);

  // V√©hicules restants au garage
  const vehiclesInGarage = vehiclesEntered.length - vehiclesExited.length;

  // Mettre √† jour l'interface
  document.getElementById('vehicles-in-garage').textContent = Math.max(0, vehiclesInGarage);
  document.getElementById('vehicles-entered-today').textContent = vehiclesEntered.length;
  document.getElementById('vehicles-exited-today').textContent = vehiclesExited.length;
  document.getElementById('daily-balance').textContent = vehiclesInGarage;
}

// Fonction pour formater la date et heure
function formatDateTime(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
}
  // Gestion des fichiers de bons de livraison
  function handleDeliveryFiles(e) {
    const files = Array.from(e.target.files);
    const previewContainer = document.getElementById('delivery-files-preview');
    previewContainer.innerHTML = '';
    
    files.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${e.target.result}" class="delivery-file-preview" alt="Aper√ßu bon de livraison">
          <div class="delivery-file-name">${file.name}</div>
          <div class="remove-delivery-file" onclick="removeDeliveryFile(${index})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      };
      reader.readAsDataURL(file);
    });
    
    deliveryFiles = files;
  }

  function handleEditDeliveryFiles(e) {
    const files = Array.from(e.target.files);
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    
    files.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${e.target.result}" class="delivery-file-preview" alt="Aper√ßu bon de livraison">
          <div class="delivery-file-name">${file.name}</div>
          <div class="remove-delivery-file" onclick="removeEditDeliveryFile(${index})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      };
      reader.readAsDataURL(file);
    });
    
    deliveryFiles = [...deliveryFiles, ...files];
  }

  function removeDeliveryFile(index) {
    deliveryFiles.splice(index, 1);
    const previewContainer = document.getElementById('delivery-files-preview');
    previewContainer.innerHTML = '';
    
    deliveryFiles.forEach((file, newIndex) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${e.target.result}" class="delivery-file-preview" alt="Aper√ßu bon de livraison">
          <div class="delivery-file-name">${file.name}</div>
          <div class="remove-delivery-file" onclick="removeDeliveryFile(${newIndex})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      };
      reader.readAsDataURL(file);
    });
  }

  function removeEditDeliveryFile(index) {
    deliveryFiles.splice(index, 1);
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    previewContainer.innerHTML = '';
    
    deliveryFiles.forEach((file, newIndex) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${e.target.result}" class="delivery-file-preview" alt="Aper√ßu bon de livraison">
          <div class="delivery-file-name">${file.name}</div>
          <div class="remove-delivery-file" onclick="removeEditDeliveryFile(${newIndex})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      };
      reader.readAsDataURL(file);
    });
  }

  // Load from Supabase
  async function loadData(){
    try {
      // Charger les v√©hicules
      const { data: vehiclesData, error: vehiclesError } = await supabase
        .from('vehicles')
        .select('*');
      
      if (vehiclesError) throw vehiclesError;
      vehicles = vehiclesData || [];

      // Charger les interventions
      const { data: interventionsData, error: interventionsError } = await supabase
        .from('interventions')
        .select('*');
      
      if (interventionsError) throw interventionsError;
      interventions = interventionsData || [];

      updateUI();
    } catch (err) {
      console.error("Load error", err);
      showNotification("Erreur de chargement des donn√©es", "error");
    }
  }

  function setupEventListeners(){
    // Mobile menu
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    // √âcouteur pour la date du journal
const journalDate = document.getElementById('journal-date');
if (journalDate) {
  journalDate.addEventListener('change', updateJournalComplet);
}
    
    if(mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        mainContent.classList.toggle('sidebar-open');
      });
    }

    // sidebar nav
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function(){
        switchTab(this.dataset.tab);
        document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
        this.classList.add('active');
        
        // Close mobile menu after selection
        if(window.innerWidth <= 768) {
          sidebar.classList.remove('open');
          mainContent.classList.remove('sidebar-open');
        }
      });
    });

    // forms
    const vehicleForm = document.getElementById('vehicle-form');
    if(vehicleForm) vehicleForm.addEventListener('submit', e => { e.preventDefault(); addVehicle(); });

    const interventionForm = document.getElementById('intervention-form');
    if(interventionForm) interventionForm.addEventListener('submit', e => { e.preventDefault(); addIntervention(); });

    const editInterventionForm = document.getElementById('edit-intervention-form');
    if(editInterventionForm) editInterventionForm.addEventListener('submit', e => { e.preventDefault(); updateIntervention(); });

    // search
    const searchBtn = document.getElementById('search-button');
    if(searchBtn) searchBtn.addEventListener('click', performSearch);

    const resetSearchBtn = document.getElementById('reset-search');
    if(resetSearchBtn) resetSearchBtn.addEventListener('click', resetSearch);

    const globalSearch = document.getElementById('global-search');
    if(globalSearch) globalSearch.addEventListener('input', e => performGlobalSearch(e.target.value));

    // flux date change
    const fluxDate = document.getElementById('flux-date');
    if(fluxDate) fluxDate.addEventListener('change', updateFlux);

    // quick actions
    const quickAddVehicle = document.getElementById('quick-add-vehicle');
    if(quickAddVehicle) quickAddVehicle.addEventListener('click', () => {
      switchTab('vehicles');
      document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
      document.querySelector('[data-tab="vehicles"]').classList.add('active');
    });

    const quickAddIntervention = document.getElementById('quick-add-intervention');
    if(quickAddIntervention) quickAddIntervention.addEventListener('click', () => {
      switchTab('interventions');
      document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
      document.querySelector('[data-tab="interventions"]').classList.add('active');
    });

    // modal close
    const modalClose = document.querySelector('.modal-close');
    const cancelEdit = document.getElementById('cancel-edit');
    const interventionModal = document.getElementById('intervention-modal');
    
    if(modalClose) modalClose.addEventListener('click', () => {
      interventionModal.style.display = 'none';
      currentEditingInterventionId = null;
      deliveryFiles = [];
    });
    
    if(cancelEdit) cancelEdit.addEventListener('click', () => {
      interventionModal.style.display = 'none';
      currentEditingInterventionId = null;
      deliveryFiles = [];
    });

    // cancel vehicle edit
    const cancelEditVehicle = document.getElementById('cancel-edit-vehicle');
    if(cancelEditVehicle) cancelEditVehicle.addEventListener('click', resetVehicleForm);
  }

  function switchTab(tabName){
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    const el = document.getElementById(tabName + '-tab');
    if(el) el.classList.add('active');
  }

  // Add vehicle - CORRIG√â
  async function addVehicle(){
    const immatriculation = document.getElementById('immatriculation').value.trim();
    const modele = document.getElementById('modele').value.trim();
    const couleur = document.getElementById('couleur').value.trim();
    const proprietaire = document.getElementById('proprietaire').value.trim();
    const telephone = document.getElementById('telephone').value.trim();
    const photoInput = document.getElementById('photo');
    const editingId = document.getElementById('vehicle-form').dataset.editingId;

    if(!immatriculation || !modele) { 
      showNotification("Immatriculation et mod√®le requis", "error"); 
      return; 
    }

    if (vehicles.some(v => v.immatriculation === immatriculation && v.id !== editingId)) {
      showNotification("Cette immatriculation est d√©j√† utilis√©e!", "error");
      return;
    }

    let photoUrl = 'https://via.placeholder.com/100x70?text=Vehicle';
    
    // UPLOAD PHOTO - CORRIG√â
    if(photoInput && photoInput.files && photoInput.files[0]) {
      try {
        const file = photoInput.files[0];
        const fileName = `${Date.now()}_${file.name}`;
        
        console.log("üì∏ Upload photo v√©hicule:", file.name);
        
        const { data, error } = await supabase.storage
          .from('vehicles')
          .upload(fileName, file);
        
        if (error) {
          console.error("‚ùå Erreur upload photo:", error);
          throw new Error(`Erreur upload photo: ${error.message}`);
        }
        
        if (data) {
          const { data: urlData } = supabase.storage
            .from('vehicles')
            .getPublicUrl(fileName);
          
          if (urlData && urlData.publicUrl) {
            photoUrl = urlData.publicUrl;
            console.log("‚úÖ Photo upload√©e:", photoUrl);
          }
        }
      } catch (error) {
        console.error("Error uploading image:", error);
        showNotification("Erreur photo: " + error.message, "error");
        return;
      }
    } else if (editingId) {
      const existingVehicle = vehicles.find(v => v.id === editingId);
      if (existingVehicle) {
        photoUrl = existingVehicle.photo;
      }
    }

    const vehicleData = {
      immatriculation, 
      modele, 
      couleur, 
      proprietaire, 
      telephone, 
      photo: photoUrl
    };

    try {
      if (editingId) {
        const { error } = await supabase
          .from('vehicles')
          .update(vehicleData)
          .eq('id', editingId);
        
        if (error) throw error;
        
        const index = vehicles.findIndex(v => v.id === editingId);
        if (index !== -1) {
          vehicles[index] = { ...vehicles[index], ...vehicleData };
        }
        
        showNotification("‚úÖ V√©hicule modifi√© avec succ√®s!");
      } else {
        const { data, error } = await supabase
          .from('vehicles')
          .insert([vehicleData])
          .select();
        
        if (error) throw error;
        
        if (data && data[0]) {
          vehicles.push(data[0]);
          showNotification("‚úÖ V√©hicule ajout√© avec succ√®s!");
        }
      }
      
      updateUI();
      resetVehicleForm();
    } catch (err) {
      console.error(err);
      showNotification("‚ùå Erreur: " + err.message, "error");
    }
  }

  // Fonction pour r√©initialiser le formulaire v√©hicule
  function resetVehicleForm() {
    document.getElementById('vehicle-form').reset();
    delete document.getElementById('vehicle-form').dataset.editingId;
    document.querySelector('#vehicle-form button[type="submit"]').textContent = 'Enregistrer le v√©hicule';
    document.getElementById('cancel-edit-vehicle').style.display = 'none';
    document.getElementById('photo-preview').style.display = 'none';
  }

  // Add intervention - CORRIG√â
  async function addIntervention(){
    const vehiculeId = document.getElementById('vehicule-intervention').value;
    const date = document.getElementById('date-intervention').value;
    const type = document.getElementById('type-intervention').value.trim();
    const mecaniciensElements = document.getElementById('mecaniciens');
    const pieces = document.getElementById('pieces').value.trim();
    const statut = document.getElementById('statut').value;
    const observations = document.getElementById('observations').value.trim();

    if(!vehiculeId){ showNotification("S√©lectionner un v√©hicule", "error"); return; }
    if(!date || !type){ showNotification("Date et type requis", "error"); return; }

    const mecaniciens = Array.from(mecaniciensElements.selectedOptions).map(o => o.text);
    const vehicle = vehicles.find(v => v.id == vehiculeId);
    if(!vehicle){ showNotification("V√©hicule introuvable", "error"); return; }

    // UPLOAD BONS LIVRAISON - CORRIG√â
    let deliveryUrls = [];
    if (deliveryFiles.length > 0) {
      try {
        console.log("üìÑ Upload de", deliveryFiles.length, "fichiers BL...");
        
        for (const file of deliveryFiles) {
          const fileName = `delivery/${Date.now()}_${file.name}`;
          
          console.log("üì§ Upload BL:", file.name);
          
          const { data, error } = await supabase.storage
            .from('delivery')
            .upload(fileName, file);
          
          if (error) {
            console.error("‚ùå Erreur upload BL:", error);
            throw new Error(`Erreur upload BL: ${error.message}`);
          }
          
          if (data) {
            const { data: urlData } = supabase.storage
              .from('delivery')
              .getPublicUrl(fileName);
            
            if (urlData && urlData.publicUrl) {
              deliveryUrls.push(urlData.publicUrl);
              console.log("‚úÖ BL upload√©:", urlData.publicUrl);
            }
          }
        }
      } catch (error) {
        console.error("Error uploading delivery files:", error);
        showNotification("‚ùå Erreur BL: " + error.message, "error");
        return;
      }
    }

    const newIntervention = {
      vehicule_id: vehicle.id,
      immatriculation: vehicle.immatriculation,
      modele: vehicle.modele,
      date, 
      type, 
      mecaniciens, 
      pieces, 
      statut, 
      observations,
      delivery_files: deliveryUrls
    };

    try {
      const { data, error } = await supabase
        .from('interventions')
        .insert([newIntervention])
        .select();
      
      if (error) throw error;
      
      if (data && data[0]) {
        interventions.push(data[0]);
        showNotification("‚úÖ Intervention enregistr√©e avec succ√®s!");
      }
      
      updateUI();
      document.getElementById('intervention-form').reset();
      document.getElementById('delivery-files-preview').innerHTML = '';
      deliveryFiles = [];
      document.getElementById('date-intervention').value = new Date().toISOString().split('T')[0];
      
    } catch (err) {
      console.error(err);
      showNotification("‚ùå Erreur intervention: " + err.message, "error");
    }
  }

  // Edit intervention
  function editIntervention(id){
    const intervention = interventions.find(i => i.id === id);
    if(!intervention) return;
    
    currentEditingInterventionId = id;
    deliveryFiles = [];
    
    // Remplir le formulaire de modification
    document.getElementById('edit-intervention-id').value = id;
    document.getElementById('edit-vehicule-intervention').value = intervention.vehicule_id;
    document.getElementById('edit-date-intervention').value = intervention.date;
    document.getElementById('edit-type-intervention').value = intervention.type;
    document.getElementById('edit-pieces').value = intervention.pieces || '';
    document.getElementById('edit-statut').value = intervention.statut;
    document.getElementById('edit-observations').value = intervention.observations || '';
    
    // Afficher les bons de livraison existants
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    previewContainer.innerHTML = '';
    if (intervention.delivery_files && intervention.delivery_files.length > 0) {
      intervention.delivery_files.forEach((url, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${url}" class="delivery-file-preview" alt="Bon de livraison">
          <div class="delivery-file-name">Bon de livraison ${index + 1}</div>
          <div class="remove-delivery-file" onclick="removeExistingDeliveryFile('${id}', ${index})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      });
    }
    
    // S√©lectionner les m√©caniciens
    const mecaniciensSelect = document.getElementById('edit-mecaniciens');
    Array.from(mecaniciensSelect.options).forEach(option => {
      option.selected = intervention.mecaniciens.includes(option.text);
    });
    
    // Afficher le modal
    document.getElementById('intervention-modal').style.display = 'flex';
  }

  async function removeExistingDeliveryFile(interventionId, fileIndex) {
    if(!confirm("√ätes-vous s√ªr de vouloir supprimer ce bon de livraison?")) return;
    
    try {
      const intervention = interventions.find(i => i.id === interventionId);
      if (intervention && intervention.delivery_files) {
        intervention.delivery_files.splice(fileIndex, 1);
        const { error } = await supabase
          .from('interventions')
          .update({ delivery_files: intervention.delivery_files })
          .eq('id', interventionId);
        
        if (error) throw error;
        
        // Mettre √† jour l'affichage
        editIntervention(interventionId);
        showNotification("‚úÖ Bon de livraison supprim√© avec succ√®s");
      }
    } catch (error) {
      console.error("Error deleting delivery file:", error);
      showNotification("‚ùå Erreur lors de la suppression du bon de livraison", "error");
    }
  }

  // Update intervention - CORRIG√â
  async function updateIntervention(){
    const id = document.getElementById('edit-intervention-id').value;
    const vehiculeId = document.getElementById('edit-vehicule-intervention').value;
    const date = document.getElementById('edit-date-intervention').value;
    const type = document.getElementById('edit-type-intervention').value.trim();
    const mecaniciensElements = document.getElementById('edit-mecaniciens');
    const pieces = document.getElementById('edit-pieces').value.trim();
    const statut = document.getElementById('edit-statut').value;
    const observations = document.getElementById('edit-observations').value.trim();

    if(!vehiculeId){ showNotification("S√©lectionner un v√©hicule", "error"); return; }
    if(!date || !type){ showNotification("Date et type requis", "error"); return; }

    const mecaniciens = Array.from(mecaniciensElements.selectedOptions).map(o => o.text);
    const vehicle = vehicles.find(v => v.id == vehiculeId);
    if(!vehicle){ showNotification("V√©hicule introuvable", "error"); return; }

    // Upload des nouveaux bons de livraison - CORRIG√â
    let newDeliveryUrls = [];
    if (deliveryFiles.length > 0) {
      try {
        console.log("üìÑ Upload de", deliveryFiles.length, "nouveaux fichiers BL...");
        
        for (const file of deliveryFiles) {
          const fileName = `delivery/${Date.now()}_${file.name}`;
          
          const { data, error } = await supabase.storage
            .from('delivery')
            .upload(fileName, file);
          
          if (error) {
            console.error("‚ùå Erreur upload BL modification:", error);
            throw new Error(`Erreur upload: ${error.message}`);
          }
          
          if (data) {
            const { data: urlData } = supabase.storage
              .from('delivery')
              .getPublicUrl(fileName);
            
            if (urlData && urlData.publicUrl) {
              newDeliveryUrls.push(urlData.publicUrl);
              console.log("‚úÖ Nouveau fichier BL upload√©:", urlData.publicUrl);
            }
          }
        }
      } catch (error) {
        console.error("Error uploading new delivery files:", error);
        showNotification("‚ùå Erreur lors de l'upload des nouveaux bons de livraison: " + error.message, "error");
        return;
      }
    }

    // R√©cup√©rer les bons de livraison existants
    const existingIntervention = interventions.find(i => i.id === id);
    const existingDeliveryUrls = existingIntervention.delivery_files || [];

    const updatedIntervention = {
      vehicule_id: vehicle.id,
      immatriculation: vehicle.immatriculation,
      modele: vehicle.modele,
      date, type, mecaniciens, pieces, statut, observations,
      delivery_files: [...existingDeliveryUrls, ...newDeliveryUrls]
    };

    try {
      const { error } = await supabase
        .from('interventions')
        .update(updatedIntervention)
        .eq('id', id);
      
      if (error) throw error;
      
      // Mettre √† jour localement
      const index = interventions.findIndex(i => i.id === id);
      if(index !== -1) {
        interventions[index] = { ...interventions[index], ...updatedIntervention };
      }
      
      updateUI();
      document.getElementById('intervention-modal').style.display = 'none';
      currentEditingInterventionId = null;
      deliveryFiles = [];
      showNotification("‚úÖ Intervention modifi√©e avec succ√®s!");
    } catch (err) {
      console.error(err);
      showNotification("‚ùå Erreur lors de la modification de l'intervention", "error");
    }
  }

  // Search by filters
  function performSearch(){
    const immatriculation = (document.getElementById('search-immatriculation').value || '').toLowerCase();
    const modele = (document.getElementById('search-modele').value || '').toLowerCase();
    const couleur = (document.getElementById('search-couleur').value || '').toLowerCase();
    const date = document.getElementById('search-date').value;
    const type = document.getElementById('search-type').value;
    const statut = document.getElementById('search-statut').value;

    let results = vehicles.slice();

    if(immatriculation) results = results.filter(v => v.immatriculation.toLowerCase().includes(immatriculation));
    if(modele) results = results.filter(v => v.modele.toLowerCase().includes(modele));
    if(couleur) results = results.filter(v => v.couleur.toLowerCase().includes(couleur));

    if(date || type || statut) {
      const ids = interventions.filter(i => {
        let match = true;
        if(date) match = match && i.date === date;
        if(type) match = match && i.type === type;
        if(statut) match = match && i.statut === statut;
        return match;
      }).map(i => i.vehicule_id);
      results = results.filter(v => ids.includes(v.id));
    }

    const resultsContainer = document.getElementById('search-results');
    const resultsCount = document.getElementById('search-results-count');
    resultsContainer.innerHTML = '';
    
    if(results.length === 0){
      resultsContainer.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucun r√©sultat trouv√©</td></tr>';
      resultsCount.innerHTML = '<p>Aucun r√©sultat trouv√©</p>';
      return;
    }

    resultsCount.innerHTML = '<p>' + results.length + ' r√©sultat(s) trouv√©(s)</p>';

    results.forEach(vehicle => {
      const lastIntervention = interventions
        .filter(i => i.vehicule_id === vehicle.id)
        .sort((a,b)=> new Date(b.date) - new Date(a.date))[0];

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><img src="${vehicle.photo}" class="vehicle-photo" alt="photo"></td>
        <td>${vehicle.immatriculation}</td>
        <td>${vehicle.modele}</td>
        <td>${vehicle.couleur}</td>
        <td>${vehicle.proprietaire || ''}</td>
        <td>${lastIntervention ? lastIntervention.type + ' (' + formatDate(lastIntervention.date) + ')' : 'Aucune'}</td>
        <td>${lastIntervention ? '<span class="status-badge status-' + lastIntervention.statut + '">' + lastIntervention.statut + '</span>' : 'N/A'}</td>
      `;
      resultsContainer.appendChild(tr);
    });
  }

  function resetSearch(){
    document.getElementById('search-immatriculation').value = '';
    document.getElementById('search-modele').value = '';
    document.getElementById('search-couleur').value = '';
    document.getElementById('search-date').value = '';
    document.getElementById('search-type').value = '';
    document.getElementById('search-statut').value = '';
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('search-results-count').innerHTML = '';
  }

  // Global search (simple)
  function performGlobalSearch(query){
    if(!query || query.length < 2) return;
    query = query.toLowerCase();

    const results = [
      ...vehicles.filter(v => v.immatriculation.toLowerCase().includes(query) || v.modele.toLowerCase().includes(query) || (v.proprietaire || '').toLowerCase().includes(query)),
      ...interventions.filter(i => i.immatriculation.toLowerCase().includes(query) || (i.type || '').toLowerCase().includes(query) || i.mecaniciens.some(m => m.toLowerCase().includes(query))).map(i => vehicles.find(v=>v.id===i.vehicule_id)).filter(Boolean)
    ];

    const unique = [...new Map(results.map(r => [r.id, r])).values()];
    if(unique.length) showNotification(unique.length + ' r√©sultat(s) trouv√©(s) pour "' + query + '"');
  }

  // Update flux
  function updateFlux(){
    const selectedDate = document.getElementById('flux-date').value || new Date().toISOString().split('T')[0];
    
    // V√©hicules entr√©s aujourd'hui (premi√®re intervention √† cette date)
    const vehiclesEntered = interventions
      .filter(i => i.date === selectedDate)
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    // V√©hicules avec interventions en cours √† cette date
    const vehiclesInProgress = interventions
      .filter(i => i.date === selectedDate && i.statut === 'en-cours')
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    // V√©hicules sortis aujourd'hui (interventions termin√©es √† cette date)
    const vehiclesExited = interventions
      .filter(i => i.date === selectedDate && i.statut === 'termine')
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    // Mettre √† jour l'interface
    const entreesContainer = document.getElementById('flux-entrees');
    const enCoursContainer = document.getElementById('flux-en-cours');
    const sortiesContainer = document.getElementById('flux-sorties');
    
    entreesContainer.innerHTML = vehiclesEntered.length ? 
      vehiclesEntered.map(v => `
        <div class="flux-item entree">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun v√©hicule entr√©</p>';
    
    enCoursContainer.innerHTML = vehiclesInProgress.length ? 
      vehiclesInProgress.map(v => `
        <div class="flux-item">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun v√©hicule en cours</p>';
    
    sortiesContainer.innerHTML = vehiclesExited.length ? 
      vehiclesExited.map(v => `
        <div class="flux-item sortie">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun v√©hicule sorti</p>';
    
    // Mettre √† jour les statistiques du tableau de bord
    document.getElementById('vehicles-entered-today').textContent = vehiclesEntered.length;
    document.getElementById('vehicles-exited-today').textContent = vehiclesExited.length;
  }

  // UI updates
  function updateUI(){
    updateVehicleList();
    updateInterventionsList();
    updateVehicleSelect();
    updateStats();
     updateJournalComplet();
    updateFlux();
  }

  function updateVehicleList(){
    const container = document.getElementById('vehicles-list');
    container.innerHTML = '';
    if(vehicles.length === 0) { 
        container.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucun v√©hicule enregistr√©</td></tr>'; 
        return; 
    }

    vehicles.forEach(vehicle => {
        const tr = document.createElement('tr');
        
        const imgHTML = `
            <img src="${vehicle.photo}" 
                 class="vehicle-photo" 
                 alt="photo" 
                 onerror="this.src='https://via.placeholder.com/100x70?text=Vehicle'; this.onerror=null;"
                 loading="lazy">
        `;

        tr.innerHTML = `
            <td style="width: 100px; min-width: 100px; max-width: 100px;">${imgHTML}</td>
            <td>${vehicle.immatriculation}</td>
            <td>${vehicle.modele}</td>
            <td>${vehicle.couleur}</td>
            <td>${vehicle.proprietaire || ''}</td>
            <td class="action-buttons">
                <button class="btn-edit" onclick="editVehicle('${vehicle.id}')">Modifier</button>
                <button class="btn-delete" onclick="deleteVehicle('${vehicle.id}')">Supprimer</button>
            </td>
        `;
        container.appendChild(tr);
    });
  }

  function updateInterventionsList(){
    const container = document.getElementById('interventions-list');
    container.innerHTML = '';
    
    // CORRECTION : Ajouter une classe pour le responsive
    const table = container.closest('table');
    if (table) {
      table.classList.add('interventions-table');
    }
    
    if(interventions.length === 0) { 
      container.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucune intervention enregistr√©e</td></tr>'; 
      return; 
    }

    const sorted = [...interventions].sort((a,b)=> new Date(b.date) - new Date(a.date));
    sorted.forEach(i => {
      const vehicle = vehicles.find(v=>v.id===i.vehicule_id);
      if(!vehicle) return;
      const statusClass = 'status-' + i.statut;
      
      // CORRECTION : Meilleur affichage des m√©caniciens
      const mechanicsHtml = `<span class="mechanics-list" title="${i.mecaniciens.join(', ')}">${i.mecaniciens.join(', ')}</span>`;
      
      // CORRECTION : Meilleur affichage des bons de livraison
    //   let deliveryHtml = 'Aucun';
    //   if (i.delivery_files && i.delivery_files.length > 0) {
    //     deliveryHtml = `<div class="delivery-photos-container">` + 
    //       i.delivery_files.map((url, index) => 
    //         `<img src="${url}" class="delivery-photo" alt="Bon ${index + 1}" title="Bon de livraison ${index + 1}">`
    //       ).join('') + `</div>`;
    //   }

      const tr = document.createElement('tr');
      
      // CORRECTION : Structure am√©lior√©e pour le responsive
      tr.innerHTML = `
        <td><strong>${vehicle.immatriculation}</strong><br><small>${vehicle.modele}</small></td>
        <td>${formatDate(i.date)}</td>
        <td>${i.type}</td>
        <td class="mechanics-cell">${mechanicsHtml}</td>
        <td><span class="status-badge ${statusClass}">${i.statut}</span></td>
        <td class="action-buttons">
        <button class="btn-details" onclick="showInterventionDetails('${i.id}')">D√©tails</button>
          <button class="btn-edit" onclick="editIntervention('${i.id}')">Modifier</button>
          <button class="btn-delete" onclick="deleteIntervention('${i.id}')">Supprimer</button>
        </td>
      `;
      container.appendChild(tr);
    });
  }

  function updateVehicleSelect(){
    const select = document.getElementById('vehicule-intervention');
    const editSelect = document.getElementById('edit-vehicule-intervention');
    
    select.innerHTML = '<option value="">S√©lectionner un v√©hicule</option>';
    if(editSelect) editSelect.innerHTML = '<option value="">S√©lectionner un v√©hicule</option>';
    
    vehicles.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v.id;
      opt.textContent = v.immatriculation + ' - ' + v.modele;
      select.appendChild(opt);
      
      if(editSelect) {
        const editOpt = document.createElement('option');
        editOpt.value = v.id;
        editOpt.textContent = v.immatriculation + ' - ' + v.modele;
        editSelect.appendChild(editOpt);
      }
    });
  }

  function updateStats(){
    document.getElementById('vehicles-count').textContent = vehicles.length;
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('interventions-today').textContent = interventions.filter(i=>i.date===today).length;

    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    const monthlyOil = interventions.filter(i=>{
      const d = new Date(i.date);
      return i.type.toLowerCase() === 'vidange' && d.getMonth()===currentMonth && d.getFullYear()===currentYear;
    }).length;
    document.getElementById('month-oil-changes').textContent = monthlyOil;

    document.getElementById('vehicles-waiting').textContent = interventions.filter(i=>i.statut==='en-attente').length;

    document.getElementById('total-interventions').textContent = interventions.length;
    document.getElementById('month-oil-changes').textContent = monthlyOil;
    const completed = interventions.filter(i=>i.statut==='termine').length;
    document.getElementById('completion-rate').textContent = interventions.length>0 ? Math.round((completed/interventions.length)*100) + '%' : '0%';

    // stats by mechanic
    const mechanicsStats = {};
    interventions.forEach(i=>{
      (i.mecaniciens||[]).forEach(m=>{
        if(!mechanicsStats[m]) mechanicsStats[m] = { total:0, inProgress:0, completed:0 };
        mechanicsStats[m].total++;
        if(i.statut==='en-cours') mechanicsStats[m].inProgress++;
        if(i.statut==='termine') mechanicsStats[m].completed++;
      });
    });

    const container = document.getElementById('mechanics-stats');
    container.innerHTML = '';
    Object.keys(mechanicsStats).forEach(m=>{
      const successRate = mechanicsStats[m].total > 0 ? 
        Math.round((mechanicsStats[m].completed / mechanicsStats[m].total) * 100) : 0;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${m}</td>
        <td>${mechanicsStats[m].total}</td>
        <td>${mechanicsStats[m].inProgress}</td>
        <td>${mechanicsStats[m].completed}</td>
        <td>${successRate}%</td>
      `;
      container.appendChild(row);
    });

    // Stats par type d'intervention
    const typeStats = {};
    interventions.forEach(i => {
      if(!typeStats[i.type]) typeStats[i.type] = 0;
      typeStats[i.type]++;
    });

    const typeContainer = document.getElementById('intervention-types-stats');
    typeContainer.innerHTML = '';
    
    const sortedTypes = Object.entries(typeStats)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    sortedTypes.forEach(([type, count]) => {
      const percentage = interventions.length > 0 ? Math.round((count / interventions.length) * 100) : 0;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${type}</strong></td>
        <td style="text-align: center; font-weight: 700;">${count}</td>
        <td style="text-align: center; font-weight: 600; color: #27ae60;">${percentage}%</td>
        <td>
          <div class="percentage-bar">
            <div class="percentage-fill" style="width: ${percentage}%"></div>
          </div>
        </td>
      `;
      typeContainer.appendChild(row);
    });

    if (sortedTypes.length === 0) {
      typeContainer.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">Aucune intervention enregistr√©e</td></tr>';
    }
  }

  function updateRecentActivity(){
    const container = document.getElementById('recent-activity');
    container.innerHTML = '';
    const recent = [...interventions].sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,5);
    if(recent.length===0){ container.innerHTML = '<tr><td colspan="5" style="text-align:center">Aucune activit√© r√©cente</td></tr>'; return; }
    recent.forEach(i=>{
      const vehicle = vehicles.find(v=>v.id===i.vehicule_id);
      if(!vehicle) return;
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>' + vehicle.immatriculation + ' (' + vehicle.modele + ')</td><td>' + i.type + '</td><td>' + i.mecaniciens.join(', ') + '</td><td>' + formatDate(i.date) + '</td><td><span class="status-badge status-' + i.statut + '">' + i.statut + '</span></td>';
      container.appendChild(tr);
    });
  }

  // Edit & delete
  async function editVehicle(id){
    const v = vehicles.find(x=>x.id===id);
    if(!v) return;
    
    document.getElementById('immatriculation').value = v.immatriculation;
    document.getElementById('modele').value = v.modele;
    document.getElementById('couleur').value = v.couleur;
    document.getElementById('proprietaire').value = v.proprietaire || '';
    document.getElementById('telephone').value = v.telephone || '';
    
    const preview = document.getElementById('photo-preview');
    preview.src = v.photo;
    preview.style.display = 'block';
    
    document.getElementById('vehicle-form').dataset.editingId = id;
    document.querySelector('#vehicle-form button[type="submit"]').textContent = 'Modifier le v√©hicule';
    document.getElementById('cancel-edit-vehicle').style.display = 'inline-block';
    
    showNotification("Modifiez le v√©hicule puis cliquez sur Modifier");
  }

  async function deleteVehicle(id, showNote = true){
    if(!confirm("√ätes-vous s√ªr de vouloir supprimer ce v√©hicule?")) return;
    try {
      const { error } = await supabase
        .from('vehicles')
        .delete()
        .eq('id', id);
      
      if (error) throw error;
      
      vehicles = vehicles.filter(v=>v.id!==id);
      interventions = interventions.filter(i=>i.vehicule_id!==id);

      updateUI();
      if(showNote) showNotification("‚úÖ V√©hicule supprim√© avec succ√®s");
    } catch(err){
      console.error(err);
      showNotification("‚ùå Erreur lors de la suppression", "error");
    }
  }

  async function deleteIntervention(id){
    if(!confirm("√ätes-vous s√ªr de vouloir supprimer cette intervention?")) return;
    try {
      const { error } = await supabase
        .from('interventions')
        .delete()
        .eq('id', id);
      
      if (error) throw error;
      
      interventions = interventions.filter(i=>i.id!==id);
      updateUI();
      showNotification("‚úÖ Intervention supprim√©e avec succ√®s");
    } catch(err){
      console.error(err);
      showNotification("‚ùå Erreur lors de la suppression", "error");
    }
  }

  // notifications
  function showNotification(message, type="success"){
    const note = document.getElementById('notification');
    note.textContent = message;
    note.className = 'notification ' + (type === 'error' ? 'error' : '') + ' show';
    setTimeout(()=>{ note.classList.remove('show'); }, 3000);
  }

  function formatDate(dateString){
    const d = new Date(dateString);
    return d.toLocaleDateString('fr-FR');
  }

  // expose some functions for inline onclick
  window.editVehicle = editVehicle;
  window.deleteVehicle = deleteVehicle;
  window.editIntervention = editIntervention;
  window.deleteIntervention = deleteIntervention;
  window.removeDeliveryFile = removeDeliveryFile;
  window.removeEditDeliveryFile = removeEditDeliveryFile;
  window.removeExistingDeliveryFile = removeExistingDeliveryFile;
</script>
</body>
</html>
