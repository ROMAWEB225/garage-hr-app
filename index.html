<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="supabase-config" content="secured">
  <title>Garage HR - Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary: #8b0000;   /* rouge foncé */
      --secondary: #333333; /* gris pur */
      --accent: #e74c3c;
      --light: #ffffff;
      --muted: #f5f5f5;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #c0392b;
      --glass: rgba(255,255,255,0.06);
    }

    /* Reset & base */
    *{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:var(--muted);color:var(--secondary);line-height:1.4}
    .container{display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:250px;
      background:var(--primary);
      color:var(--light);
      position:fixed;left:0;top:0;bottom:0;padding:18px 12px;
      display:flex;flex-direction:column;gap:6px;
      z-index:1000;
      transition:transform 0.3s ease;
    }
    .logo{font-weight:700;font-size:1.1rem;text-align:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .menu-item{
      display:flex;gap:10px;align-items:center;padding:12px;border-radius:8px;cursor:pointer;color:var(--light);
      transition:background .18s, transform .08s;
    }
    .menu-item i{font-size:18px}
    .menu-item span{font-weight:600}
    .menu-item:hover{background:rgba(255,255,255,0.06);transform:translateY(-1px)}
    .menu-item.active{background:var(--secondary);color:var(--light)}

    /* Main content */
    .main-content{
      margin-left:250px;flex:1;padding:20px 26px;
      transition:margin-left 0.3s ease;
    }
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;border-bottom:1px solid #eee;padding-bottom:12px;flex-wrap:wrap}
    .header h1{font-size:1.25rem;color:var(--secondary)}
    .header-controls{display:flex;gap:10px;align-items:center}
    .header-controls input{padding:10px;border-radius:6px;border:1px solid #ddd;width:260px}
    .mobile-menu-btn{display:none;font-size:1.5rem;cursor:pointer}

    /* Stats cards */
    .stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin:18px 0}
    .stat-card{background:var(--light);border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06);text-align:center}
    .stat-card h3{color:var(--primary);margin-bottom:10px;font-size:0.9rem}
    .stat-card .number{font-size:28px;color:var(--secondary);font-weight:700}

    /* Form sections */
    .form-section{background:var(--light);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:18px}
    .form-section h2{margin-bottom:12px;color:var(--primary);padding-bottom:8px;border-bottom:1px solid #f2f2f2}
    .form-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px}
    .form-group{flex:1 1 260px;min-width:180px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--secondary)}
    .form-group input,.form-group select,.form-group textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;font-size:14px;background:#fff;color:var(--secondary)
    }
    .form-group textarea{min-height:90px;resize:vertical}
    .select-hint{font-size:12px;color:#666;margin-top:6px}

    /* Nouveau style pour les fichiers de bons de livraison */
    .delivery-files-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .delivery-file-item {
      text-align: center;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9f9;
    }
    .delivery-file-preview {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .delivery-file-name {
      font-size: 0.8rem;
      word-break: break-word;
    }
    .remove-delivery-file {
      color: #e74c3c;
      cursor: pointer;
      font-size: 0.8rem;
      margin-top: 5px;
    }

    /* Buttons */
    .btn{cursor:pointer;border-radius:8px;padding:10px 14px;font-weight:700;border:none;transition:all 0.2s}
    .btn-primary{background:var(--primary);color:var(--light)}
    .btn-primary:hover{background:var(--secondary)}
    .btn-sm{padding:6px 10px;font-size:0.85rem}
    .btn-edit{background:#3498db;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin-right:5px}
    .btn-delete{background:#e74c3c;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
    .btn-details{background:#27ae60;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
    .btn-edit:hover{background:#2980b9}
    .btn-delete:hover{background:#c0392b}
    .btn-details:hover{background:#219653}

    /* Tables */
    .data-table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      table-layout: fixed;
    }
    .data-table th,.data-table td{
      padding:12px 10px;
      border-bottom:1px solid #f0f0f0;
      text-align:left;
      vertical-align: top;
    }
    .data-table th{background:transparent;color:var(--secondary);font-weight:700}
    .data-table tr:hover{background:#fafafa}
    
    .data-table th:nth-child(1),
    .data-table td:nth-child(1) {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }
    .data-table th:nth-child(2),
    .data-table td:nth-child(2) {
      width: 120px;
      min-width: 120px;
    }
    .data-table th:nth-child(6),
    .data-table td:nth-child(6) {
      width: 150px;
      min-width: 150px;
    }

    /* Correction pour les statistiques des types d'interventions */
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .stats-table th, 
    .stats-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      text-align: left;
    }
    .stats-table th {
      background: #f8f9fa;
      color: var(--primary);
      font-weight: 700;
      border-bottom: 2px solid var(--primary);
    }
    .stats-table tr:hover {
      background: #fafafa;
    }
    .stats-table td {
      padding: 15px;
    }
    .stats-table td:nth-child(1) {
      font-weight: 600;
      color: var(--secondary);
    }
    .stats-table td:nth-child(2) {
      text-align: center;
      font-weight: 700;
      color: var(--primary);
    }
    .stats-table td:nth-child(3) {
      text-align: center;
      font-weight: 600;
      color: #27ae60;
    }

    /* Barre de progression pour visualiser les pourcentages */
    .percentage-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      margin-top: 5px;
      overflow: hidden;
    }
    .percentage-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Correction pour les images de véhicules */
    .vehicle-photo {
      width: 100px !important;
      height: 70px !important;
      object-fit: cover !important;
      border-radius: 6px;
      display: block;
      background-color: #f5f5f5;
      border: 1px solid #e0e0e0;
      transition: none !important;
      animation: none !important;
    }

    /* Images des bons de livraison */
    .delivery-photo {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
      margin: 2px;
    }

    /* Container pour stabiliser l'image */
    .vehicle-image-container {
      width: 100px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f5f5f5;
      border-radius: 6px;
      overflow: hidden;
    }

    /* Status badges */
    .status-badge{padding:6px 10px;border-radius:20px;font-weight:700;font-size:13px;display:inline-block}
    .status-en-cours{background:#ffeaa7;color:#d35400}
    .status-termine{background:#d1f7c4;color:#27ae60}
    .status-en-attente{background:#f1f2f6;color:#636e72}

    /* small helpers */
    .form-actions{margin-top:10px;display:flex;gap:10px;align-items:center}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Notification */
    .notification{
      position:fixed;right:20px;top:20px;padding:12px 16px;border-radius:8px;color:#fff;background:var(--success);box-shadow:0 8px 24px rgba(0,0,0,0.12);transform:translateX(120%);transition:transform 260ms ease;z-index:9999
    }
    .notification.show{transform:translateX(0)}
    .notification.error{background:var(--danger)}
    .notification.warning{background:var(--warning)}

    /* Search section */
    .search-filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:15px}

    /* Flux section */
    .flux-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px}
    .flux-column{background:var(--light);border-radius:10px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    .flux-column h3{color:var(--primary);margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid #eee}
    .flux-item{background:#f9f9f9;border-radius:6px;padding:10px;margin-bottom:8px;border-left:4px solid var(--primary)}
    .flux-item.entree{border-left-color:var(--success)}
    .flux-item.sortie{border-left-color:var(--warning)}
    .flux-item-header{display:flex;justify-content:space-between;margin-bottom:5px}
    .flux-item-title{font-weight:600}
    .flux-item-details{font-size:0.85rem;color:#666}

    /* Photo preview */
    .photo-preview{width:120px;height:90px;border-radius:6px;object-fit:cover;border:2px dashed #ddd;display:block;margin-top:5px}

    /* Modal pour détails véhicule */
    .vehicle-details-modal .modal-content {
      max-width: 800px;
    }
    .vehicle-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .vehicle-details-photo {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
    }
    .intervention-history {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px;
    }
    .intervention-item {
      border-left: 4px solid var(--primary);
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .intervention-item.en-cours { border-left-color: var(--warning); }
    .intervention-item.termine { border-left-color: var(--success); }
    .intervention-item.en-attente { border-left-color: #95a5a6; }

    /* RESPONSIVE AMÉLIORÉ */
    @media (max-width: 1200px){
      .main-content{padding:15px 20px}
      .stats-cards{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
    }

    @media (max-width: 992px){
      .sidebar{width:200px}
      .main-content{margin-left:200px;padding:15px}
      .form-section{padding:15px}
      .header-controls input{width:200px}
      .vehicle-details-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px){
      .mobile-menu-btn{display:block}
      .sidebar{transform:translateX(-100%);width:280px}
      .sidebar.open{transform:translateX(0)}
      .main-content{margin-left:0;padding:12px}
      .main-content.sidebar-open{margin-left:280px}
      
      .stats-cards{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:12px 0}
      .stat-card{padding:12px}
      .stat-card .number{font-size:24px}
      
      .header{flex-direction:column;align-items:flex-start;gap:10px}
      .header-controls{width:100%;flex-direction:column;gap:8px}
      .header-controls input{width:100%}
      .quick-actions{width:100%;justify-content:center}
      
      .form-group{min-width:100%}
      .form-section{padding:12px;margin-bottom:12px}
      .form-row{gap:12px;margin-bottom:10px}
      
      .data-table{font-size:0.85rem; table-layout: auto;}
      .data-table th,.data-table td{padding:8px 6px}
      
      .data-table th:nth-child(1),
      .data-table td:nth-child(1),
      .data-table th:nth-child(2),
      .data-table td:nth-child(2),
      .data-table th:nth-child(6),
      .data-table td:nth-child(6) {
        width: auto;
        min-width: auto;
        max-width: none;
      }

      .stats-table th, 
      .stats-table td {
        padding: 8px 6px;
        font-size: 0.85rem;
      }
      
      .flux-container{grid-template-columns:1fr;gap:12px}
      .flux-column{padding:12px}
      
      .search-filters{grid-template-columns:1fr;gap:10px}
      
      .vehicle-photo{width:80px !important;height:60px !important}
      .delivery-photo{width:60px;height:45px}
      
      .action-buttons{display:flex;flex-direction:column;gap:5px}
      .btn-edit, .btn-delete, .btn-details{width:100%;margin:2px 0;text-align:center}
    }

    @media (max-width: 480px){
      .main-content{padding:10px}
      .form-section{padding:10px;margin-bottom:10px}
      .form-row{gap:10px;margin-bottom:8px}
      
      .stats-cards{grid-template-columns:1fr 1fr;gap:10px}
      .stat-card{padding:10px}
      .stat-card .number{font-size:20px}
      .stat-card h3{font-size:0.8rem}
      
      .header h1{font-size:1.1rem}
      .header-controls{gap:6px}
      
      .data-table{font-size:0.8rem}
      .data-table th,.data-table td{padding:6px 4px}
      
      .stats-table{font-size:0.8rem}
      .stats-table th, 
      .stats-table td{padding:6px 4px}
      
      .data-table th:nth-child(4), 
      .data-table td:nth-child(4) {
        display: none;
      }
      
      .modal-content{width:95%;padding:15px;margin:10px}
      
      .form-group textarea{min-height:70px}
      
      .menu-item{padding:10px 8px;font-size:0.9rem}
    }

    @media (max-width: 360px){
      .stats-cards{grid-template-columns:1fr;gap:8px}
      .data-table{font-size:0.75rem}
      .btn{padding:8px 12px;font-size:0.9rem}
      .form-section h2{font-size:1.1rem}
    }

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;justify-content:center;align-items:center}
    .modal-content{background:white;border-radius:10px;padding:20px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:10px}
    .modal-close{font-size:1.5rem;cursor:pointer;color:#999}
    .modal-close:hover{color:#333}

    /* Quick actions */
    .quick-actions{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
    .quick-action-btn{background:var(--light);border:1px solid #ddd;border-radius:6px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all 0.2s}
    .quick-action-btn:hover{background:#f0f0f0;transform:translateY(-2px)}

    /* Loading states */
    .loading{opacity:0.6;pointer-events:none}
    .spinner{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
  
<body>
  <div id="notification" class="notification"></div>

  <!-- Modal pour modifier les interventions -->
  <div id="intervention-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Modifier l'intervention</h2>
        <span class="modal-close">&times;</span>
      </div>
      <form id="edit-intervention-form">
        <input type="hidden" id="edit-intervention-id">
        <div class="form-row">
          <div class="form-group">
            <label for="edit-vehicule-intervention">Véhicule</label>
            <select id="edit-vehicule-intervention" required>
              <option value="">Sélectionner un véhicule</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-date-intervention">Date</label>
            <input type="date" id="edit-date-intervention" required />
          </div>

          <div class="form-group">
            <label for="edit-type-intervention">Type d'intervention</label>
            <input list="edit-types-intervention" id="edit-type-intervention" placeholder="Choisissez ou écrivez un type" required />
            <datalist id="edit-types-intervention">
              <option value="Vidange">
              <option value="Réparation">
              <option value="Contrôle technique">
              <option value="Carrosserie">
              <option value="Électricité">
            </datalist>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-mecaniciens">Mécaniciens (sélection multiple)</label>
            <select id="edit-mecaniciens" multiple>
              <option value="1">YOBOUET SYLVIN</option>
              <option value="2">KHALIL HUSSEIN</option>
              <option value="3">NIANKINE YOUSSOUF</option>
              <option value="4">OUATTARA ISSIF</option>
              <option value="5">BABA DRAMANE</option>
              <option value="6">KONE SAIDOU</option>
              <option value="7">TRAORE ABDELATIF</option>
              <option value="8">KOUAME K WILLIAM</option>
              <option value="9">DIABATE HASSAN</option>
              <option value="10">MOHAMED</option>
              <option value="11">MANBONNE A AZIZ</option>
              <option value="12">TOUVOLI KEVIN</option>
              <option value="13">TOURE OTHNIEL</option>
              <option value="14">VEHI EBENEZER</option>
            </select>
            <div class="select-hint">Ctrl/Cmd + clic pour multi-sélection (ou appuyez longuement sur mobile)</div>
          </div>

          <div class="form-group">
            <label for="edit-pieces">Pièces utilisées</label>
            <textarea id="edit-pieces" placeholder="Liste des pièces utilisées..."></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-bons-livraison">Bons de livraison (photos)</label>
            <input type="file" id="edit-bons-livraison" accept="image/*" multiple />
            <div class="select-hint">Vous pouvez sélectionner plusieurs photos</div>
            <div id="edit-delivery-files-preview" class="delivery-files-container"></div>
          </div>

          <div class="form-group">
            <label for="edit-statut">Statut</label>
            <select id="edit-statut" required>
              <option value="en-attente">En attente</option>
              <option value="en-cours">En cours</option>
              <option value="termine">Terminé</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-observations">Observations</label>
            <textarea id="edit-observations" placeholder="Observations..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <span class="btn-text">Modifier l'intervention</span>
            <div class="spinner" style="display:none"></div>
          </button>
          <button type="button" id="cancel-edit" class="btn">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal pour détails véhicule -->
  <div id="vehicle-details-modal" class="modal vehicle-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Détails du Véhicule</h2>
        <span class="modal-close">&times;</span>
      </div>
      <div id="vehicle-details-content">
        <!-- Contenu chargé dynamiquement -->
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigation principale">
      <div class="logo"><span> HR MOTORS</span></div>

      <nav class="nav">
        <div class="menu-item active" data-tab="dashboard"><i class="fas fa-chart-bar"></i><span>Tableau de bord</span></div>
        <div class="menu-item" data-tab="vehicles"><i class="fas fa-car"></i><span>Véhicules</span></div>
        <div class="menu-item" data-tab="interventions"><i class="fas fa-tools"></i><span>Interventions</span></div>
        <div class="menu-item" data-tab="flux"><i class="fas fa-exchange-alt"></i><span>Flux véhicules</span></div>
        <div class="menu-item" data-tab="search"><i class="fas fa-search"></i><span>Recherche</span></div>
        <div class="menu-item" data-tab="stats"><i class="fas fa-chart-line"></i><span>Statistiques</span></div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <header class="header">
        <div class="mobile-menu-btn">
          <i class="fas fa-bars"></i>
        </div>
        <h1>Tableau de Bord - Garage HR</h1>
        <div class="header-controls">
          <input type="text" id="global-search" placeholder="Rechercher..." />
          <div class="quick-actions">
            <div class="quick-action-btn" id="quick-add-vehicle">
              <i class="fas fa-plus"></i> Véhicule
            </div>
            <div class="quick-action-btn" id="quick-add-intervention">
              <i class="fas fa-wrench"></i> Intervention
            </div>
          </div>
        </div>
      </header>

      <!-- Dashboard -->
      <section id="dashboard-tab" class="tab-content active">
        <div class="stats-cards">
          <div class="stat-card">
            <h3>Véhicules au garage (Stock)</h3>
            <div class="number" id="vehicles-stock">0</div>
          </div>
          <div class="stat-card">
            <h3>Véhicules entrés aujourd'hui</h3>
            <div class="number" id="vehicles-entered-today">0</div>
          </div>
          <div class="stat-card">
            <h3>Véhicules sortis aujourd'hui</h3>
            <div class="number" id="vehicles-exited-today">0</div>
          </div>
          <div class="stat-card">
            <h3>Interventions en cours</h3>
            <div class="number" id="interventions-in-progress">0</div>
          </div>
        </div>

        <div class="form-section">
          <h2>Journal complet des activités</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="journal-date">Filtrer par date</label>
              <input type="date" id="journal-date" />
            </div>
            <div class="form-group">
              <label for="journal-type">Filtrer par type</label>
              <select id="journal-type">
                <option value="">Tous les types</option>
                <option value="Vidange">Vidange</option>
                <option value="Réparation">Réparation</option>
                <option value="Contrôle technique">Contrôle technique</option>
                <option value="Carrosserie">Carrosserie</option>
                <option value="Électricité">Électricité</option>
              </select>
            </div>
            <div class="form-group">
              <label for="journal-statut">Filtrer par statut</label>
              <select id="journal-statut">
                <option value="">Tous les statuts</option>
                <option value="en-attente">En attente</option>
                <option value="en-cours">En cours</option>
                <option value="termine">Terminé</option>
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button id="journal-filter" class="btn btn-primary">Filtrer</button>
            <button id="journal-reset" class="btn">Réinitialiser</button>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Véhicule</th>
                <th>Type intervention</th>
                <th>Mécaniciens</th>
                <th>Photos BL</th>
                <th>Statut</th>
                <th>Observations</th>
              </tr>
            </thead>
            <tbody id="journal-complet"></tbody>
          </table>
        </div>
      </section>

      <!-- Vehicles -->
      <section id="vehicles-tab" class="tab-content">
        <div class="form-section">
          <h2>Nouveau Véhicule</h2>
          <form id="vehicle-form">
            <div class="form-row">
              <div class="form-group">
                <label for="immatriculation">Immatriculation</label>
                <input type="text" id="immatriculation" required />
                <div class="select-hint" id="immatriculation-hint">Tous les formats acceptés</div>
              </div>
              <div class="form-group">
                <label for="modele">Modèle</label>
                <input type="text" id="modele" required />
              </div>
              <div class="form-group">
                <label for="couleur">Couleur</label>
                <input type="text" id="couleur" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="photo">Photo du véhicule</label>
                <input type="file" id="photo" accept="image/*" />
                <div class="select-hint">Taille max: 5MB - Formats: JPG, PNG, WebP</div>
                <img id="photo-preview" class="photo-preview" src="" alt="Aperçu de la photo" style="display:none" />
              </div>
              <div class="form-group">
                <label for="proprietaire">Propriétaire</label>
                <input type="text" id="proprietaire" />
              </div>
              <div class="form-group">
                <label for="telephone">Téléphone</label>
                <input type="tel" id="telephone" />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <span class="btn-text">Enregistrer le véhicule</span>
                <div class="spinner" style="display:none"></div>
              </button>
              <button type="button" id="cancel-edit-vehicle" class="btn" style="display:none">Annuler</button>
            </div>
          </form>
        </div>

        <div class="form-section">
          <h2>Liste des Véhicules</h2>
          <table class="data-table">
            <thead>
              <tr><th>Photo</th><th>Immatriculation</th><th>Modèle</th><th>Couleur</th><th>Propriétaire</th><th>Actions</th></tr>
            </thead>
            <tbody id="vehicles-list"></tbody>
          </table>
        </div>
      </section>

      <!-- Interventions -->
      <section id="interventions-tab" class="tab-content">
        <div class="form-section">
          <h2>Nouvelle Intervention</h2>
          <form id="intervention-form">
            <div class="form-row">
              <div class="form-group">
                <label for="vehicule-intervention">Véhicule</label>
                <select id="vehicule-intervention" required>
                  <option value="">Sélectionner un véhicule</option>
                </select>
              </div>

              <div class="form-group">
                <label for="date-intervention">Date</label>
                <input type="date" id="date-intervention" required />
              </div>

              <div class="form-group">
                <label for="type-intervention">Type d'intervention (choisir ou écrire)</label>
                <input list="types-intervention" id="type-intervention" placeholder="Choisissez ou écrivez un type" required />
                <datalist id="types-intervention">
                  <option value="Vidange">
                  <option value="Réparation">
                  <option value="Contrôle technique">
                  <option value="Carrosserie">
                  <option value="Électricité">
                </datalist>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="mecaniciens">Mécaniciens (sélection multiple)</label>
                <select id="mecaniciens" multiple>
                  <option value="1">YOBOUET SYLVIN</option>
                  <option value="2">KHALIL HUSSEIN</option>
                  <option value="3">NIANKINE YOUSSOUF</option>
                  <option value="4">OUATTARA ISSIF</option>
                  <option value="5">BABA DRAMANE</option>
                  <option value="6">KONE SAIDOU</option>
                  <option value="7">TRAORE ABDELATIF</option>
                  <option value="8">KOUAME K WILLIAM</option>
                  <option value="9">DIABATE HASSAN</option>
                  <option value="10">MOHAMED</option>
                  <option value="11">MANBONNE A AZIZ</option>
                  <option value="12">TOUVOLI KEVIN</option>
                  <option value="13">TOURE OTHNIEL</option>
                  <option value="14">VEHI EBENEZER</option>
                </select>
                <div class="select-hint">Ctrl/Cmd + clic pour multi-sélection (ou appuyez longuement sur mobile)</div>
              </div>

              <div class="form-group">
                <label for="pieces">Pièces utilisées</label>
                <textarea id="pieces" placeholder="Liste des pièces utilisées..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="bons-livraison">Bons de livraison (photos)</label>
                <input type="file" id="bons-livraison" accept="image/*" multiple />
                <div class="select-hint">Vous pouvez sélectionner plusieurs photos - Taille max: 5MB par fichier</div>
                <div id="delivery-files-preview" class="delivery-files-container"></div>
              </div>

              <div class="form-group">
                <label for="statut">Statut</label>
                <select id="statut" required>
                  <option value="en-attente">En attente</option>
                  <option value="en-cours">En cours</option>
                  <option value="termine">Terminé</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="observations">Observations</label>
                <textarea id="observations" placeholder="Observations..."></textarea>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <span class="btn-text">Enregistrer l'intervention</span>
                <div class="spinner" style="display:none"></div>
              </button>
            </div>
          </form>
        </div>

        <div class="form-section">
          <h2>Interventions Récentes</h2>
          <table class="data-table">
            <thead>
              <tr><th>Véhicule</th><th>Date</th><th>Type</th><th>Mécaniciens</th><th>Bons livraison</th><th>Statut</th><th>Actions</th></tr>
            </thead>
            <tbody id="interventions-list"></tbody>
          </table>
        </div>
      </section>

      <!-- Flux véhicules -->
      <section id="flux-tab" class="tab-content">
        <div class="form-section">
          <h2>Flux des véhicules - Aujourd'hui</h2>
          <div class="flux-container">
            <div class="flux-column">
              <h3>Véhicules entrés aujourd'hui</h3>
              <div id="flux-entrees"></div>
            </div>
            <div class="flux-column">
              <h3>Véhicules en cours de réparation</h3>
              <div id="flux-en-cours"></div>
            </div>
            <div class="flux-column">
              <h3>Véhicules sortis aujourd'hui</h3>
              <div id="flux-sorties"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Search -->
      <section id="search-tab" class="tab-content">
        <div class="form-section">
          <h2>Recherche avancée</h2>
          <div class="search-filters">
            <input type="text" id="search-immatriculation" placeholder="Immatriculation" />
            <input type="text" id="search-modele" placeholder="Modèle" />
            <input type="text" id="search-couleur" placeholder="Couleur" />
            <input type="date" id="search-date" />
            <select id="search-type">
              <option value="">Type d'intervention</option>
              <option value="Vidange">Vidange</option>
              <option value="Réparation">Réparation</option>
              <option value="Contrôle technique">Contrôle technique</option>
              <option value="Carrosserie">Carrosserie</option>
              <option value="Électricité">Électricité</option>
            </select>
            <select id="search-statut">
              <option value="">Statut</option>
              <option value="en-attente">En attente</option>
              <option value="en-cours">En cours</option>
              <option value="termine">Terminé</option>
            </select>
          </div>
          <div class="form-actions">
            <button id="search-button" class="btn btn-primary">Rechercher</button>
            <button id="reset-search" class="btn">Réinitialiser</button>
          </div>
        </div>

        <div class="form-section">
          <h2>Résultats de la Recherche</h2>
          <div id="search-results-count"></div>
          <table class="data-table">
            <thead>
              <tr><th>Photo</th><th>Immatriculation</th><th>Modèle</th><th>Couleur</th><th>Propriétaire</th><th>Dernière intervention</th><th>Statut</th><th>Actions</th></tr>
            </thead>
            <tbody id="search-results"></tbody>
          </table>
        </div>
      </section>

      <!-- Stats -->
      <section id="stats-tab" class="tab-content">
        <div class="form-section">
          <h2>Statistiques des interventions</h2>
          <div class="stats-cards">
            <div class="stat-card">
              <h3>Total interventions</h3>
              <div class="number" id="total-interventions">0</div>
            </div>
            <div class="stat-card">
              <h3>Vidanges ce mois</h3>
              <div class="number" id="month-oil-changes">0</div>
            </div>
            <div class="stat-card">
              <h3>Taux de completion</h3>
              <div class="number" id="completion-rate">0%</div>
            </div>
            <div class="stat-card">
              <h3>Véhicules en attente</h3>
              <div class="number" id="vehicles-waiting">0</div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>Réparations par mécanicien</h2>
          <table class="stats-table">
            <thead><tr><th>Mécanicien</th><th>Interventions</th><th>En cours</th><th>Terminées</th><th>Taux de réussite</th></tr></thead>
            <tbody id="mechanics-stats"></tbody>
          </table>
        </div>

        <div class="form-section">
          <h2>Types d'interventions les plus courants</h2>
          <table class="stats-table">
            <thead><tr><th>Type d'intervention</th><th>Nombre</th><th>Pourcentage</th><th>Visualisation</th></tr></thead>
            <tbody id="intervention-types-stats"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
<script>
  // Configuration Supabase sécurisée
  const getSupabaseConfig = () => {
    const supabaseUrl = window.VITE_SUPABASE_URL || 'https://xexmwdaeoxizvqecrmlo.supabase.co';
    const supabaseKey = window.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhleG13ZGFlb3hpenZxZWNybWxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTg5OTAsImV4cCI6MjA3NDI3NDk5MH0.nrMn4X0KFJISudffGDJZ0SM7XxKD2wOG2xOUMNsnWQo';
    
    if (!supabaseUrl || !supabaseKey) {
      console.error('Configuration Supabase manquante');
      showNotification("Erreur de configuration de l'application", "error");
      return null;
    }
    
    return { supabaseUrl, supabaseKey };
  };

  const config = getSupabaseConfig();
  if (!config) {
    throw new Error('Configuration Supabase non disponible');
  }

  const supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);

  // Local state
  let vehicles = [];
  let interventions = [];
  let currentEditingInterventionId = null;
  let deliveryFiles = [];
  let garageStock = [];

  // DOM elems
  const notification = document.getElementById('notification');

  // Debounce pour la recherche
  let searchTimeout;

  // Init when DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    initApp();
    loadData();
    setupEventListeners();
  });

  // ==================== CORRECTIONS APPLIQUÉES ====================

  // 1. CORRECTION DES MESSAGES DE SUCCÈS/ERREUR EN DOUBLE
  async function safeSupabaseOperation(operation, successMessage = null, loadingButton = null) {
    if (loadingButton) {
      setButtonLoading(loadingButton, true);
    }

    try {
      const { data, error } = await operation;
      
      if (error) {
        if (error.code === 'PGRST116') {
          if (successMessage) showNotification("Aucun résultat trouvé", "warning");
          return null;
        }
        if (error.code === '42501') {
          if (successMessage) showNotification("Permission refusée", "error");
          return null;
        }
        if (error.message.includes('JWT')) {
          if (successMessage) showNotification("Session expirée, veuillez vous reconnecter", "error");
          return null;
        }
        if (error.message.includes('network') || !navigator.onLine) {
          if (successMessage) showNotification("Connexion internet perdue", "error");
          return null;
        }
        throw error;
      }
      
      // CORRECTION : Afficher le message de succès UNIQUEMENT si l'opération a réussi
      if (successMessage && data !== null) {
        showNotification(successMessage);
      }
      return data;
      
    } catch (error) {
      console.error('Operation failed:', error);
      
      // CORRECTION : Afficher UN SEUL message d'erreur
      if (navigator.onLine) {
        showNotification("Erreur serveur, veuillez réessayer", "error");
      } else {
        showNotification("Connexion internet perdue", "error");
      }
      
      return null;
    } finally {
      if (loadingButton) {
        setButtonLoading(loadingButton, false);
      }
    }
  }

  // 2. CORRECTION DE LA MODIFICATION DES INTERVENTIONS
  async function updateIntervention(){
    const id = document.getElementById('edit-intervention-id').value;
    const vehiculeId = document.getElementById('edit-vehicule-intervention').value;
    const date = document.getElementById('edit-date-intervention').value;
    const type = document.getElementById('edit-type-intervention').value.trim();
    const mecaniciensElements = document.getElementById('edit-mecaniciens');
    const pieces = document.getElementById('edit-pieces').value.trim();
    const statut = document.getElementById('edit-statut').value;
    const observations = document.getElementById('edit-observations').value.trim();
    const submitButton = document.querySelector('#edit-intervention-form button[type="submit"]');

    if(!vehiculeId){ showNotification("Sélectionner un véhicule", "error"); return; }
    if(!date || !type){ showNotification("Date et type requis", "error"); return; }

    const mecaniciens = Array.from(mecaniciensElements.selectedOptions).map(o => o.text);
    const vehicle = vehicles.find(v => v.id == vehiculeId);
    if(!vehicle){ showNotification("Véhicule introuvable", "error"); return; }

    // CORRECTION : Gestion simplifiée des fichiers - Stockage en base64
    let newDeliveryUrls = [];
    if (deliveryFiles.length > 0) {
      try {
        for (const file of deliveryFiles) {
          validateFile(file);
          // Convertir en base64 au lieu d'uploader vers Supabase
          const base64String = await fileToBase64(file);
          newDeliveryUrls.push(base64String);
        }
      } catch (error) {
        console.error("Error processing delivery files:", error);
        showNotification("Erreur lors du traitement des photos: " + error.message, "error");
        return;
      }
    }

    const existingIntervention = interventions.find(i => i.id === id);
    const existingDeliveryUrls = existingIntervention.delivery_files || [];

    const updatedIntervention = {
      vehicule_id: vehicle.id,
      immatriculation: vehicle.immatriculation,
      modele: vehicle.modele,
      date, type, mecaniciens, pieces, statut, observations,
      delivery_files: [...existingDeliveryUrls, ...newDeliveryUrls]
    };

    const result = await safeSupabaseOperation(
      supabase
        .from('interventions')
        .update(updatedIntervention)
        .eq('id', id),
      "Intervention modifiée avec succès!",
      submitButton
    );
    
    if (result !== null) {
      // CORRECTION : Mise à jour immédiate de l'interface
      const index = interventions.findIndex(i => i.id === id);
      if(index !== -1) {
        interventions[index] = { ...interventions[index], ...updatedIntervention };
      }
      
      updateUI();
      updateGarageStock();
      document.getElementById('intervention-modal').style.display = 'none';
      currentEditingInterventionId = null;
      deliveryFiles = [];
      
      // CORRECTION : Forcer le rechargement des données
      setTimeout(() => {
        loadData();
      }, 500);
    }
  }

  // 3. NOUVELLE SOLUTION POUR LES PHOTOS - STOCKAGE BASE64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

  function base64ToImageUrl(base64String) {
    return base64String; // Base64 est directement utilisable comme URL
  }

  // 4. CORRECTION DE L'AJOUT D'INTERVENTION
  async function addIntervention(){
    const vehiculeId = document.getElementById('vehicule-intervention').value;
    const date = document.getElementById('date-intervention').value;
    const type = document.getElementById('type-intervention').value.trim();
    const mecaniciensElements = document.getElementById('mecaniciens');
    const pieces = document.getElementById('pieces').value.trim();
    const statut = document.getElementById('statut').value;
    const observations = document.getElementById('observations').value.trim();
    const submitButton = document.querySelector('#intervention-form button[type="submit"]');

    if(!vehiculeId){ showNotification("Sélectionner un véhicule", "error"); return; }
    if(!date || !type){ showNotification("Date et type requis", "error"); return; }

    const mecaniciens = Array.from(mecaniciensElements.selectedOptions).map(o => o.text);
    const vehicle = vehicles.find(v => v.id == vehiculeId);
    if(!vehicle){ showNotification("Véhicule introuvable", "error"); return; }

    // CORRECTION : Utilisation de base64 pour les photos
    let deliveryUrls = [];
    if (deliveryFiles.length > 0) {
      try {
        for (const file of deliveryFiles) {
          validateFile(file);
          const base64String = await fileToBase64(file);
          deliveryUrls.push(base64String);
        }
      } catch (error) {
        console.error("Error processing delivery files:", error);
        showNotification("Erreur lors du traitement des photos: " + error.message, "error");
        return;
      }
    }

    const newIntervention = {
      vehicule_id: vehicle.id,
      immatriculation: vehicle.immatriculation,
      modele: vehicle.modele,
      date, 
      type, 
      mecaniciens, 
      pieces, 
      statut, 
      observations,
      delivery_files: deliveryUrls
    };

    const result = await safeSupabaseOperation(
      supabase
        .from('interventions')
        .insert([newIntervention])
        .select(),
      "Intervention enregistrée avec succès!",
      submitButton
    );
    
    if (result) {
      interventions.push(result[0]);
      updateUI();
      updateGarageStock();
      
      // CORRECTION : Réinitialisation complète du formulaire
      document.getElementById('intervention-form').reset();
      document.getElementById('delivery-files-preview').innerHTML = '';
      deliveryFiles = [];
      document.getElementById('date-intervention').value = new Date().toISOString().split('T')[0];
      
      // Recharger les données pour s'assurer de la synchronisation
      setTimeout(() => {
        loadData();
      }, 500);
    }
  }

  // 5. CORRECTION DE L'AJOUT DE VÉHICULE AVEC PHOTOS
  async function addVehicle(){
    const immatriculation = document.getElementById('immatriculation').value.trim();
    const modele = document.getElementById('modele').value.trim();
    const couleur = document.getElementById('couleur').value.trim();
    const proprietaire = document.getElementById('proprietaire').value.trim();
    const telephone = document.getElementById('telephone').value.trim();
    const photoInput = document.getElementById('photo');
    const editingId = document.getElementById('vehicle-form').dataset.editingId;
    const submitButton = document.querySelector('#vehicle-form button[type="submit"]');

    const validationErrors = validateVehicleData({ immatriculation, modele, couleur, proprietaire, telephone });
    if (validationErrors.length > 0) {
      showNotification(validationErrors.join(', '), "error");
      return;
    }

    if(!immatriculation || !modele) { 
      showNotification("Immatriculation et modèle requis", "error"); 
      return; 
    }

    if (vehicles.some(v => v.immatriculation === immatriculation && v.id !== editingId)) {
      showNotification("Cette immatriculation est déjà utilisée!", "error");
      return;
    }

    let photoUrl = 'https://via.placeholder.com/100x70?text=Vehicle';
    
    // CORRECTION : Utilisation de base64 pour les photos de véhicules
    if(photoInput && photoInput.files && photoInput.files[0]) {
      try {
        const file = photoInput.files[0];
        validateFile(file);
        photoUrl = await fileToBase64(file);
      } catch (error) {
        console.error("Error processing vehicle photo:", error);
        showNotification("Erreur lors du traitement de la photo: " + error.message, "error");
        return;
      }
    } else if (editingId) {
      const existingVehicle = vehicles.find(v => v.id === editingId);
      if (existingVehicle) {
        photoUrl = existingVehicle.photo;
      }
    }

    const vehicleData = {
      immatriculation, 
      modele, 
      couleur, 
      proprietaire, 
      telephone, 
      photo: photoUrl
    };

    let operation;
    if (editingId) {
      operation = supabase
        .from('vehicles')
        .update(vehicleData)
        .eq('id', editingId);
    } else {
      operation = supabase
        .from('vehicles')
        .insert([vehicleData])
        .select();
    }

    const result = await safeSupabaseOperation(
      operation,
      editingId ? "Véhicule modifié avec succès!" : "Véhicule ajouté avec succès!",
      submitButton
    );
    
    if (result) {
      if (editingId) {
        const index = vehicles.findIndex(v => v.id === editingId);
        if (index !== -1) {
          vehicles[index] = { ...vehicles[index], ...vehicleData };
        }
      } else {
        vehicles.push(result[0]);
      }
      
      updateUI();
      resetVehicleForm();
      
      // Recharger les données
      setTimeout(() => {
        loadData();
      }, 500);
    }
  }

  // ==================== FONCTIONS EXISTANTES AVEC CORRECTIONS ====================

  function setButtonLoading(button, isLoading) {
    const btnText = button.querySelector('.btn-text');
    const spinner = button.querySelector('.spinner');
    
    if (isLoading) {
      button.disabled = true;
      if (btnText) btnText.style.display = 'none';
      if (spinner) spinner.style.display = 'inline-block';
    } else {
      button.disabled = false;
      if (btnText) btnText.style.display = 'inline';
      if (spinner) spinner.style.display = 'none';
    }
  }

  function validateVehicleData(vehicle) {
    const errors = [];
    
    if (!vehicle.immatriculation || vehicle.immatriculation.trim().length < 2) {
      errors.push("L'immatriculation est requise");
    }
    
    const dangerousChars = /[<>]/;
    if (dangerousChars.test(vehicle.modele) || dangerousChars.test(vehicle.proprietaire) || dangerousChars.test(vehicle.couleur)) {
      errors.push("Caractères dangereux détectés dans les champs texte");
    }
    
    if (vehicle.telephone && !/^[\+]?[0-9\s\-\(\)]{10,}$/.test(vehicle.telephone)) {
      errors.push("Format de téléphone invalide");
    }
    
    return errors;
  }

  function validateFile(file, maxSizeMB = 5) {
    const maxSize = maxSizeMB * 1024 * 1024;
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    
    if (file.size > maxSize) {
      throw new Error(`Fichier trop volumineux (max ${maxSizeMB}MB)`);
    }
    
    if (!allowedTypes.includes(file.type)) {
      throw new Error('Type de fichier non supporté. Utilisez JPG, PNG ou WebP');
    }
    
    return true;
  }

  // Gestion du stock garage
  async function syncGarageStock() {
    try {
      const { data, error } = await supabase
        .from('garage_stock')
        .select('vehicle_id, entry_date, exit_date, status')
        .is('exit_date', null);
      
      if (error) throw error;
      
      garageStock = data.map(item => item.vehicle_id);
      saveGarageStock();
      updateStockDisplay();
      
    } catch (error) {
      console.error('Erreur synchronisation stock:', error);
      loadGarageStock();
    }
  }

  async function updateGarageStock() {
    const today = new Date().toISOString().split('T')[0];
    
    try {
      const todayInterventions = interventions.filter(i => i.date === today);
      
      for (const intervention of todayInterventions) {
        if (intervention.statut === 'termine') {
          await safeSupabaseOperation(
            supabase
              .from('garage_stock')
              .update({ exit_date: today })
              .eq('vehicle_id', intervention.vehicule_id)
              .is('exit_date', null)
          );
        } else {
          const { data: existing } = await supabase
            .from('garage_stock')
            .select('id')
            .eq('vehicle_id', intervention.vehicule_id)
            .is('exit_date', null)
            .single();
            
          if (!existing) {
            await safeSupabaseOperation(
              supabase
                .from('garage_stock')
                .insert([{
                  vehicle_id: intervention.vehicule_id,
                  entry_date: today,
                  intervention_id: intervention.id
                }])
            );
          }
        }
      }
      
      await syncGarageStock();
      
    } catch (error) {
      console.error('Erreur mise à jour stock:', error);
      fallbackStockUpdate();
    }
  }

  function fallbackStockUpdate() {
    const today = new Date().toISOString().split('T')[0];
    
    const vehiclesInGarage = [...garageStock];
    
    const vehiclesEnteredToday = interventions
      .filter(i => i.date === today)
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean)
      .filter(v => !garageStock.includes(v.id));
    
    vehiclesEnteredToday.forEach(v => {
      if (!garageStock.includes(v.id)) {
        garageStock.push(v.id);
      }
    });
    
    const vehiclesExitedToday = interventions
      .filter(i => i.date === today && i.statut === 'termine')
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i);
    
    vehiclesExitedToday.forEach(id => {
      const index = garageStock.indexOf(id);
      if (index > -1) {
        garageStock.splice(index, 1);
      }
    });
    
    saveGarageStock();
    updateStockDisplay();
  }

  function loadGarageStock() {
    const savedStock = localStorage.getItem('garageStock');
    if (savedStock) {
      garageStock = JSON.parse(savedStock);
    }
  }

  function saveGarageStock() {
    localStorage.setItem('garageStock', JSON.stringify(garageStock));
  }

  function updateStockDisplay() {
    const today = new Date().toISOString().split('T')[0];
    
    const vehiclesEnteredToday = interventions
      .filter(i => i.date === today)
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean)
      .filter(v => !garageStock.includes(v.id));

    const vehiclesExitedToday = interventions
      .filter(i => i.date === today && i.statut === 'termine')
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i);

    const interventionsInProgress = interventions.filter(i => i.statut === 'en-cours').length;
    
    document.getElementById('vehicles-stock').textContent = garageStock.length;
    document.getElementById('vehicles-entered-today').textContent = vehiclesEnteredToday.length;
    document.getElementById('vehicles-exited-today').textContent = vehiclesExitedToday.length;
    document.getElementById('interventions-in-progress').textContent = interventionsInProgress;
  }

  // Fonction pour afficher les détails du véhicule
  function showVehicleDetails(vehicleId) {
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (!vehicle) return;
    
    const interventionsForVehicle = interventions.filter(i => i.vehicule_id === vehicleId)
      .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let detailsHtml = `
      <div class="vehicle-details-grid">
        <div>
          <img src="${vehicle.photo}" class="vehicle-details-photo" alt="Photo du véhicule" onerror="this.src='https://via.placeholder.com/300x200?text=Vehicle'">
        </div>
        <div>
          <h3>Informations du véhicule</h3>
          <p><strong>Immatriculation:</strong> ${vehicle.immatriculation}</p>
          <p><strong>Modèle:</strong> ${vehicle.modele}</p>
          <p><strong>Couleur:</strong> ${vehicle.couleur}</p>
          <p><strong>Propriétaire:</strong> ${vehicle.proprietaire || 'Non renseigné'}</p>
          <p><strong>Téléphone:</strong> ${vehicle.telephone || 'Non renseigné'}</p>
        </div>
      </div>
    `;
    
    if (interventionsForVehicle.length > 0) {
      detailsHtml += `
        <h3>Historique des interventions (${interventionsForVehicle.length})</h3>
        <div class="intervention-history">
      `;
      
      interventionsForVehicle.forEach(intervention => {
        const statusClass = intervention.statut.replace('-', ' ');
        detailsHtml += `
          <div class="intervention-item ${statusClass}">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
              <div>
                <strong>${intervention.type}</strong> - ${formatDate(intervention.date)}
              </div>
              <span class="status-badge status-${intervention.statut}">${intervention.statut}</span>
            </div>
            <p><strong>Mécaniciens:</strong> ${intervention.mecaniciens.join(', ')}</p>
            ${intervention.pieces ? `<p><strong>Pièces utilisées:</strong> ${intervention.pieces}</p>` : ''}
            ${intervention.observations ? `<p><strong>Observations:</strong> ${intervention.observations}</p>` : ''}
            <div style="margin-top: 10px;">
              <button class="btn-edit btn-sm" onclick="editIntervention('${intervention.id}'); closeModal('vehicle-details-modal')">
                <i class="fas fa-edit"></i> Modifier
              </button>
            </div>
          </div>
        `;
      });
      
      detailsHtml += `</div>`;
    } else {
      detailsHtml += '<p style="text-align: center; padding: 20px;">Aucune intervention enregistrée pour ce véhicule.</p>';
    }
    
    document.getElementById('vehicle-details-content').innerHTML = detailsHtml;
    document.getElementById('vehicle-details-modal').style.display = 'flex';
  }

  // Statistiques
  function updateStats(){
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const monthlyOil = interventions.filter(i=>{
      const d = new Date(i.date);
      return i.type.toLowerCase() === 'vidange' && d.getMonth()===currentMonth && d.getFullYear()===currentYear;
    }).length;

    const vehiclesInWaiting = [...new Set(
      interventions
        .filter(i => i.statut === 'en-attente')
        .map(i => i.vehicule_id)
    )].length;

    document.getElementById('vehicles-waiting').textContent = vehiclesInWaiting;

    document.getElementById('total-interventions').textContent = interventions.length;
    document.getElementById('month-oil-changes').textContent = monthlyOil;
    
    const completed = interventions.filter(i=>i.statut==='termine').length;
    document.getElementById('completion-rate').textContent = interventions.length>0 ? Math.round((completed/interventions.length)*100) + '%' : '0%';

    const mechanicsStats = {};
    interventions.forEach(i=>{
      (i.mecaniciens||[]).forEach(m=>{
        if(!mechanicsStats[m]) mechanicsStats[m] = { total:0, inProgress:0, completed:0 };
        mechanicsStats[m].total++;
        if(i.statut==='en-cours') mechanicsStats[m].inProgress++;
        if(i.statut==='termine') mechanicsStats[m].completed++;
      });
    });

    const container = document.getElementById('mechanics-stats');
    container.innerHTML = '';
    Object.keys(mechanicsStats).forEach(m=>{
      const successRate = mechanicsStats[m].total > 0 ? 
        Math.round((mechanicsStats[m].completed / mechanicsStats[m].total) * 100) : 0;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${m}</td>
        <td>${mechanicsStats[m].total}</td>
        <td>${mechanicsStats[m].inProgress}</td>
        <td>${mechanicsStats[m].completed}</td>
        <td>${successRate}%</td>
      `;
      container.appendChild(row);
    });

    const typeStats = {};
    interventions.forEach(i => {
      if(!typeStats[i.type]) typeStats[i.type] = 0;
      typeStats[i.type]++;
    });

    const typeContainer = document.getElementById('intervention-types-stats');
    typeContainer.innerHTML = '';
    
    const sortedTypes = Object.entries(typeStats)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    sortedTypes.forEach(([type, count]) => {
      const percentage = interventions.length > 0 ? Math.round((count / interventions.length) * 100) : 0;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${type}</strong></td>
        <td style="text-align: center; font-weight: 700;">${count}</td>
        <td style="text-align: center; font-weight: 600; color: #27ae60;">${percentage}%</td>
        <td>
          <div class="percentage-bar">
            <div class="percentage-fill" style="width: ${percentage}%"></div>
          </div>
        </td>
      `;
      typeContainer.appendChild(row);
    });

    if (sortedTypes.length === 0) {
      typeContainer.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">Aucune intervention enregistrée</td></tr>';
    }
  }

  // ==================== FONCTIONS D'INITIALISATION ====================

  function initApp(){
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('date-intervention');
    const journalDateInput = document.getElementById('journal-date');
    
    if(dateInput) dateInput.value = today;
    if(journalDateInput) journalDateInput.value = today;
    
    const photoInput = document.getElementById('photo');
    if(photoInput) {
      photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
          try {
            validateFile(file);
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.getElementById('photo-preview');
              preview.src = e.target.result;
              preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          } catch (error) {
            showNotification(error.message, "error");
            photoInput.value = '';
          }
        }
      });
    }

    const deliveryInput = document.getElementById('bons-livraison');
    const editDeliveryInput = document.getElementById('edit-bons-livraison');
    
    if(deliveryInput) {
      deliveryInput.addEventListener('change', handleDeliveryFiles);
    }
    if(editDeliveryInput) {
      editDeliveryInput.addEventListener('change', handleEditDeliveryFiles);
    }

    document.querySelectorAll('.modal-close').forEach(closeBtn => {
      closeBtn.addEventListener('click', function() {
        this.closest('.modal').style.display = 'none';
      });
    });

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });
    });

    loadGarageStock();
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }

  // Gestion des fichiers de bons de livraison
  async function handleDeliveryFiles(e) {
    const files = Array.from(e.target.files);
    const previewContainer = document.getElementById('delivery-files-preview');
    previewContainer.innerHTML = '';
    
    const validFiles = [];
    
    for (const file of files) {
      try {
        validateFile(file);
        validFiles.push(file);
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileItem = document.createElement('div');
          fileItem.className = 'delivery-file-item';
          fileItem.innerHTML = `
            <img src="${e.target.result}" class="delivery-file-preview" alt="Aperçu bon de livraison">
            <div class="delivery-file-name">${file.name}</div>
            <div class="remove-delivery-file" onclick="removeDeliveryFile(${validFiles.length - 1})">
              <i class="fas fa-times"></i> Supprimer
            </div>
          `;
          previewContainer.appendChild(fileItem);
        };
        reader.readAsDataURL(file);
        
      } catch (error) {
        showNotification(`Fichier "${file.name}" rejeté: ${error.message}`, "error");
      }
    }
    
    deliveryFiles = validFiles;
    e.target.value = '';
  }

  async function handleEditDeliveryFiles(e) {
    const files = Array.from(e.target.files);
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    
    const validFiles = [];
    
    for (const file of files) {
      try {
        validateFile(file);
        validFiles.push(file);
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileItem = document.createElement('div');
          fileItem.className = 'delivery-file-item';
          fileItem.innerHTML = `
            <img src="${e.target.result}" class="delivery-file-preview" alt="Aperçu bon de livraison">
            <div class="delivery-file-name">${file.name}</div>
            <div class="remove-delivery-file" onclick="removeEditDeliveryFile(${deliveryFiles.length + validFiles.length - 1})">
              <i class="fas fa-times"></i> Supprimer
            </div>
          `;
          previewContainer.appendChild(fileItem);
        };
        reader.readAsDataURL(file);
        
      } catch (error) {
        showNotification(`Fichier "${file.name}" rejeté: ${error.message}`, "error");
      }
    }
    
    deliveryFiles = [...deliveryFiles, ...validFiles];
    e.target.value = '';
  }

  function removeDeliveryFile(index) {
    deliveryFiles.splice(index, 1);
    const previewContainer = document.getElementById('delivery-files-preview');
    previewContainer.innerHTML = '';
    
    deliveryFiles.forEach((file, newIndex) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${e.target.result}" class="delivery-file-preview" alt="Aperçu bon de livraison">
          <div class="delivery-file-name">${file.name}</div>
          <div class="remove-delivery-file" onclick="removeDeliveryFile(${newIndex})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      };
      reader.readAsDataURL(file);
    });
  }

  function removeEditDeliveryFile(index) {
    deliveryFiles.splice(index, 1);
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    previewContainer.innerHTML = '';
    
    deliveryFiles.forEach((file, newIndex) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${e.target.result}" class="delivery-file-preview" alt="Aperçu bon de livraison">
          <div class="delivery-file-name">${file.name}</div>
          <div class="remove-delivery-file" onclick="removeEditDeliveryFile(${newIndex})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      };
      reader.readAsDataURL(file);
    });
  }

  async function removeExistingDeliveryFile(interventionId, fileIndex) {
    if(!confirm("Êtes-vous sûr de vouloir supprimer ce bon de livraison?")) return;
    
    try {
      const intervention = interventions.find(i => i.id === interventionId);
      if (intervention && intervention.delivery_files) {
        intervention.delivery_files.splice(fileIndex, 1);
        
        await safeSupabaseOperation(
          supabase
            .from('interventions')
            .update({ delivery_files: intervention.delivery_files })
            .eq('id', interventionId),
          "Bon de livraison supprimé avec succès"
        );
        
        editIntervention(interventionId);
      }
    } catch (error) {
      console.error("Error deleting delivery file:", error);
      showNotification("Erreur lors de la suppression du bon de livraison", "error");
    }
  }

  // Load from Supabase
  async function loadData(){
    try {
      const vehiclesData = await safeSupabaseOperation(
        supabase.from('vehicles').select('*')
      );
      vehicles = vehiclesData || [];

      const interventionsData = await safeSupabaseOperation(
        supabase.from('interventions').select('*')
      );
      interventions = interventionsData || [];

      await syncGarageStock();
      
      updateUI();
    } catch (err) {
      console.error("Load error", err);
    }
  }

  function setupEventListeners(){
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if(mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        mainContent.classList.toggle('sidebar-open');
      });
    }

    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function(){
        switchTab(this.dataset.tab);
        document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
        this.classList.add('active');
        
        if(window.innerWidth <= 768) {
          sidebar.classList.remove('open');
          mainContent.classList.remove('sidebar-open');
        }
      });
    });

    const vehicleForm = document.getElementById('vehicle-form');
    if(vehicleForm) vehicleForm.addEventListener('submit', e => { e.preventDefault(); addVehicle(); });

    const interventionForm = document.getElementById('intervention-form');
    if(interventionForm) interventionForm.addEventListener('submit', e => { e.preventDefault(); addIntervention(); });

    const editInterventionForm = document.getElementById('edit-intervention-form');
    if(editInterventionForm) editInterventionForm.addEventListener('submit', e => { e.preventDefault(); updateIntervention(); });

    const searchBtn = document.getElementById('search-button');
    if(searchBtn) searchBtn.addEventListener('click', performSearch);

    const resetSearchBtn = document.getElementById('reset-search');
    if(resetSearchBtn) resetSearchBtn.addEventListener('click', resetSearch);

    const globalSearch = document.getElementById('global-search');
    if(globalSearch) globalSearch.addEventListener('input', e => performGlobalSearch(e.target.value));

    const journalFilter = document.getElementById('journal-filter');
    if(journalFilter) journalFilter.addEventListener('click', updateJournalComplet);

    const journalReset = document.getElementById('journal-reset');
    if(journalReset) journalReset.addEventListener('click', resetJournal);

    const quickAddVehicle = document.getElementById('quick-add-vehicle');
    if(quickAddVehicle) quickAddVehicle.addEventListener('click', () => {
      switchTab('vehicles');
      document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
      document.querySelector('[data-tab="vehicles"]').classList.add('active');
    });

    const quickAddIntervention = document.getElementById('quick-add-intervention');
    if(quickAddIntervention) quickAddIntervention.addEventListener('click', () => {
      switchTab('interventions');
      document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
      document.querySelector('[data-tab="interventions"]').classList.add('active');
    });

    const cancelEdit = document.getElementById('cancel-edit');
    if(cancelEdit) cancelEdit.addEventListener('click', () => {
      document.getElementById('intervention-modal').style.display = 'none';
      currentEditingInterventionId = null;
      deliveryFiles = [];
    });

    const cancelEditVehicle = document.getElementById('cancel-edit-vehicle');
    if(cancelEditVehicle) cancelEditVehicle.addEventListener('click', resetVehicleForm);
  }

  function switchTab(tabName){
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    const el = document.getElementById(tabName + '-tab');
    if(el) el.classList.add('active');
  }

  // Edit intervention
  function editIntervention(id){
    const intervention = interventions.find(i => i.id === id);
    if(!intervention) return;
    
    currentEditingInterventionId = id;
    deliveryFiles = [];
    
    document.getElementById('edit-intervention-id').value = id;
    document.getElementById('edit-vehicule-intervention').value = intervention.vehicule_id;
    document.getElementById('edit-date-intervention').value = intervention.date;
    document.getElementById('edit-type-intervention').value = intervention.type;
    document.getElementById('edit-pieces').value = intervention.pieces || '';
    document.getElementById('edit-statut').value = intervention.statut;
    document.getElementById('edit-observations').value = intervention.observations || '';
    
    const previewContainer = document.getElementById('edit-delivery-files-preview');
    previewContainer.innerHTML = '';
    if (intervention.delivery_files && intervention.delivery_files.length > 0) {
      intervention.delivery_files.forEach((url, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'delivery-file-item';
        fileItem.innerHTML = `
          <img src="${url}" class="delivery-file-preview" alt="Bon de livraison">
          <div class="delivery-file-name">Bon de livraison ${index + 1}</div>
          <div class="remove-delivery-file" onclick="removeExistingDeliveryFile('${id}', ${index})">
            <i class="fas fa-times"></i> Supprimer
          </div>
        `;
        previewContainer.appendChild(fileItem);
      });
    }
    
    const mecaniciensSelect = document.getElementById('edit-mecaniciens');
    Array.from(mecaniciensSelect.options).forEach(option => {
      option.selected = intervention.mecaniciens.includes(option.text);
    });
    
    document.getElementById('intervention-modal').style.display = 'flex';
  }

  function resetVehicleForm() {
    document.getElementById('vehicle-form').reset();
    delete document.getElementById('vehicle-form').dataset.editingId;
    document.querySelector('#vehicle-form .btn-text').textContent = 'Enregistrer le véhicule';
    document.getElementById('cancel-edit-vehicle').style.display = 'none';
    document.getElementById('photo-preview').style.display = 'none';
  }

  // Search by filters
  function performSearch(){
    const immatriculation = (document.getElementById('search-immatriculation').value || '').toLowerCase();
    const modele = (document.getElementById('search-modele').value || '').toLowerCase();
    const couleur = (document.getElementById('search-couleur').value || '').toLowerCase();
    const date = document.getElementById('search-date').value;
    const type = document.getElementById('search-type').value;
    const statut = document.getElementById('search-statut').value;

    let results = vehicles.slice();

    if(immatriculation) results = results.filter(v => v.immatriculation.toLowerCase().includes(immatriculation));
    if(modele) results = results.filter(v => v.modele.toLowerCase().includes(modele));
    if(couleur) results = results.filter(v => v.couleur.toLowerCase().includes(couleur));

    if(date || type || statut) {
      const ids = interventions.filter(i => {
        let match = true;
        if(date) match = match && i.date === date;
        if(type) match = match && i.type === type;
        if(statut) match = match && i.statut === statut;
        return match;
      }).map(i => i.vehicule_id);
      results = results.filter(v => ids.includes(v.id));
    }

    const resultsContainer = document.getElementById('search-results');
    const resultsCount = document.getElementById('search-results-count');
    resultsContainer.innerHTML = '';
    
    if(results.length === 0){
      resultsContainer.innerHTML = '<tr><td colspan="8" style="text-align:center">Aucun résultat trouvé</td></tr>';
      resultsCount.innerHTML = '<p>Aucun résultat trouvé</p>';
      return;
    }

    resultsCount.innerHTML = '<p>' + results.length + ' résultat(s) trouvé(s)</p>';

    results.forEach(vehicle => {
      const lastIntervention = interventions
        .filter(i => i.vehicule_id === vehicle.id)
        .sort((a,b)=> new Date(b.date) - new Date(a.date))[0];

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><img src="${vehicle.photo}" class="vehicle-photo" alt="photo" loading="lazy" onerror="this.src='https://via.placeholder.com/100x70?text=Vehicle'"></td>
        <td>${vehicle.immatriculation}</td>
        <td>${vehicle.modele}</td>
        <td>${vehicle.couleur}</td>
        <td>${vehicle.proprietaire || ''}</td>
        <td>${lastIntervention ? lastIntervention.type + ' (' + formatDate(lastIntervention.date) + ')' : 'Aucune'}</td>
        <td>${lastIntervention ? '<span class="status-badge status-' + lastIntervention.statut + '">' + lastIntervention.statut + '</span>' : 'N/A'}</td>
        <td class="action-buttons">
          <button class="btn-edit" onclick="editVehicle('${vehicle.id}')">Modifier</button>
          <button class="btn-delete" onclick="deleteVehicle('${vehicle.id}')">Supprimer</button>
          <button class="btn-details" onclick="showVehicleDetails('${vehicle.id}')">Détails</button>
        </td>
      `;
      resultsContainer.appendChild(tr);
    });
  }

  function resetSearch(){
    document.getElementById('search-immatriculation').value = '';
    document.getElementById('search-modele').value = '';
    document.getElementById('search-couleur').value = '';
    document.getElementById('search-date').value = '';
    document.getElementById('search-type').value = '';
    document.getElementById('search-statut').value = '';
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('search-results-count').innerHTML = '';
  }

  // Global search (simple) avec debounce
  function performGlobalSearch(query){
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if(!query || query.length < 2) return;
      query = query.toLowerCase();

      const results = [
        ...vehicles.filter(v => v.immatriculation.toLowerCase().includes(query) || v.modele.toLowerCase().includes(query) || (v.proprietaire || '').toLowerCase().includes(query)),
        ...interventions.filter(i => i.immatriculation.toLowerCase().includes(query) || (i.type || '').toLowerCase().includes(query) || i.mecaniciens.some(m => m.toLowerCase().includes(query))).map(i => vehicles.find(v=>v.id===i.vehicule_id)).filter(Boolean)
      ];

      const unique = [...new Map(results.map(r => [r.id, r])).values()];
      if(unique.length) showNotification(unique.length + ' résultat(s) trouvé(s) pour "' + query + '"');
    }, 300);
  }

  // Update flux
  function updateFlux(){
    const today = new Date().toISOString().split('T')[0];
    
    const vehiclesEntered = interventions
      .filter(i => i.date === today)
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    const vehiclesInProgress = interventions
      .filter(i => i.date === today && i.statut === 'en-cours')
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    const vehiclesExited = interventions
      .filter(i => i.date === today && i.statut === 'termine')
      .map(i => i.vehicule_id)
      .filter((v, i, a) => a.indexOf(v) === i)
      .map(id => vehicles.find(v => v.id === id))
      .filter(Boolean);
    
    const entreesContainer = document.getElementById('flux-entrees');
    const enCoursContainer = document.getElementById('flux-en-cours');
    const sortiesContainer = document.getElementById('flux-sorties');
    
    entreesContainer.innerHTML = vehiclesEntered.length ? 
      vehiclesEntered.map(v => `
        <div class="flux-item entree">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun véhicule entré</p>';
    
    enCoursContainer.innerHTML = vehiclesInProgress.length ? 
      vehiclesInProgress.map(v => `
        <div class="flux-item">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun véhicule en cours</p>';
    
    sortiesContainer.innerHTML = vehiclesExited.length ? 
      vehiclesExited.map(v => `
        <div class="flux-item sortie">
          <div class="flux-item-header">
            <span class="flux-item-title">${v.immatriculation}</span>
          </div>
          <div class="flux-item-details">${v.modele} - ${v.couleur}</div>
        </div>
      `).join('') : '<p>Aucun véhicule sorti</p>';
  }

  // Journal complet des véhicules
  function updateJournalComplet() {
    const selectedDate = document.getElementById('journal-date').value;
    const selectedType = document.getElementById('journal-type').value;
    const selectedStatut = document.getElementById('journal-statut').value;
    
    let filteredInterventions = [...interventions];
    
    if (selectedDate) {
      filteredInterventions = filteredInterventions.filter(i => i.date === selectedDate);
    }
    
    if (selectedType) {
      filteredInterventions = filteredInterventions.filter(i => i.type === selectedType);
    }
    
    if (selectedStatut) {
      filteredInterventions = filteredInterventions.filter(i => i.statut === selectedStatut);
    }
    
    filteredInterventions.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const container = document.getElementById('journal-complet');
    container.innerHTML = '';
    
    if (filteredInterventions.length === 0) {
      container.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucune intervention trouvée</td></tr>';
      return;
    }
    
    filteredInterventions.forEach(intervention => {
      const vehicle = vehicles.find(v => v.id === intervention.vehicule_id);
      if (!vehicle) return;
      
      let deliveryPhotosHtml = 'Aucun';
      if (intervention.delivery_files && intervention.delivery_files.length > 0) {
        deliveryPhotosHtml = intervention.delivery_files.map(url => 
          `<img src="${url}" class="delivery-photo" alt="Bon livraison" title="Bon de livraison" loading="lazy" onerror="this.style.display='none'">`
        ).join('');
      }
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(intervention.date)}</td>
        <td>${vehicle.immatriculation} - ${vehicle.modele}</td>
        <td>${intervention.type}</td>
        <td>${intervention.mecaniciens.join(', ')}</td>
        <td>${deliveryPhotosHtml}</td>
        <td><span class="status-badge status-${intervention.statut}">${intervention.statut}</span></td>
        <td>${intervention.observations || ''}</td>
      `;
      container.appendChild(tr);
    });
  }

  function resetJournal() {
    document.getElementById('journal-date').value = '';
    document.getElementById('journal-type').value = '';
    document.getElementById('journal-statut').value = '';
    updateJournalComplet();
  }

  // UI updates
  function updateUI(){
    updateVehicleList();
    updateInterventionsList();
    updateVehicleSelect();
    updateStats();
    updateStockDisplay();
    updateFlux();
    updateJournalComplet();
  }

  function updateVehicleList(){
    const container = document.getElementById('vehicles-list');
    container.innerHTML = '';
    if(vehicles.length === 0) { 
        container.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucun véhicule enregistré</td></tr>'; 
        return; 
    }

    vehicles.forEach(vehicle => {
        const tr = document.createElement('tr');
        
        const imgHTML = `
            <img src="${vehicle.photo}" 
                 class="vehicle-photo" 
                 alt="photo" 
                 loading="lazy"
                 onerror="this.src='https://via.placeholder.com/100x70?text=Vehicle'; this.onerror=null;"
        `;

        tr.innerHTML = `
            <td style="width: 100px; min-width: 100px; max-width: 100px;">${imgHTML}</td>
            <td>${vehicle.immatriculation}</td>
            <td>${vehicle.modele}</td>
            <td>${vehicle.couleur}</td>
            <td>${vehicle.proprietaire || ''}</td>
            <td class="action-buttons">
                <button class="btn-edit" onclick="editVehicle('${vehicle.id}')">Modifier</button>
                <button class="btn-delete" onclick="deleteVehicle('${vehicle.id}')">Supprimer</button>
            </td>
        `;
        container.appendChild(tr);
    });
  }

  function updateInterventionsList(){
    const container = document.getElementById('interventions-list');
    container.innerHTML = '';
    if(interventions.length === 0) { 
      container.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucune intervention enregistrée</td></tr>'; 
      return; 
    }

    const sorted = [...interventions].sort((a,b)=> new Date(b.date) - new Date(a.date));
    sorted.forEach(i => {
      const vehicle = vehicles.find(v=>v.id===i.vehicule_id);
      if(!vehicle) return;
      const statusClass = 'status-' + i.statut;
      
      let deliveryHtml = 'Aucun';
      if (i.delivery_files && i.delivery_files.length > 0) {
        deliveryHtml = i.delivery_files.map((url, index) => 
          `<img src="${url}" class="delivery-photo" alt="Bon livraison ${index + 1}" title="Bon de livraison ${index + 1}" loading="lazy" onerror="this.style.display='none'">`
        ).join('');
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${vehicle.immatriculation} (${vehicle.modele})</td>
        <td>${formatDate(i.date)}</td>
        <td>${i.type}</td>
        <td>${i.mecaniciens.join(', ')}</td>
        <td>${deliveryHtml}</td>
        <td><span class="status-badge ${statusClass}">${i.statut}</span></td>
        <td class="action-buttons">
          <button class="btn-edit" onclick="editIntervention('${i.id}')">Modifier</button>
          <button class="btn-delete" onclick="deleteIntervention('${i.id}')">Supprimer</button>
        </td>
      `;
      container.appendChild(tr);
    });
  }

  function updateVehicleSelect(){
    const select = document.getElementById('vehicule-intervention');
    const editSelect = document.getElementById('edit-vehicule-intervention');
    
    select.innerHTML = '<option value="">Sélectionner un véhicule</option>';
    if(editSelect) editSelect.innerHTML = '<option value="">Sélectionner un véhicule</option>';
    
    vehicles.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v.id;
      opt.textContent = v.immatriculation + ' - ' + v.modele;
      select.appendChild(opt);
      
      if(editSelect) {
        const editOpt = document.createElement('option');
        editOpt.value = v.id;
        editOpt.textContent = v.immatriculation + ' - ' + v.modele;
        editSelect.appendChild(editOpt);
      }
    });
  }

  // Edit & delete vehicle
  async function editVehicle(id){
    const v = vehicles.find(x=>x.id===id);
    if(!v) return;
    
    document.getElementById('immatriculation').value = v.immatriculation;
    document.getElementById('modele').value = v.modele;
    document.getElementById('couleur').value = v.couleur;
    document.getElementById('proprietaire').value = v.proprietaire || '';
    document.getElementById('telephone').value = v.telephone || '';
    
    const preview = document.getElementById('photo-preview');
    preview.src = v.photo;
    preview.style.display = 'block';
    
    document.getElementById('vehicle-form').dataset.editingId = id;
    document.querySelector('#vehicle-form .btn-text').textContent = 'Modifier le véhicule';
    document.getElementById('cancel-edit-vehicle').style.display = 'inline-block';
    
    showNotification("Modifiez le véhicule puis cliquez sur Modifier");
  }

  async function deleteVehicle(id, showNote = true){
    if(!confirm("Êtes-vous sûr de vouloir supprimer ce véhicule? Toutes les interventions associées seront également supprimées.")) return;
    
    const result = await safeSupabaseOperation(
      supabase
        .from('vehicles')
        .delete()
        .eq('id', id),
      showNote ? "Véhicule supprimé avec succès" : null
    );
    
    if (result !== null) {
      vehicles = vehicles.filter(v=>v.id!==id);
      interventions = interventions.filter(i=>i.vehicule_id!==id);

      const stockIndex = garageStock.indexOf(id);
      if (stockIndex > -1) {
        garageStock.splice(stockIndex, 1);
        saveGarageStock();
      }

      updateUI();
    }
  }

  async function deleteIntervention(id){
    if(!confirm("Êtes-vous sûr de vouloir supprimer cette intervention?")) return;
    
    const intervention = interventions.find(i => i.id === id);
    
    const result = await safeSupabaseOperation(
      supabase
        .from('interventions')
        .delete()
        .eq('id', id),
      "Intervention supprimée avec succès"
    );
    
    if (result !== null) {
      interventions = interventions.filter(i=>i.id!==id);
      
      if (intervention && intervention.statut === 'termine') {
        const stockIndex = garageStock.indexOf(intervention.vehicule_id);
        if (stockIndex > -1) {
          garageStock.splice(stockIndex, 1);
          saveGarageStock();
        }
      }
      
      updateUI();
      updateGarageStock();
    }
  }

  // notifications
  function showNotification(message, type="success"){
    const note = document.getElementById('notification');
    note.textContent = message;
    note.className = 'notification ' + (type === 'error' ? 'error' : (type === 'warning' ? 'warning' : '')) + ' show';
    setTimeout(()=>{ note.classList.remove('show'); }, 5000);
  }

  function formatDate(dateString){
    const d = new Date(dateString);
    return d.toLocaleDateString('fr-FR');
  }

  // expose some functions for inline onclick
  window.editVehicle = editVehicle;
  window.deleteVehicle = deleteVehicle;
  window.editIntervention = editIntervention;
  window.deleteIntervention = deleteIntervention;
  window.removeDeliveryFile = removeDeliveryFile;
  window.removeEditDeliveryFile = removeEditDeliveryFile;
  window.removeExistingDeliveryFile = removeExistingDeliveryFile;
  window.showVehicleDetails = showVehicleDetails;
  window.closeModal = closeModal;
</script>
</body>
</html>
